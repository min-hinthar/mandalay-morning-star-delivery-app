---
phase: 02-overlay-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/ui-v8/Modal.tsx
  - src/components/ui-v8/BottomSheet.tsx
  - src/components/ui-v8/index.ts
autonomous: true

must_haves:
  truths:
    - "Modal opens centered on desktop with scale+fade animation"
    - "Modal opens as bottom sheet on mobile with slide-up animation"
    - "Modal closes on Escape key, backdrop click, and close button"
    - "Modal closes automatically when route changes"
    - "Modal does not block clicks when closed (AnimatePresence removes from DOM)"
    - "BottomSheet has swipe-to-dismiss gesture with spring physics"
    - "BottomSheet shows drag handle indicator"
  artifacts:
    - path: "src/components/ui-v8/Modal.tsx"
      provides: "Accessible modal dialog with responsive behavior"
      exports: ["Modal"]
      min_lines: 100
    - path: "src/components/ui-v8/BottomSheet.tsx"
      provides: "Mobile-optimized sheet with swipe gesture"
      exports: ["BottomSheet"]
      min_lines: 80
  key_links:
    - from: "src/components/ui-v8/Modal.tsx"
      to: "src/lib/hooks/useRouteChangeClose.ts"
      via: "import and call"
      pattern: "useRouteChangeClose\\(isOpen"
    - from: "src/components/ui-v8/BottomSheet.tsx"
      to: "src/lib/swipe-gestures.ts"
      via: "useSwipeToClose import"
      pattern: "useSwipeToClose.*swipe-gestures"
    - from: "src/components/ui-v8/Modal.tsx"
      to: "src/components/ui-v8/overlay/Portal.tsx"
      via: "Portal component usage"
      pattern: "<Portal>"
---

<objective>
Create Modal and BottomSheet components that use the infrastructure from Plan 01.

Purpose: Fulfills OVER-01 (Modal), OVER-02 (BottomSheet), OVER-07 (route change), OVER-08 (spring physics), OVER-09 (backdrop blur).
Output: Modal.tsx (responsive desktop/mobile), BottomSheet.tsx (mobile sheet with swipe)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-overlay-infrastructure/02-RESEARCH.md
@src/components/ui/Modal.tsx (reference implementation - 734 lines, use as pattern source)
@src/lib/swipe-gestures.ts (useSwipeToClose hook)
@src/design-system/tokens/z-index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Modal component</name>
  <files>
    - src/components/ui-v8/Modal.tsx
  </files>
  <action>
Create Modal.tsx following patterns from existing src/components/ui/Modal.tsx but simplified:

"use client" directive

Props interface (ModalProps):
- isOpen: boolean
- onClose: () => void
- title: string (for aria-label, visually can be hidden)
- children: ReactNode
- showCloseButton?: boolean (default true)
- closeOnBackdropClick?: boolean (default true)
- closeOnEscape?: boolean (default true)
- size?: "sm" | "md" | "lg" | "xl" (default "md")
- className?: string

Implementation:
1. Import Portal from ./overlay, useRouteChangeClose, useBodyScrollLock from @/lib/hooks
2. Import zIndex from @/design-system/tokens/z-index
3. Import overlayMotion from @/design-system/tokens/motion
4. Import useMediaQuery from @/lib/hooks/useMediaQuery for responsive behavior
5. Import motion, AnimatePresence from framer-motion
6. Import X from lucide-react for close button

Core behavior:
- Use useRouteChangeClose(isOpen, onClose) - closes on route change
- Use useBodyScrollLock(isOpen) - locks scroll when open
- Use useMediaQuery("(max-width: 640px)") to detect mobile
- Focus trap: useRef for modal container, useEffect to focus first focusable on open
- Escape key: useEffect adds keydown listener when open, calls onClose on Escape
- Store previously focused element, restore on close

Rendering (wrap everything in AnimatePresence):
- Only render when isOpen (AnimatePresence handles exit animation)
- Portal wrapper
- Backdrop: motion.div with fixed inset-0, z-modalBackdrop, bg-black/50 backdrop-blur-sm
  - onClick={closeOnBackdropClick ? onClose : undefined}
  - Animate opacity 0->1->0
- Content wrapper: fixed inset-0, flex items-center justify-center (desktop) or items-end (mobile)
- Content: motion.div with role="dialog", aria-modal="true", aria-label={title}
  - Desktop: scale 0.95->1->0.95, opacity animate, rounded-lg, bg-white dark:bg-zinc-900
  - Mobile: y 100%->0->100%, rounded-t-2xl, full width
  - Use overlayMotion.modalOpen for open, overlayMotion.modalClose for exit
  - Apply size classes (max-w-sm, max-w-md, etc.)
  - Close button in top-right if showCloseButton
  - onClick={e => e.stopPropagation()} to prevent backdrop close when clicking content

Size config object:
- sm: "max-w-sm"
- md: "max-w-md"
- lg: "max-w-lg"
- xl: "max-w-xl"

Export Modal component.
  </action>
  <verify>
`pnpm typecheck` passes. Modal.tsx exports Modal component with all documented props.
  </verify>
  <done>
Modal opens centered (desktop) or as bottom sheet (mobile), closes on escape/backdrop/button/route, uses spring animations, does not block clicks when closed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BottomSheet component</name>
  <files>
    - src/components/ui-v8/BottomSheet.tsx
  </files>
  <action>
Create BottomSheet.tsx for dedicated mobile bottom sheet with swipe-to-dismiss:

"use client" directive

Props interface (BottomSheetProps):
- isOpen: boolean
- onClose: () => void
- children: ReactNode
- height?: "auto" | "full" (default "auto", full = 90vh)
- showDragHandle?: boolean (default true)
- className?: string

Implementation:
1. Import Portal from ./overlay, useRouteChangeClose, useBodyScrollLock from @/lib/hooks
2. Import useSwipeToClose, triggerHaptic from @/lib/swipe-gestures
3. Import zIndex from @/design-system/tokens/z-index
4. Import overlayMotion from @/design-system/tokens/motion
5. Import motion, AnimatePresence from framer-motion
6. Import cn from @/lib/utils/cn

Core behavior:
- useRouteChangeClose(isOpen, onClose)
- useBodyScrollLock(isOpen)
- useSwipeToClose with direction="down", threshold=150 (higher for sheets)
  - onClose triggers haptic("light") then onClose prop
  - Get motionProps, isDragging, dragOffset, backdropOpacity from hook

Rendering (wrap in AnimatePresence):
- Only render when isOpen
- Portal wrapper
- Backdrop: motion.div
  - fixed inset-0, z-modalBackdrop, bg-black/50 backdrop-blur-sm
  - opacity controlled by backdropOpacity when dragging, otherwise animate 0->1
  - onClick={onClose}
  - Animate with overlayMotion.backdrop
- Sheet: motion.div
  - fixed inset-x-0 bottom-0, z-modal
  - bg-white dark:bg-zinc-900, rounded-t-3xl, shadow-xl
  - height={height === "full" ? "90vh" : "auto"}
  - y controlled by dragOffset when dragging, otherwise animate 100%->0
  - Spread swipeProps (motionProps from useSwipeToClose)
  - onClick={e => e.stopPropagation()}
  - Animate with overlayMotion.sheetOpen
- Drag handle: div inside sheet, centered, w-12 h-1.5 rounded-full bg-zinc-300 dark:bg-zinc-600
  - Scale/color change when isDragging
- Content area: overflow-y-auto max-h-[calc(90vh-3rem)] pb-safe

Export BottomSheet component.
  </action>
  <verify>
`pnpm typecheck` passes. BottomSheet.tsx exports BottomSheet component.
  </verify>
  <done>
BottomSheet slides up from bottom with swipe-to-dismiss gesture, spring physics, drag handle, route-aware cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ui-v8 barrel export</name>
  <files>
    - src/components/ui-v8/index.ts
  </files>
  <action>
Create barrel export file for ui-v8 components:

```typescript
// Overlay primitives
export { Portal, Backdrop } from "./overlay";

// Overlay components
export { Modal } from "./Modal";
export type { ModalProps } from "./Modal";
export { BottomSheet } from "./BottomSheet";
export type { BottomSheetProps } from "./BottomSheet";
```

This enables clean imports: `import { Modal, BottomSheet } from "@/components/ui-v8"`
  </action>
  <verify>
`pnpm typecheck` passes. Exports are importable from @/components/ui-v8.
  </verify>
  <done>
Clean barrel exports enable importing Modal, BottomSheet, Portal, Backdrop from @/components/ui-v8.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - All files type-check
2. `pnpm lint` - No linting errors
3. `pnpm build` - Build succeeds
4. Files exist:
   - src/components/ui-v8/Modal.tsx
   - src/components/ui-v8/BottomSheet.tsx
   - src/components/ui-v8/index.ts
5. Components use:
   - Portal for DOM mounting
   - useRouteChangeClose for route cleanup
   - useBodyScrollLock for scroll prevention
   - overlayMotion tokens for animations
   - zIndex tokens for layering
</verification>

<success_criteria>
- Modal renders via Portal, uses AnimatePresence for clean DOM removal
- Modal is responsive (centered dialog desktop, bottom sheet mobile)
- Modal closes on Escape, backdrop click, close button, route change
- Modal uses spring animation on open, ease-out on close
- BottomSheet has working swipe-to-dismiss with haptic feedback
- BottomSheet shows drag handle that indicates drag state
- Both components use z-index tokens (no hardcoded values)
- Both components do not block clicks when closed
</success_criteria>

<output>
After completion, create `.planning/phases/02-overlay-infrastructure/02-02-SUMMARY.md`
</output>
