---
phase: 02-overlay-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui-v8/overlay/Portal.tsx
  - src/components/ui-v8/overlay/Backdrop.tsx
  - src/components/ui-v8/overlay/index.ts
  - src/lib/hooks/useRouteChangeClose.ts
  - src/lib/hooks/useBodyScrollLock.ts
  - src/design-system/tokens/motion.ts
  - src/design-system/tokens/colors.ts
autonomous: true

must_haves:
  truths:
    - "Portal renders children into document.body via createPortal"
    - "useRouteChangeClose calls onClose when pathname changes while overlay is open"
    - "useBodyScrollLock prevents background scroll when active and restores position on cleanup"
    - "Motion tokens provide spring configs for modal, sheet, drawer, dropdown, tooltip, toast"
    - "Color tokens provide backdrop colors with light/dark mode variants"
  artifacts:
    - path: "src/components/ui-v8/overlay/Portal.tsx"
      provides: "SSR-safe portal component"
      exports: ["Portal"]
    - path: "src/lib/hooks/useRouteChangeClose.ts"
      provides: "Route-aware overlay cleanup hook"
      exports: ["useRouteChangeClose"]
    - path: "src/lib/hooks/useBodyScrollLock.ts"
      provides: "Body scroll lock hook with position preservation"
      exports: ["useBodyScrollLock"]
    - path: "src/design-system/tokens/motion.ts"
      provides: "Overlay animation tokens"
      exports: ["overlayMotion", "overlayCSSVars"]
    - path: "src/design-system/tokens/colors.ts"
      provides: "Color tokens with dark mode support"
      exports: ["colors", "colorVar"]
  key_links:
    - from: "src/lib/hooks/useRouteChangeClose.ts"
      to: "next/navigation"
      via: "usePathname import"
      pattern: "usePathname.*next/navigation"
    - from: "src/components/ui-v8/overlay/Portal.tsx"
      to: "react-dom"
      via: "createPortal import"
      pattern: "createPortal.*react-dom"
---

<objective>
Create overlay infrastructure primitives: Portal component, route-change hook, scroll lock hook, motion tokens, and color tokens.

Purpose: Foundation for all overlay components (modal, sheet, drawer, dropdown, tooltip, toast). These primitives ensure overlays never block clicks when closed, close on route change, and use consistent animations.
Output: Portal.tsx, Backdrop.tsx, useRouteChangeClose.ts, useBodyScrollLock.ts, motion.ts, colors.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-overlay-infrastructure/02-RESEARCH.md
@src/design-system/tokens/z-index.ts
@src/components/ui/Modal.tsx (reference for patterns)
@src/lib/swipe-gestures.ts (reference for existing hooks)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create motion and color token files</name>
  <files>
    - src/design-system/tokens/motion.ts
    - src/design-system/tokens/colors.ts
  </files>
  <action>
Create motion.ts with overlayMotion object containing spring configs:
- modalOpen: { type: "spring", damping: 25, stiffness: 300 }
- modalClose: { duration: 0.2, ease: "easeIn" }
- sheetOpen: { type: "spring", damping: 30, stiffness: 300 }
- drawerOpen: { type: "spring", damping: 25, stiffness: 300 }
- backdrop: { duration: 0.2, ease: "easeOut" }
- dropdown: { type: "spring", damping: 20, stiffness: 400 }
- tooltip: { duration: 0.15, ease: "easeOut" }
- toast: { type: "spring", damping: 20, stiffness: 300 }

Add overlayCSSVars object with backdrop blur/color values:
- backdropBlur: "var(--blur-md, 8px)"
- backdropColor: "rgba(26, 26, 26, 0.5)"
- backdropColorDark: "rgba(0, 0, 0, 0.6)"

Create colors.ts with color tokens using CSS variable pattern like z-index.ts:
- colors object: semantic color names mapped to literal values (for reference)
- colorVar object: same keys mapped to CSS var references
- Include backdrop, surface, border colors with light/dark awareness
- Use existing Tailwind color conventions (bg-white, bg-zinc-900 for dark)

Follow triple-export pattern established in z-index.ts. Use "as const" for literal type inference.
  </action>
  <verify>
`pnpm typecheck` passes. Files export overlayMotion, overlayCSSVars from motion.ts and colors, colorVar from colors.ts.
  </verify>
  <done>
Motion tokens define spring physics for all overlay types. Color tokens provide semantic backdrop/surface colors with dark mode variants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Portal and Backdrop components</name>
  <files>
    - src/components/ui-v8/overlay/Portal.tsx
    - src/components/ui-v8/overlay/Backdrop.tsx
    - src/components/ui-v8/overlay/index.ts
  </files>
  <action>
Create src/components/ui-v8/overlay/ directory structure.

Portal.tsx:
- "use client" directive
- Props: children, container (optional Element)
- Use useState(false) for mounted state (SSR safety)
- useEffect sets mounted=true on mount, false on cleanup
- Return null if not mounted
- Return createPortal(children, container ?? document.body)
- Export Portal component

Backdrop.tsx:
- "use client" directive
- Props: isVisible, onClick, className
- Use motion.div from framer-motion
- AnimatePresence wrapping the backdrop
- Only render when isVisible (removes from DOM when closed - CRITICAL for click blocking fix)
- Fixed positioning, inset-0, z-index from zIndex.modalBackdrop
- bg-black/50, backdrop-blur-sm
- Animate opacity only (not blur - blur is constant, animate opacity for performance)
- Use overlayMotion.backdrop transition
- onClick handler for dismiss

index.ts:
- Barrel export: Portal, Backdrop
  </action>
  <verify>
`pnpm typecheck` passes. Directory src/components/ui-v8/overlay/ exists with Portal.tsx, Backdrop.tsx, index.ts.
  </verify>
  <done>
Portal provides SSR-safe createPortal wrapper. Backdrop provides animated, dismissible backdrop that removes from DOM when closed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create route-change and body scroll lock hooks</name>
  <files>
    - src/lib/hooks/useRouteChangeClose.ts
    - src/lib/hooks/useBodyScrollLock.ts
    - src/lib/hooks/index.ts (update barrel export)
  </files>
  <action>
useRouteChangeClose.ts:
- "use client" directive
- Import usePathname from next/navigation, useEffect/useRef from react
- Props: isOpen (boolean), onClose (callback)
- Store pathname when overlay opens in ref (openedPathnameRef)
- When isOpen becomes true, store current pathname
- When pathname changes while isOpen is true and differs from stored, call onClose
- Reset ref when overlay closes
- Pattern from research: track pathname at open time, close if it changes

useBodyScrollLock.ts:
- "use client" directive
- Props: isLocked (boolean)
- When isLocked becomes true:
  - Store current scrollY
  - Set document.body.style.position = "fixed"
  - Set document.body.style.top = `-${scrollY}px`
  - Set document.body.style.left = "0"
  - Set document.body.style.right = "0"
  - Set document.body.style.overflow = "hidden"
- When isLocked becomes false or on cleanup:
  - Read stored scrollY from body.style.top
  - Reset all body styles to ""
  - Restore scroll position with window.scrollTo(0, scrollY)
- Follow pattern from existing Modal.tsx and swipe-gestures.ts (preventScrollDuringSwipe)

Update src/lib/hooks/index.ts to export both new hooks.
  </action>
  <verify>
`pnpm typecheck` passes. `pnpm lint` passes. Hooks are importable from @/lib/hooks.
  </verify>
  <done>
useRouteChangeClose closes overlays on navigation. useBodyScrollLock prevents background scroll with scroll position preservation.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - All files type-check
2. `pnpm lint` - No linting errors
3. `pnpm build` - Build succeeds
4. Files exist:
   - src/design-system/tokens/motion.ts
   - src/design-system/tokens/colors.ts
   - src/components/ui-v8/overlay/Portal.tsx
   - src/components/ui-v8/overlay/Backdrop.tsx
   - src/components/ui-v8/overlay/index.ts
   - src/lib/hooks/useRouteChangeClose.ts
   - src/lib/hooks/useBodyScrollLock.ts
</verification>

<success_criteria>
- Motion tokens export overlayMotion with 8 animation configs
- Color tokens export backdrop/surface colors with dark mode
- Portal component handles SSR and renders to body
- Backdrop component uses AnimatePresence for proper DOM removal
- useRouteChangeClose detects pathname changes and triggers close
- useBodyScrollLock preserves scroll position on lock/unlock
- All exports are barrel-exported from their respective index files
</success_criteria>

<output>
After completion, create `.planning/phases/02-overlay-infrastructure/02-01-SUMMARY.md`
</output>
