---
phase: 02-overlay-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/ui-v8/Drawer.tsx
  - src/components/ui-v8/Dropdown.tsx
  - src/components/ui-v8/index.ts
autonomous: true

must_haves:
  truths:
    - "Drawer slides in from left or right edge with spring animation"
    - "Drawer has focus trap keeping Tab within drawer"
    - "Drawer closes on Escape, backdrop click, route change"
    - "Dropdown opens below trigger with scale+fade animation"
    - "Dropdown does not swallow form submission events"
    - "Dropdown closes on outside click and Escape"
    - "Both components do not block clicks when closed"
  artifacts:
    - path: "src/components/ui-v8/Drawer.tsx"
      provides: "Side drawer component with focus management"
      exports: ["Drawer"]
      min_lines: 80
    - path: "src/components/ui-v8/Dropdown.tsx"
      provides: "Dropdown menu without event swallowing"
      exports: ["Dropdown", "DropdownTrigger", "DropdownContent", "DropdownItem"]
      min_lines: 60
  key_links:
    - from: "src/components/ui-v8/Drawer.tsx"
      to: "src/lib/hooks/useRouteChangeClose.ts"
      via: "import and call"
      pattern: "useRouteChangeClose\\(isOpen"
    - from: "src/components/ui-v8/Dropdown.tsx"
      to: "src/design-system/tokens/z-index.ts"
      via: "zIndex.popover usage"
      pattern: "zIndex\\.popover|z-popover"
---

<objective>
Create Drawer and Dropdown components that use the infrastructure from Plan 01.

Purpose: Fulfills OVER-03 (Side drawer), OVER-04 (Dropdown), OVER-07 (route change), OVER-08 (spring physics).
Output: Drawer.tsx (side panel with focus trap), Dropdown.tsx (positioned menu without event issues)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-overlay-infrastructure/02-RESEARCH.md
@src/components/ui/drawer.tsx (Vaul-based reference)
@src/components/ui/dropdown-menu.tsx (existing dropdown - has event issues we're fixing)
@src/design-system/tokens/z-index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Drawer component</name>
  <files>
    - src/components/ui-v8/Drawer.tsx
  </files>
  <action>
Create Drawer.tsx for animated side drawer with focus management:

"use client" directive

Props interface (DrawerProps):
- isOpen: boolean
- onClose: () => void
- children: ReactNode
- side?: "left" | "right" (default "right")
- width?: "sm" | "md" | "lg" (default "md")
- title?: string (for aria-label)
- className?: string

Width config:
- sm: "w-64" (256px)
- md: "w-80" (320px)
- lg: "w-96" (384px)

Implementation:
1. Import Portal, Backdrop from ./overlay
2. Import useRouteChangeClose, useBodyScrollLock from @/lib/hooks
3. Import zIndex from @/design-system/tokens/z-index
4. Import overlayMotion from @/design-system/tokens/motion
5. Import motion, AnimatePresence from framer-motion
6. Import cn from @/lib/utils/cn

Core behavior:
- useRouteChangeClose(isOpen, onClose)
- useBodyScrollLock(isOpen)
- Focus trap:
  - useRef for drawer container
  - Store lastActiveElement on open, restore on close
  - Focus first focusable element on open (setTimeout 50ms for animation)
  - onKeyDown handler: trap Tab key within drawer
    - Get all focusables: 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    - If Shift+Tab on first, focus last; if Tab on last, focus first
- Escape key: useEffect listener when open

Rendering (wrap in AnimatePresence):
- Only render when isOpen
- Portal wrapper
- Backdrop component: isVisible={isOpen}, onClick={onClose}
- Drawer: motion.div
  - ref for focus trap
  - role="dialog", aria-modal="true", aria-label={title}
  - fixed inset-y-0, left-0 or right-0 based on side
  - z-modal, bg-white dark:bg-zinc-900, shadow-xl
  - Apply width class
  - onKeyDown for focus trap
  - onClick={e => e.stopPropagation()}
  - Animation:
    - initial: { x: side === "left" ? "-100%" : "100%" }
    - animate: { x: 0 }
    - exit: same as initial
    - transition: overlayMotion.drawerOpen

Export Drawer component and DrawerProps type.
  </action>
  <verify>
`pnpm typecheck` passes. Drawer.tsx exports Drawer with focus trap, side configuration, spring animation.
  </verify>
  <done>
Drawer slides from configured side with spring animation, traps focus, closes on escape/backdrop/route.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Dropdown component</name>
  <files>
    - src/components/ui-v8/Dropdown.tsx
  </files>
  <action>
Create Dropdown.tsx that does NOT swallow events (fixing the V7 issue):

"use client" directive

Components to create:
1. DropdownContext (internal)
2. Dropdown (root provider)
3. DropdownTrigger
4. DropdownContent
5. DropdownItem
6. DropdownSeparator

Props:
- Dropdown: children, defaultOpen?, onOpenChange?
- DropdownTrigger: children, asChild?
- DropdownContent: children, align? ("start" | "end" | "center", default "end"), className?
- DropdownItem: children, onClick?, asChild?, className?
- DropdownSeparator: className?

Implementation:
1. Import zIndex, zClass from @/design-system/tokens/z-index
2. Import overlayMotion from @/design-system/tokens/motion
3. Import motion, AnimatePresence from framer-motion
4. Import cn from @/lib/utils/cn

Context:
- DropdownContext with { isOpen, setIsOpen, triggerRef }
- useDropdown hook to access context

Dropdown (root):
- Manage open state (controlled via onOpenChange or internal)
- Provide context
- Render relative container div

DropdownTrigger:
- Get context
- If asChild, clone child with onClick handler
- Otherwise wrap in button
- onClick toggles isOpen
- Store ref for positioning

DropdownContent:
- Get context
- Only render content when isOpen (AnimatePresence)
- motion.div with:
  - absolute positioning below trigger
  - z-popover (from zIndex.popover)
  - Align based on align prop (right-0, left-0, or centered)
  - bg-white dark:bg-zinc-900, rounded-md, shadow-lg, border
  - Animation: scale 0.95->1, opacity 0->1, origin from top
  - transition: overlayMotion.dropdown
- Click outside detection:
  - useEffect with document mousedown listener
  - Check if click is outside dropdown and trigger
  - Close if outside
- Escape key listener to close
- CRITICAL: Do NOT add onClick stopPropagation on content itself
  - Only DropdownItem should handle its own clicks

DropdownItem:
- onClick: call provided handler, then close dropdown
- Do NOT call e.stopPropagation() unless asChild and navigating
- Allow form submissions to bubble up
- Styling: hover:bg-muted, cursor-pointer, px-2 py-1.5, rounded-sm

DropdownSeparator:
- Simple hr styling: h-px bg-muted -mx-1 my-1

Export all components.
  </action>
  <verify>
`pnpm typecheck` passes. Dropdown components export correctly. No stopPropagation on content/root.
  </verify>
  <done>
Dropdown opens with spring animation, positions correctly, closes on outside click/escape. Does NOT swallow form events.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ui-v8 barrel export</name>
  <files>
    - src/components/ui-v8/index.ts
  </files>
  <action>
Update barrel export to include Drawer and Dropdown:

```typescript
// Overlay primitives
export { Portal, Backdrop } from "./overlay";

// Overlay components
export { Modal } from "./Modal";
export type { ModalProps } from "./Modal";
export { BottomSheet } from "./BottomSheet";
export type { BottomSheetProps } from "./BottomSheet";
export { Drawer } from "./Drawer";
export type { DrawerProps } from "./Drawer";
export {
  Dropdown,
  DropdownTrigger,
  DropdownContent,
  DropdownItem,
  DropdownSeparator,
} from "./Dropdown";
```
  </action>
  <verify>
`pnpm typecheck` passes. All exports are importable from @/components/ui-v8.
  </verify>
  <done>
Drawer and Dropdown components are barrel exported from ui-v8.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - All files type-check
2. `pnpm lint` - No linting errors
3. `pnpm build` - Build succeeds
4. Files exist:
   - src/components/ui-v8/Drawer.tsx
   - src/components/ui-v8/Dropdown.tsx
5. Drawer:
   - Has working focus trap (Tab cycles within drawer)
   - Uses spring animation
   - Supports left/right sides
6. Dropdown:
   - No stopPropagation on root/content
   - Closes on outside click and Escape
   - Uses z-popover for proper layering
</verification>

<success_criteria>
- Drawer slides from left or right with spring animation
- Drawer has proper focus trap (Tab key cycles within)
- Drawer closes on Escape, backdrop, route change
- Dropdown opens below trigger with scale+fade animation
- Dropdown does NOT block form submissions or parent click handlers
- Dropdown closes on outside click and Escape
- Both components use z-index tokens
- Both removed from DOM when closed (no click blocking)
</success_criteria>

<output>
After completion, create `.planning/phases/02-overlay-infrastructure/02-03-SUMMARY.md`
</output>
