---
phase: 06-checkout-flow
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/checkout/CheckoutSummaryV8.tsx
  - src/components/checkout/PaymentStepV8.tsx
  - src/components/checkout/index.ts
  - src/app/(customer)/checkout/page.tsx
autonomous: true

must_haves:
  truths:
    - "Checkout summary shows animated progress bar toward free delivery threshold"
    - "Progress bar uses spring.rubbery animation for satisfying fill"
    - "Free delivery achieved state shows celebration animation"
    - "Payment step shows loading spinner during checkout session creation"
  artifacts:
    - path: "src/components/checkout/CheckoutSummaryV8.tsx"
      provides: "Order summary with animated free delivery progress"
      exports: ["CheckoutSummaryV8"]
      contains: "spring.rubbery"
    - path: "src/components/checkout/PaymentStepV8.tsx"
      provides: "Payment review step with loading state"
      exports: ["PaymentStepV8"]
  key_links:
    - from: "src/components/checkout/CheckoutSummaryV8.tsx"
      to: "useCart"
      via: "amountToFreeDelivery calculation"
      pattern: "amountToFreeDelivery"
---

# Plan 06-04: Checkout Summary and Payment Step V8

## Objective

Create an enhanced checkout summary with animated free delivery progress indicator and payment step with loading states for the Stripe checkout session creation.

## Requirements Addressed

- CHKT-03: Stripe payment integration (existing, with new UI)
- CHKT-05: Loading states throughout checkout
- CHKT-09: Animated "$ more for free delivery" in checkout summary

## Context

@.planning/phases/06-checkout-flow/06-RESEARCH.md
@src/components/checkout/CheckoutSummary.tsx
@src/components/checkout/PaymentStep.tsx
@src/components/ui-v8/cart/CartSummary.tsx (free delivery pattern to reuse)
@src/lib/motion-tokens.ts

## Tasks

<task id="1" type="auto">
  <name>Create CheckoutSummaryV8 with animated free delivery progress</name>
  <files>src/components/checkout/CheckoutSummaryV8.tsx</files>
  <action>
Create CheckoutSummaryV8 based on existing CheckoutSummary, adding the animated free delivery progress pattern from CartSummary:

```typescript
"use client";

import { motion } from "framer-motion";
import { ShoppingBag, Truck, Sparkles } from "lucide-react";
import { cn } from "@/lib/utils/cn";
import { spring, staggerItem } from "@/lib/motion-tokens";
import { useAnimationPreference } from "@/lib/hooks/useAnimationPreference";
import { useCart } from "@/lib/hooks/useCart";
import { PriceTicker } from "@/components/ui/PriceTicker";
import { formatPrice } from "@/lib/utils/format";
import { FREE_DELIVERY_THRESHOLD_CENTS } from "@/types/cart";
```

Key features:

1. Animated free delivery progress bar (copy pattern from CartSummary):
```tsx
{!hasFreeDelivery && (
  <motion.div
    initial={{ opacity: 0, y: 10 }}
    animate={{ opacity: 1, y: 0 }}
    transition={getSpring(spring.gentle)}
    className="p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200/50"
  >
    <div className="flex items-center gap-2 mb-2">
      <motion.div
        animate={shouldAnimate ? {
          rotate: [0, 15, -15, 0],
          scale: [1, 1.1, 1.1, 1],
        } : undefined}
        transition={{ duration: 0.6, repeat: Infinity, repeatDelay: 2 }}
      >
        <Sparkles className="w-4 h-4 text-amber-500" />
      </motion.div>
      <span className="text-sm font-medium">
        {formatPrice(amountToFreeDelivery)} more for free delivery!
      </span>
    </div>

    <div className="h-2 bg-surface-tertiary rounded-full overflow-hidden">
      <motion.div
        className="h-full rounded-full bg-gradient-to-r from-amber-400 to-amber-500"
        initial={{ width: 0 }}
        animate={{ width: `${progressPercent}%` }}
        transition={getSpring(spring.rubbery)}
      />
    </div>
  </motion.div>
)}
```

2. Free delivery achieved celebration:
```tsx
{hasFreeDelivery && (
  <motion.div
    initial={{ opacity: 0, scale: 0.9 }}
    animate={{ opacity: 1, scale: 1 }}
    transition={getSpring(spring.ultraBouncy)}
    className="p-3 rounded-lg bg-green-50 dark:bg-green-950/30 border border-green-200/50"
  >
    <div className="flex items-center gap-2">
      <motion.div
        animate={{ scale: [1, 1.2, 1] }}
        transition={{ duration: 0.5, repeat: Infinity, repeatDelay: 3 }}
      >
        <Sparkles className="w-4 h-4 text-green-500" />
      </motion.div>
      <span className="text-sm font-medium text-green-700">
        You qualify for free delivery!
      </span>
    </div>
  </motion.div>
)}
```

3. Animated item list with stagger
4. PriceTicker for subtotal, delivery fee, total
5. Keep sticky positioning for desktop sidebar

Calculate progress: progressPercent = ((threshold - amountToFreeDelivery) / threshold) * 100
  </action>
  <verify>
pnpm typecheck passes.
Progress bar animates with spring.rubbery.
Free delivery threshold displays correctly.
  </verify>
  <done>CheckoutSummaryV8 exists with animated free delivery progress bar.</done>
</task>

<task id="2" type="auto">
  <name>Create PaymentStepV8 with loading states</name>
  <files>src/components/checkout/PaymentStepV8.tsx</files>
  <action>
Create PaymentStepV8 based on existing PaymentStep with enhanced loading states:

1. Import animation utilities:
```typescript
import { motion, AnimatePresence } from "framer-motion";
import { spring, variants } from "@/lib/motion-tokens";
import { useAnimationPreference } from "@/lib/hooks/useAnimationPreference";
import { Loader2, CreditCard, ShieldCheck, Lock } from "lucide-react";
```

2. Add animated loading state for checkout session creation:
```tsx
{isCreatingSession && (
  <motion.div
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    className="flex flex-col items-center justify-center py-12 space-y-4"
  >
    <motion.div
      animate={{ rotate: 360 }}
      transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
    >
      <Loader2 className="w-10 h-10 text-primary" />
    </motion.div>
    <p className="text-sm text-muted-foreground">
      Preparing secure checkout...
    </p>
    <div className="flex items-center gap-2 text-xs text-muted-foreground">
      <Lock className="w-3 h-3" />
      <span>Secured by Stripe</span>
    </div>
  </motion.div>
)}
```

3. Enhanced review section with animations:
```tsx
<motion.div
  variants={variants.slideUp}
  initial="initial"
  animate="animate"
  className="space-y-4"
>
  {/* Order review content */}
  <div className="p-4 rounded-lg bg-muted/50 space-y-3">
    <div className="flex items-center gap-2 text-sm font-medium">
      <ShieldCheck className="w-4 h-4 text-green-500" />
      Secure Payment
    </div>
    <p className="text-sm text-muted-foreground">
      You'll be redirected to Stripe's secure checkout page to complete your payment.
    </p>
  </div>
</motion.div>
```

4. Animated "Place Order" button with loading state:
```tsx
<motion.button
  whileHover={shouldAnimate && !isProcessing ? { scale: 1.02 } : undefined}
  whileTap={shouldAnimate && !isProcessing ? { scale: 0.98 } : undefined}
  disabled={isProcessing}
  className={cn(
    "w-full py-3 px-6 rounded-lg font-semibold",
    "bg-primary text-white",
    "flex items-center justify-center gap-2",
    isProcessing && "opacity-70 cursor-not-allowed"
  )}
>
  {isProcessing ? (
    <>
      <motion.div
        animate={{ rotate: 360 }}
        transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
      >
        <Loader2 className="w-5 h-5" />
      </motion.div>
      Processing...
    </>
  ) : (
    <>
      <CreditCard className="w-5 h-5" />
      Place Order
    </>
  )}
</motion.button>
```

5. Keep existing Stripe checkout session logic (POST to /api/checkout/session, redirect to Stripe)

IMPORTANT: Do NOT add @stripe/react-stripe-js or embedded payment elements.
The app uses Stripe Checkout Sessions (hosted page redirect).
  </action>
  <verify>
pnpm typecheck passes.
Payment step shows loading spinner during session creation.
Button shows processing state.
  </verify>
  <done>PaymentStepV8 exists with animated loading states for checkout.</done>
</task>

<task id="3" type="auto">
  <name>Update checkout page with V8 summary and payment</name>
  <files>
    src/components/checkout/index.ts
    src/app/(customer)/checkout/page.tsx
  </files>
  <action>
1. Update index.ts barrel exports:
```typescript
// V8 Components
export { CheckoutStepperV8 } from "./CheckoutStepperV8";
export { AnimatedFormField } from "./AnimatedFormField";
export { AddressFormV8 } from "./AddressFormV8";
export { AddressCardV8 } from "./AddressCardV8";
export { AddressStepV8 } from "./AddressStepV8";
export { CheckoutSummaryV8 } from "./CheckoutSummaryV8";
export { PaymentStepV8 } from "./PaymentStepV8";

// Re-export V8 as default names
export { CheckoutStepperV8 as CheckoutStepper } from "./CheckoutStepperV8";
export { AddressFormV8 as AddressForm } from "./AddressFormV8";
export { AddressCardV8 as AddressCard } from "./AddressCardV8";
export { AddressStepV8 as AddressStep } from "./AddressStepV8";
export { CheckoutSummaryV8 as CheckoutSummary } from "./CheckoutSummaryV8";
export { PaymentStepV8 as PaymentStep } from "./PaymentStepV8";

// Legacy
export { TimeStep } from "./TimeStep";
```

2. Update checkout page.tsx to use V8 components:
- Import CheckoutSummaryV8 (or CheckoutSummary from barrel)
- Import PaymentStepV8 (or PaymentStep from barrel)
- Replace the component usages in the render

The barrel re-exports mean importing CheckoutSummary from the barrel gets CheckoutSummaryV8.
  </action>
  <verify>
pnpm typecheck passes.
Checkout page uses V8 summary and payment components.
  </verify>
  <done>Checkout page fully uses V8 checkout summary and payment step.</done>
</task>

## Verification

- [ ] `pnpm typecheck` passes
- [ ] Checkout summary shows animated free delivery progress bar
- [ ] Progress bar fills with rubbery spring animation
- [ ] "Free delivery achieved" shows celebration animation when threshold met
- [ ] Payment step shows loading spinner during checkout session creation
- [ ] Place Order button shows processing state when clicked
- [ ] Stripe redirect works correctly (existing flow unchanged)

## Success Criteria

Checkout summary displays animated "$ more for free delivery" progress indicator using spring.rubbery animation. Payment step shows appropriate loading states during checkout session creation before Stripe redirect.

## Output

After completion, create `.planning/phases/06-checkout-flow/06-04-SUMMARY.md`
