---
phase: 06-checkout-flow
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/components/checkout/AddressStepV8.tsx
  - src/components/checkout/AddressCardV8.tsx
  - src/components/checkout/index.ts
autonomous: true

must_haves:
  truths:
    - "User can view saved addresses as selectable cards"
    - "Address cards have selection animation (scale + border)"
    - "User can add new address via modal (desktop) or bottom sheet (mobile)"
    - "Address list shows skeleton loading state while fetching"
  artifacts:
    - path: "src/components/checkout/AddressStepV8.tsx"
      provides: "Address selection step with animations"
      exports: ["AddressStepV8"]
    - path: "src/components/checkout/AddressCardV8.tsx"
      provides: "Animated address selection card"
      exports: ["AddressCardV8"]
  key_links:
    - from: "src/components/checkout/AddressStepV8.tsx"
      to: "Modal/BottomSheet"
      via: "responsive overlay for add/edit"
      pattern: "Modal|BottomSheet"
    - from: "src/components/checkout/AddressStepV8.tsx"
      to: "AddressFormV8"
      via: "form inside overlay"
      pattern: "AddressFormV8"
---

# Plan 06-03: Address Step V8

## Objective

Create an enhanced address selection step with animated address cards, responsive add/edit overlays (Modal on desktop, BottomSheet on mobile), and loading states.

## Requirements Addressed

- CHKT-02: Address selection/management
- CHKT-05: Loading states throughout checkout (address list loading)

## Context

@.planning/phases/06-checkout-flow/06-RESEARCH.md
@src/components/checkout/AddressStep.tsx
@src/components/checkout/AddressCard.tsx
@src/components/ui-v8/Modal.tsx
@src/components/ui-v8/BottomSheet.tsx
@.planning/phases/06-checkout-flow/06-02-SUMMARY.md (for AddressFormV8)

## Tasks

<task id="1" type="auto">
  <name>Create AddressCardV8 with selection animations</name>
  <files>src/components/checkout/AddressCardV8.tsx</files>
  <action>
Create AddressCardV8 with enhanced selection animations:

```typescript
"use client";

import { motion } from "framer-motion";
import { MapPin, Check, Pencil, Trash2 } from "lucide-react";
import { spring, hover } from "@/lib/motion-tokens";
import { useAnimationPreference } from "@/lib/hooks/useAnimationPreference";
import { cn } from "@/lib/utils/cn";
import type { Address } from "@/types/address";

interface AddressCardV8Props {
  address: Address;
  isSelected: boolean;
  onSelect: () => void;
  onEdit?: () => void;
  onDelete?: () => void;
}

export function AddressCardV8({
  address,
  isSelected,
  onSelect,
  onEdit,
  onDelete,
}: AddressCardV8Props) {
  const { shouldAnimate, getSpring } = useAnimationPreference();

  return (
    <motion.button
      type="button"
      onClick={onSelect}
      whileHover={shouldAnimate ? { scale: 1.02, y: -2 } : undefined}
      whileTap={shouldAnimate ? { scale: 0.98 } : undefined}
      transition={getSpring(spring.snappy)}
      className={cn(
        "relative w-full p-4 rounded-xl text-left",
        "border-2 transition-colors",
        "focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
        isSelected
          ? "border-primary bg-primary/5"
          : "border-border bg-card hover:border-primary/50"
      )}
    >
      {/* Selection indicator */}
      <motion.div
        initial={false}
        animate={shouldAnimate ? {
          scale: isSelected ? 1 : 0,
          opacity: isSelected ? 1 : 0,
        } : undefined}
        transition={getSpring(spring.ultraBouncy)}
        className="absolute top-3 right-3 w-6 h-6 rounded-full bg-primary flex items-center justify-center"
      >
        <Check className="w-4 h-4 text-white" />
      </motion.div>

      {/* Address content */}
      <div className="flex items-start gap-3 pr-8">
        <div className={cn(
          "p-2 rounded-lg",
          isSelected ? "bg-primary/10" : "bg-muted"
        )}>
          <MapPin className={cn(
            "w-5 h-5",
            isSelected ? "text-primary" : "text-muted-foreground"
          )} />
        </div>
        <div className="flex-1 min-w-0">
          <p className="font-medium text-foreground">{address.label}</p>
          <p className="text-sm text-muted-foreground truncate">{address.line1}</p>
          {address.line2 && (
            <p className="text-sm text-muted-foreground truncate">{address.line2}</p>
          )}
          <p className="text-sm text-muted-foreground">
            {address.city}, {address.state} {address.postalCode}
          </p>
        </div>
      </div>

      {/* Action buttons */}
      {(onEdit || onDelete) && (
        <div className="flex gap-2 mt-3 pt-3 border-t border-border">
          {onEdit && (
            <button
              type="button"
              onClick={(e) => { e.stopPropagation(); onEdit(); }}
              className="flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors"
            >
              <Pencil className="w-3 h-3" />
              Edit
            </button>
          )}
          {onDelete && (
            <button
              type="button"
              onClick={(e) => { e.stopPropagation(); onDelete(); }}
              className="flex items-center gap-1 text-xs text-destructive/70 hover:text-destructive transition-colors"
            >
              <Trash2 className="w-3 h-3" />
              Delete
            </button>
          )}
        </div>
      )}
    </motion.button>
  );
}
```
  </action>
  <verify>
pnpm typecheck passes.
Card component compiles without errors.
  </verify>
  <done>AddressCardV8 exists with selection scale animation and checkmark indicator.</done>
</task>

<task id="2" type="auto">
  <name>Create AddressStepV8 with responsive overlays</name>
  <files>src/components/checkout/AddressStepV8.tsx</files>
  <action>
Create AddressStepV8 based on existing AddressStep with these enhancements:

1. Import overlay components:
```typescript
import { Modal } from "@/components/ui-v8/Modal";
import { BottomSheet } from "@/components/ui-v8/BottomSheet";
import { AddressCardV8 } from "./AddressCardV8";
import { AddressFormV8 } from "./AddressFormV8";
import { staggerContainer, staggerItem } from "@/lib/motion-tokens";
```

2. Add responsive overlay hook:
```typescript
const isMobile = useMediaQuery("(max-width: 639px)");
```

3. Use staggered animation for address list:
```tsx
<motion.div
  variants={staggerContainer(0.08)}
  initial="hidden"
  animate="visible"
  className="space-y-3"
>
  {addresses.map((address) => (
    <motion.div key={address.id} variants={staggerItem}>
      <AddressCardV8
        address={address}
        isSelected={selectedAddress?.id === address.id}
        onSelect={() => selectAddress(address)}
        onEdit={() => openEditModal(address)}
        onDelete={() => deleteAddress(address.id)}
      />
    </motion.div>
  ))}
</motion.div>
```

4. Add skeleton loading state:
```tsx
{isLoading && (
  <div className="space-y-3">
    {[1, 2].map((i) => (
      <div key={i} className="animate-pulse p-4 rounded-xl border border-border">
        <div className="flex gap-3">
          <div className="w-9 h-9 bg-muted rounded-lg" />
          <div className="flex-1 space-y-2">
            <div className="h-4 bg-muted rounded w-20" />
            <div className="h-3 bg-muted rounded w-3/4" />
            <div className="h-3 bg-muted rounded w-1/2" />
          </div>
        </div>
      </div>
    ))}
  </div>
)}
```

5. Responsive overlay for add/edit:
```tsx
{isMobile ? (
  <BottomSheet
    isOpen={isFormOpen}
    onClose={() => setIsFormOpen(false)}
    title={editingAddress ? "Edit Address" : "Add Address"}
  >
    <AddressFormV8
      defaultValues={editingAddress}
      onSubmit={handleSubmit}
      onCancel={() => setIsFormOpen(false)}
      isLoading={isSaving}
      error={formError}
    />
  </BottomSheet>
) : (
  <Modal
    isOpen={isFormOpen}
    onClose={() => setIsFormOpen(false)}
    title={editingAddress ? "Edit Address" : "Add Address"}
  >
    <AddressFormV8 ... />
  </Modal>
)}
```

6. Add "Add New Address" button with icon.

7. Use existing useAddresses hook for CRUD operations.
  </action>
  <verify>
pnpm typecheck passes.
Address cards render with stagger animation.
Add button opens appropriate overlay based on viewport.
  </verify>
  <done>AddressStepV8 exists with animated cards, skeleton loading, and responsive overlays.</done>
</task>

<task id="3" type="auto">
  <name>Update checkout barrel exports with address components</name>
  <files>src/components/checkout/index.ts</files>
  <action>
Update index.ts to include address step V8 components:

```typescript
// V8 Components
export { CheckoutStepperV8 } from "./CheckoutStepperV8";
export { AnimatedFormField } from "./AnimatedFormField";
export { AddressFormV8 } from "./AddressFormV8";
export { AddressCardV8 } from "./AddressCardV8";
export { AddressStepV8 } from "./AddressStepV8";

// Re-export V8 as default names for migration
export { CheckoutStepperV8 as CheckoutStepper } from "./CheckoutStepperV8";
export { AddressFormV8 as AddressForm } from "./AddressFormV8";
export { AddressCardV8 as AddressCard } from "./AddressCardV8";
export { AddressStepV8 as AddressStep } from "./AddressStepV8";

// Legacy exports
export { TimeStep } from "./TimeStep";
export { PaymentStep } from "./PaymentStep";
export { CheckoutSummary } from "./CheckoutSummary";
```

Then update checkout page.tsx to use AddressStepV8:
Replace AddressStep import with AddressStepV8 (or import from barrel which aliases it).
  </action>
  <verify>
pnpm typecheck passes.
Checkout page uses V8 address step.
  </verify>
  <done>Barrel exports updated and checkout page uses AddressStepV8.</done>
</task>

## Verification

- [ ] `pnpm typecheck` passes
- [ ] Address cards have hover scale animation
- [ ] Selected card shows animated checkmark with bounce
- [ ] Address list shows skeleton while loading
- [ ] "Add Address" opens Modal on desktop (>=640px)
- [ ] "Add Address" opens BottomSheet on mobile (<640px)
- [ ] Form in overlay has micro-interactions from 06-02
- [ ] Cards animate in with stagger on initial load

## Success Criteria

User can select from saved addresses with satisfying selection animation. New addresses can be added via a responsive overlay (Modal on desktop, BottomSheet on mobile). Loading state shows skeleton placeholders.

## Output

After completion, create `.planning/phases/06-checkout-flow/06-03-SUMMARY.md`
