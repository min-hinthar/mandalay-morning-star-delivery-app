---
phase: 14-testing-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/visual-regression.spec.ts
autonomous: true

must_haves:
  truths:
    - "Admin dashboard visual tests capture desktop and mobile viewports"
    - "Admin dashboard visual tests capture login redirect state"
    - "Driver dashboard visual tests capture desktop and mobile viewports"
    - "Driver route and history pages have visual tests"
    - "Font mocking prevents network-dependent test failures"
  artifacts:
    - path: "e2e/visual-regression.spec.ts"
      provides: "Admin and driver visual regression tests"
      contains: "Admin Dashboard Visual Regression (TEST-02)"
    - path: "e2e/visual-regression.spec.ts"
      provides: "Driver flow visual tests"
      contains: "Driver Dashboard Visual Regression (TEST-03)"
  key_links:
    - from: "e2e/visual-regression.spec.ts"
      to: "/admin"
      via: "page.goto"
      pattern: "page\\.goto.*\\/admin"
    - from: "e2e/visual-regression.spec.ts"
      to: "/driver"
      via: "page.goto"
      pattern: "page\\.goto.*\\/driver"
---

<objective>
Expand visual regression test coverage for admin and driver flows.

Purpose: Complete TEST-02 (admin visual tests) and TEST-03 (driver visual tests) requirements. Both protected pages redirect to login - tests capture login redirect state for both desktop and mobile viewports.

Output: Extended e2e/visual-regression.spec.ts with comprehensive admin/driver coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-testing-documentation/14-RESEARCH.md
@e2e/visual-regression.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add font mocking to visual regression tests</name>
  <files>e2e/visual-regression.spec.ts</files>
  <action>
Add font mocking helper at the top of the file (after imports) to prevent network-dependent test failures in sandboxed environments.

Create a helper function:
```typescript
async function mockFonts(page: Page) {
  await page.route("**/fonts.googleapis.com/**", route =>
    route.fulfill({ status: 200, contentType: "text/css", body: "" })
  );
  await page.route("**/fonts.gstatic.com/**", route =>
    route.fulfill({ status: 200, contentType: "font/woff2", body: "" })
  );
}
```

Import Page type from @playwright/test if not already imported.

Do NOT modify existing test.describe blocks - only add the helper function.
  </action>
  <verify>TypeScript compiles: `pnpm typecheck`</verify>
  <done>mockFonts helper function exists in visual-regression.spec.ts</done>
</task>

<task type="auto">
  <name>Task 2: Expand admin dashboard visual regression tests (TEST-02)</name>
  <files>e2e/visual-regression.spec.ts</files>
  <action>
Replace the existing "Admin Dashboard Visual Regression" test.describe block (lines 324-336) with expanded coverage.

New test structure:
```typescript
test.describe("Admin Dashboard Visual Regression (TEST-02)", () => {
  test.beforeEach(async ({ page }) => {
    await mockFonts(page);
  });

  test("admin dashboard - desktop", async ({ page }) => {
    await page.goto("/admin");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(500);
    // Redirects to login - captures login state
    await expect(page).toHaveScreenshot("admin-dashboard-desktop.png", {
      fullPage: true,
      maxDiffPixels: 150,
    });
  });

  test("admin dashboard - mobile", async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto("/admin");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(500);
    await expect(page).toHaveScreenshot("admin-dashboard-mobile.png", {
      fullPage: true,
      maxDiffPixels: 150,
    });
  });

  test("admin login redirect state", async ({ page }) => {
    await page.goto("/admin");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(300);
    // Verify we're on login page (auth redirect)
    await expect(page).toHaveURL(/login/);
    await expect(page).toHaveScreenshot("admin-login-redirect.png", {
      fullPage: true,
      maxDiffPixels: 150,
    });
  });
});
```

Key patterns:
- Add beforeEach with mockFonts for network independence
- Desktop test (default viewport)
- Mobile test (375x667 viewport)
- Login redirect verification test
- Label with (TEST-02) for traceability
  </action>
  <verify>Tests parse correctly: `pnpm exec playwright test e2e/visual-regression.spec.ts --list | grep -i admin`</verify>
  <done>Admin Dashboard Visual Regression (TEST-02) block has 3 tests: desktop, mobile, login redirect</done>
</task>

<task type="auto">
  <name>Task 3: Expand driver dashboard visual regression tests (TEST-03)</name>
  <files>e2e/visual-regression.spec.ts</files>
  <action>
Replace the existing "Driver Interface Visual Regression" test.describe block (lines 292-321) with expanded coverage.

New test structure:
```typescript
test.describe("Driver Dashboard Visual Regression (TEST-03)", () => {
  test.beforeEach(async ({ page }) => {
    await mockFonts(page);
  });

  test("driver dashboard - desktop", async ({ page }) => {
    await page.goto("/driver");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(500);
    // Redirects to login
    await expect(page).toHaveScreenshot("driver-dashboard-desktop.png", {
      fullPage: true,
      maxDiffPixels: 150,
    });
  });

  test("driver dashboard - mobile", async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto("/driver");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(500);
    await expect(page).toHaveScreenshot("driver-dashboard-mobile.png", {
      fullPage: true,
      maxDiffPixels: 150,
    });
  });

  test("driver route page - login redirect", async ({ page }) => {
    await page.goto("/driver/route");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(300);
    await expect(page).toHaveScreenshot("driver-route-login.png", {
      fullPage: true,
      maxDiffPixels: 150,
    });
  });

  test("driver history page - login redirect", async ({ page }) => {
    await page.goto("/driver/history");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(300);
    await expect(page).toHaveScreenshot("driver-history-login.png", {
      fullPage: true,
      maxDiffPixels: 150,
    });
  });

  test("driver login redirect state", async ({ page }) => {
    await page.goto("/driver");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(300);
    // Verify redirect to login with next param
    await expect(page).toHaveURL(/login.*next.*driver/);
    await expect(page).toHaveScreenshot("driver-login-redirect.png", {
      fullPage: true,
      maxDiffPixels: 150,
    });
  });
});
```

Key patterns:
- Add beforeEach with mockFonts for network independence
- Dashboard desktop and mobile viewports
- Route page visual test
- History page visual test
- Login redirect verification with URL check
- Label with (TEST-03) for traceability
  </action>
  <verify>Tests parse correctly: `pnpm exec playwright test e2e/visual-regression.spec.ts --list | grep -i driver`</verify>
  <done>Driver Dashboard Visual Regression (TEST-03) block has 5 tests: desktop, mobile, route, history, login redirect</done>
</task>

</tasks>

<verification>
Run all checks:
```bash
pnpm typecheck
pnpm exec playwright test e2e/visual-regression.spec.ts --list
```

Expected:
- TypeScript compiles without errors
- Test list shows:
  - "Admin Dashboard Visual Regression (TEST-02)" with 3 tests
  - "Driver Dashboard Visual Regression (TEST-03)" with 5 tests
</verification>

<success_criteria>
- [ ] mockFonts helper function exists at top of file
- [ ] Admin Dashboard Visual Regression (TEST-02) has desktop, mobile, login redirect tests
- [ ] Driver Dashboard Visual Regression (TEST-03) has dashboard desktop/mobile, route, history, login redirect tests
- [ ] All tests use mockFonts in beforeEach
- [ ] TypeScript compiles without errors
- [ ] Tests list correctly via Playwright CLI
</success_criteria>

<output>
After completion, create `.planning/phases/14-testing-documentation/14-01-SUMMARY.md`
</output>
