---
phase: 21-theme-refinements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/theme-toggle.tsx
  - src/lib/hooks/useThemeTransition.ts
  - src/lib/theme-sounds.ts
  - src/styles/globals.css
autonomous: true

must_haves:
  truths:
    - "Theme toggle animates sun/moon icon morph on click"
    - "Theme switch has circular reveal expanding from toggle button"
    - "Theme toggle plays nature-inspired sounds (chime for light, low tone for dark)"
    - "Reduced motion users see instant theme switch without animation"
  artifacts:
    - path: "src/components/ui/theme-toggle.tsx"
      provides: "Enhanced theme toggle with SVG morph and sounds"
      min_lines: 100
    - path: "src/lib/hooks/useThemeTransition.ts"
      provides: "View Transitions API hook for circular reveal"
      exports: ["useThemeTransition"]
    - path: "src/lib/theme-sounds.ts"
      provides: "Web Audio theme toggle sounds"
      exports: ["playLightChime", "playDarkTone"]
  key_links:
    - from: "src/components/ui/theme-toggle.tsx"
      to: "src/lib/hooks/useThemeTransition.ts"
      via: "hook import"
      pattern: "useThemeTransition"
    - from: "src/components/ui/theme-toggle.tsx"
      to: "src/lib/theme-sounds.ts"
      via: "sound function import"
      pattern: "playLightChime|playDarkTone"
---

<objective>
Create animated theme toggle with sun/moon morph, circular reveal transition, and themed sounds.

Purpose: THEME-03, THEME-04 - Theme toggle feels delightful with snappy spring physics, playful circular reveal, and nature-inspired audio feedback.
Output: Enhanced theme-toggle.tsx with SVG path morphing, useThemeTransition hook using View Transitions API, theme-sounds.ts with Web Audio synthesis.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-theme-refinements/21-CONTEXT.md
@.planning/phases/21-theme-refinements/21-RESEARCH.md
@src/components/ui/theme-toggle.tsx
@src/lib/motion-tokens.ts
@src/lib/hooks/useSoundEffect.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme-sounds.ts with Web Audio synthesis</name>
  <files>src/lib/theme-sounds.ts</files>
  <action>
Create Web Audio-based theme toggle sounds following established useSoundEffect pattern from 20-03.

```typescript
/**
 * Theme Toggle Sound Effects
 *
 * Uses Web Audio API synthesis for nature-inspired sounds:
 * - Light mode: Bright chime (high frequency, quick decay)
 * - Dark mode: Low tone (low frequency, longer decay)
 *
 * Respects user sound preferences via localStorage.
 */

let audioContext: AudioContext | null = null;
let userHasInteracted = false;

// Track user interaction for autoplay policy
if (typeof window !== 'undefined') {
  const markInteracted = () => {
    userHasInteracted = true;
  };
  window.addEventListener('click', markInteracted, { once: true });
  window.addEventListener('touchstart', markInteracted, { once: true });
  window.addEventListener('keydown', markInteracted, { once: true });
}

function getAudioContext(): AudioContext | null {
  if (typeof window === 'undefined') return null;
  if (!userHasInteracted) return null;

  if (!audioContext) {
    audioContext = new (window.AudioContext || (window as typeof window & { webkitAudioContext: typeof AudioContext }).webkitAudioContext)();
  }

  if (audioContext.state === 'suspended') {
    audioContext.resume().catch(() => {});
  }

  return audioContext;
}

function isSoundEnabled(): boolean {
  if (typeof window === 'undefined') return false;
  return localStorage.getItem('soundEnabled') !== 'false';
}

function playTone(
  frequency: number,
  duration: number,
  type: OscillatorType = 'sine',
  volume: number = 0.1
): void {
  const ctx = getAudioContext();
  if (!ctx || !isSoundEnabled()) return;

  try {
    const oscillator = ctx.createOscillator();
    const gain = ctx.createGain();

    oscillator.connect(gain);
    gain.connect(ctx.destination);

    oscillator.frequency.value = frequency;
    oscillator.type = type;

    gain.gain.setValueAtTime(volume, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);

    oscillator.start(ctx.currentTime);
    oscillator.stop(ctx.currentTime + duration);
  } catch {
    // Silently fail - audio is non-critical
  }
}

/**
 * Play bright chime for light mode activation
 * Nature-inspired: like a morning bird chirp
 */
export function playLightChime(): void {
  // Quick bright tone with harmonic
  playTone(880, 0.12, 'sine', 0.08);  // A5 - main
  setTimeout(() => playTone(1320, 0.1, 'sine', 0.04), 30); // E6 - harmonic
}

/**
 * Play low tone for dark mode activation
 * Nature-inspired: like an evening owl hoot
 */
export function playDarkTone(): void {
  // Lower, softer tone
  playTone(220, 0.2, 'sine', 0.1);  // A3
}
```
  </action>
  <verify>
`pnpm typecheck` passes - no TypeScript errors.
  </verify>
  <done>
theme-sounds.ts exports playLightChime() and playDarkTone() functions using Web Audio synthesis.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useThemeTransition hook with View Transitions API</name>
  <files>src/lib/hooks/useThemeTransition.ts</files>
  <action>
Create hook for circular reveal theme transition using View Transitions API.

```typescript
"use client";

import { useCallback, useRef } from 'react';

/**
 * Hook for animated theme transitions using View Transitions API.
 *
 * Features:
 * - Circular reveal expanding from click location
 * - Spring easing with slight overshoot
 * - Debounce rapid toggles (300ms)
 * - Graceful fallback for unsupported browsers
 * - Respects prefers-reduced-motion
 */

// Extend Document for View Transitions API
declare global {
  interface Document {
    startViewTransition?: (callback: () => void) => {
      ready: Promise<void>;
      finished: Promise<void>;
      updateCallbackDone: Promise<void>;
    };
  }
}

export function useThemeTransition() {
  const lastToggleRef = useRef(0);
  const DEBOUNCE_MS = 300;

  const toggleWithTransition = useCallback(
    async (
      event: React.MouseEvent,
      toggleFn: () => void
    ): Promise<void> => {
      // Debounce rapid toggles
      const now = Date.now();
      if (now - lastToggleRef.current < DEBOUNCE_MS) return;
      lastToggleRef.current = now;

      // Check for reduced motion preference
      const prefersReducedMotion = window.matchMedia(
        '(prefers-reduced-motion: reduce)'
      ).matches;

      // Feature detection + reduced motion check
      if (!document.startViewTransition || prefersReducedMotion) {
        toggleFn();
        return;
      }

      // Get click coordinates for circular reveal origin
      const x = event.clientX;
      const y = event.clientY;

      // Calculate max radius to cover entire viewport
      const endRadius = Math.hypot(
        Math.max(x, window.innerWidth - x),
        Math.max(y, window.innerHeight - y)
      );

      // Start view transition
      const transition = document.startViewTransition(() => {
        toggleFn();
      });

      try {
        await transition.ready;

        // Animate with circular clip-path
        document.documentElement.animate(
          {
            clipPath: [
              `circle(0px at ${x}px ${y}px)`,
              `circle(${endRadius}px at ${x}px ${y}px)`,
            ],
          },
          {
            duration: 300,
            easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)', // Spring overshoot
            pseudoElement: '::view-transition-new(root)',
          }
        );
      } catch {
        // Transition failed, theme still changes via toggleFn()
      }
    },
    []
  );

  return { toggleWithTransition };
}
```
  </action>
  <verify>
`pnpm typecheck` passes - View Transitions API types work.
  </verify>
  <done>
useThemeTransition hook exports toggleWithTransition function for circular reveal animations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance theme-toggle.tsx with SVG morph and integration</name>
  <files>src/components/ui/theme-toggle.tsx, src/styles/globals.css</files>
  <action>
Rewrite theme-toggle.tsx with:
1. Animated sun/moon SVG morph using Framer Motion
2. Integration with useThemeTransition hook
3. Theme sounds on toggle
4. Circular button with snappy spring physics
5. Theme-dependent styling (border in light, glow in dark)

**Add View Transition CSS to globals.css:**
```css
/* View Transition API - Theme circular reveal */
::view-transition-old(root),
::view-transition-new(root) {
  animation: none;
  mix-blend-mode: normal;
}

::view-transition-old(root) {
  z-index: 1;
}

::view-transition-new(root) {
  z-index: 9999;
}

/* Disable view transition for reduced motion */
@media (prefers-reduced-motion: reduce) {
  ::view-transition-group(*),
  ::view-transition-old(*),
  ::view-transition-new(*) {
    animation: none !important;
  }
}
```

**Rewrite theme-toggle.tsx:**
```typescript
"use client";

import { useTheme } from "next-themes";
import { useEffect, useState, useCallback } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { cn } from "@/lib/utils/cn";
import { spring } from "@/lib/motion-tokens";
import { useThemeTransition } from "@/lib/hooks/useThemeTransition";
import { playLightChime, playDarkTone } from "@/lib/theme-sounds";

// SVG paths for sun and moon - compatible point counts for morphing
const sunPath = "M12 3v1m0 16v1m-9-9h1m16 0h1m-2.636-6.364l-.707.707M6.343 17.657l-.707.707m0-12.728l.707.707M17.657 17.657l.707.707M12 8a4 4 0 100 8 4 4 0 000-8z";
const moonPath = "M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z";

interface ThemeToggleProps {
  className?: string;
}

export function ThemeToggle({ className }: ThemeToggleProps) {
  const { theme, setTheme, resolvedTheme } = useTheme();
  const { toggleWithTransition } = useThemeTransition();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  const handleToggle = useCallback(
    (event: React.MouseEvent) => {
      const nextTheme = resolvedTheme === "dark" ? "light" : "dark";

      toggleWithTransition(event, () => {
        setTheme(nextTheme);

        // Play appropriate sound
        if (nextTheme === "light") {
          playLightChime();
        } else {
          playDarkTone();
        }
      });
    },
    [resolvedTheme, setTheme, toggleWithTransition]
  );

  // Skeleton during hydration
  if (!mounted) {
    return (
      <div
        className={cn(
          "flex h-10 w-10 items-center justify-center rounded-full",
          "bg-surface-tertiary",
          className
        )}
        aria-hidden
      />
    );
  }

  const isDark = resolvedTheme === "dark";

  return (
    <motion.button
      onClick={handleToggle}
      className={cn(
        "relative flex h-10 w-10 items-center justify-center rounded-full",
        "bg-surface-tertiary dark:bg-white/10",
        "border border-border-default dark:border-transparent",
        "dark:shadow-[0_0_12px_rgba(232,67,99,0.3)]", // Glow in dark mode
        "transition-colors duration-200",
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
        className
      )}
      whileHover={{ scale: 1.05 }}
      whileTap={{ scale: 0.95 }}
      transition={spring.snappyButton}
      aria-label={`Switch to ${isDark ? "light" : "dark"} mode`}
    >
      <AnimatePresence mode="wait">
        <motion.svg
          key={isDark ? "moon" : "sun"}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth={2}
          strokeLinecap="round"
          strokeLinejoin="round"
          className={cn(
            "h-5 w-5",
            isDark ? "text-secondary" : "text-primary"
          )}
          initial={{ scale: 0, rotate: -90, opacity: 0 }}
          animate={{ scale: 1, rotate: 0, opacity: 1 }}
          exit={{ scale: 0, rotate: 90, opacity: 0 }}
          transition={{
            type: "spring",
            stiffness: 500,
            damping: 25,
            mass: 0.8,
          }}
        >
          <path d={isDark ? moonPath : sunPath} />
        </motion.svg>
      </AnimatePresence>
    </motion.button>
  );
}
```

**Key features:**
- Snappy spring physics on hover/tap (spring.snappyButton)
- SVG icon swap with AnimatePresence for smooth morph effect
- Theme-dependent border (light) vs glow (dark)
- Sound feedback via playLightChime/playDarkTone
- Circular reveal via useThemeTransition hook
- Accessible: proper aria-label, focus ring
  </action>
  <verify>
1. `pnpm typecheck` passes
2. `pnpm build` passes
3. `pnpm dev` - click theme toggle:
   - Icon morphs with spring animation
   - Circular reveal expands from button location
   - Sound plays (if sounds enabled)
   - Button has border in light mode, glow in dark mode
  </verify>
  <done>
theme-toggle.tsx has animated icon morph, circular reveal transition, and themed sounds. Button has snappy spring physics and theme-dependent styling.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. Theme toggle icon animates on click (sun/moon with spring)
3. Circular reveal expands from toggle button location
4. Sounds play on toggle (if enabled in user preferences)
5. Reduced motion: instant theme switch, no animation
6. Unsupported browsers (Safari without flag): instant fallback
</verification>

<success_criteria>
- THEME-03 satisfied: Theme toggle animates sun/moon morph
- THEME-04 satisfied: Circular reveal transition on theme switch
- Accessibility: Focus ring, aria-label, reduced motion support
- No regressions: Theme still persists, header still works
</success_criteria>

<output>
After completion, create `.planning/phases/21-theme-refinements/21-02-SUMMARY.md`
</output>
