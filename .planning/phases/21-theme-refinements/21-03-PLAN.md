---
phase: 21-theme-refinements
plan: 03
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/components/3d/ThemeAwareLighting.tsx
  - src/components/3d/Hero3DCanvas.tsx
  - src/components/3d/index.ts
autonomous: true

must_haves:
  truths:
    - "3D scene has warm directional light in light mode"
    - "3D scene has cool ambient light in dark mode"
    - "Lighting transitions smoothly (~500ms lerp) when theme changes"
    - "Contact shadows are darker in light mode, subtle glow in dark mode"
  artifacts:
    - path: "src/components/3d/ThemeAwareLighting.tsx"
      provides: "Theme-reactive lighting component for 3D scene"
      exports: ["ThemeAwareLighting"]
      min_lines: 60
    - path: "src/components/3d/Hero3DCanvas.tsx"
      provides: "Hero 3D canvas with theme-aware lighting"
      min_lines: 80
  key_links:
    - from: "src/components/3d/Hero3DCanvas.tsx"
      to: "src/components/3d/ThemeAwareLighting.tsx"
      via: "component import"
      pattern: "ThemeAwareLighting"
    - from: "src/components/3d/ThemeAwareLighting.tsx"
      to: "next-themes"
      via: "useTheme hook"
      pattern: "useTheme"
---

<objective>
Create theme-aware 3D lighting that adapts to light/dark mode with smooth transitions.

Purpose: THEME-05 - 3D hero scene feels like different times of day: warm studio light in light mode, cool night ambient in dark mode.
Output: ThemeAwareLighting.tsx component with lerped color/intensity transitions, integrated into Hero3DCanvas.tsx.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-theme-refinements/21-CONTEXT.md
@.planning/phases/21-theme-refinements/21-RESEARCH.md
@.planning/phases/21-theme-refinements/21-01-SUMMARY.md
@src/components/3d/Hero3DCanvas.tsx
@src/components/3d/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeAwareLighting component</name>
  <files>src/components/3d/ThemeAwareLighting.tsx</files>
  <action>
Create a new React Three Fiber component that provides theme-reactive lighting.

```typescript
"use client";

import { useRef, useMemo, useState, useEffect } from 'react';
import { useFrame } from '@react-three/fiber';
import { Environment, ContactShadows } from '@react-three/drei';
import { useTheme } from 'next-themes';
import * as THREE from 'three';

/**
 * Theme-Aware Lighting for 3D Scene
 *
 * Light mode: Warm studio lighting (like daytime photography)
 * Dark mode: Cool ambient lighting (like evening/night)
 *
 * Features:
 * - Smooth ~500ms lerp transitions between themes
 * - Environment preset switching (studio vs night)
 * - Adaptive contact shadows
 * - Delta-time based animation for frame-rate independence
 */
export function ThemeAwareLighting() {
  const { resolvedTheme } = useTheme();
  const [mounted, setMounted] = useState(false);
  const directionalLightRef = useRef<THREE.DirectionalLight>(null);
  const ambientLightRef = useRef<THREE.AmbientLight>(null);

  // SSR safety
  useEffect(() => {
    setMounted(true);
  }, []);

  // Target values based on theme
  const targets = useMemo(() => {
    const isDark = resolvedTheme === 'dark';
    return {
      // Directional light - main key light
      directionalColor: isDark
        ? new THREE.Color('#4a5568') // Cool blue-gray
        : new THREE.Color('#fef3c7'), // Warm yellow
      directionalIntensity: isDark ? 0.3 : 1.2,

      // Ambient light - fill
      ambientColor: isDark
        ? new THREE.Color('#1e3a5f') // Deep blue
        : new THREE.Color('#fff7ed'), // Warm white
      ambientIntensity: isDark ? 0.4 : 0.5,

      // Contact shadows
      shadowOpacity: isDark ? 0.2 : 0.5,
      shadowColor: isDark ? '#4a5568' : '#000000',
      shadowBlur: isDark ? 3 : 2,
    };
  }, [resolvedTheme]);

  // Lerp lighting values every frame
  useFrame((_, delta) => {
    if (!directionalLightRef.current || !ambientLightRef.current) return;

    const lerpFactor = delta * 4; // ~250ms to reach target (4 * 0.016 = ~0.06 per frame)

    // Lerp directional light
    directionalLightRef.current.color.lerp(targets.directionalColor, lerpFactor);
    directionalLightRef.current.intensity = THREE.MathUtils.lerp(
      directionalLightRef.current.intensity,
      targets.directionalIntensity,
      lerpFactor
    );

    // Lerp ambient light
    ambientLightRef.current.color.lerp(targets.ambientColor, lerpFactor);
    ambientLightRef.current.intensity = THREE.MathUtils.lerp(
      ambientLightRef.current.intensity,
      targets.ambientIntensity,
      lerpFactor
    );
  });

  // During SSR or before mount, use light mode defaults
  const isDark = mounted ? resolvedTheme === 'dark' : false;

  return (
    <>
      {/* Key light - warm in light mode, cool in dark mode */}
      <directionalLight
        ref={directionalLightRef}
        position={[5, 5, 5]}
        color={isDark ? '#4a5568' : '#fef3c7'}
        intensity={isDark ? 0.3 : 1.2}
        castShadow
      />

      {/* Fill light - subtle ambient */}
      <ambientLight
        ref={ambientLightRef}
        color={isDark ? '#1e3a5f' : '#fff7ed'}
        intensity={isDark ? 0.4 : 0.5}
      />

      {/* Environment - HDRI lighting for reflections */}
      <Environment
        preset={isDark ? 'night' : 'studio'}
        background={false}
      />

      {/* Contact shadows - darker in light, subtle glow in dark */}
      <ContactShadows
        position={[0, -1, 0]}
        opacity={targets.shadowOpacity}
        scale={10}
        blur={targets.shadowBlur}
        color={targets.shadowColor}
      />
    </>
  );
}

export default ThemeAwareLighting;
```

**Key design decisions:**
- `delta * 4` lerp factor gives ~500ms transition (smooth but not slow)
- Environment preset changes instantly (drei handles its own transition)
- ContactShadows opacity/blur/color adapt to theme
- SSR-safe with mounted check
- Warm yellow (#fef3c7) for light mode studio feel
- Cool blue-gray (#4a5568) for dark mode night feel
  </action>
  <verify>
`pnpm typecheck` passes - Three.js types resolve correctly.
  </verify>
  <done>
ThemeAwareLighting.tsx exports component with lerped directional/ambient lights, theme-aware Environment preset, and adaptive ContactShadows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ThemeAwareLighting into Hero3DCanvas</name>
  <files>src/components/3d/Hero3DCanvas.tsx, src/components/3d/index.ts</files>
  <action>
Update Hero3DCanvas.tsx to use new ThemeAwareLighting component instead of static lighting.

**Hero3DCanvas.tsx changes:**

1. Import ThemeAwareLighting:
```typescript
import { ThemeAwareLighting } from './ThemeAwareLighting';
```

2. Replace static lighting setup (Environment, ContactShadows, ambientLight) with single component:

```typescript
// BEFORE (lines 69-81)
{/* Studio lighting via Environment */}
<Environment preset="studio" />

{/* Contact shadow for grounding */}
<ContactShadows
  opacity={0.4}
  scale={10}
  blur={2}
  position={[0, -1, 0]}
/>

{/* Ambient fill light */}
<ambientLight intensity={0.3} />
```

```typescript
// AFTER
{/* Theme-aware lighting - adapts to light/dark mode */}
<ThemeAwareLighting />
```

3. Remove unused imports (Environment, ContactShadows) if not used elsewhere.

**Update src/components/3d/index.ts:**
Add export if not already present:
```typescript
export { ThemeAwareLighting } from './ThemeAwareLighting';
```
  </action>
  <verify>
1. `pnpm typecheck` passes
2. `pnpm build` passes
3. `pnpm dev` - view homepage hero:
   - Light mode: warm golden lighting, darker contact shadow
   - Dark mode: cool blue lighting, subtle shadow
   - Toggle theme: lighting transitions smoothly (~500ms)
  </verify>
  <done>
Hero3DCanvas uses ThemeAwareLighting component. 3D scene adapts to theme with smooth transitions.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. 3D hero scene in light mode: warm studio lighting, darker shadows
3. 3D hero scene in dark mode: cool ambient lighting, subtle shadows
4. Theme toggle: lighting transitions smoothly over ~500ms
5. No visual glitches during transition
6. Model still visible and properly lit in both themes
</verification>

<success_criteria>
- THEME-05 satisfied: 3D scene lighting adapts to light/dark theme
- Smooth transitions: ~500ms lerp feels natural, not jarring
- No regressions: 3D hero still interactive, loads correctly, fallback works
- Performance: No frame drops during lighting transition
</success_criteria>

<output>
After completion, create `.planning/phases/21-theme-refinements/21-03-SUMMARY.md`
</output>
