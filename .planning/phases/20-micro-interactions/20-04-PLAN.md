---
phase: 20-micro-interactions
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/button.tsx
  - src/components/menu/UnifiedMenuItemCard/CardImage.tsx
  - src/components/ui-v8/menu/ItemDetailSheetV8.tsx
  - src/components/checkout/AddressFormV8.tsx
  - src/components/auth/AuthModal.tsx
  - src/components/driver/HighContrastToggle.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Button loading spinner shows branded 8-pointed star instead of Loader2"
    - "Menu card images have blur-to-sharp reveal animation on load"
    - "Form validation errors shake when invalid"
    - "Driver high contrast toggle has bouncy spring animation"
  artifacts:
    - path: "src/components/ui/button.tsx"
      provides: "BrandedSpinner integration"
      contains: "BrandedSpinner"
    - path: "src/components/menu/UnifiedMenuItemCard/CardImage.tsx"
      provides: "AnimatedImage for menu cards"
      contains: "AnimatedImage"
    - path: "src/components/checkout/AddressFormV8.tsx"
      provides: "ErrorShake on validation errors"
      contains: "ErrorShake"
    - path: "src/components/driver/HighContrastToggle.tsx"
      provides: "AnimatedToggle integration"
      contains: "AnimatedToggle"
  key_links:
    - from: "src/components/ui/button.tsx"
      to: "src/components/ui/branded-spinner.tsx"
      via: "import BrandedSpinner"
      pattern: "import.*BrandedSpinner"
    - from: "src/components/menu/UnifiedMenuItemCard/CardImage.tsx"
      to: "src/components/ui/animated-image.tsx"
      via: "import AnimatedImage"
      pattern: "import.*AnimatedImage"
    - from: "src/components/checkout/AddressFormV8.tsx"
      to: "src/components/ui/error-shake.tsx"
      via: "import ErrorShake"
      pattern: "import.*ErrorShake"
---

<objective>
Wire orphaned micro-interaction components into their consuming components.

Purpose: Phase 20 created 4 excellent micro-interaction components (AnimatedToggle, BrandedSpinner, ErrorShake, AnimatedImage) but they are orphaned - never imported anywhere. This gap closure plan integrates them into the app.

Output: All 4 orphaned components are imported and used by their intended consumers, completing MICRO-03, MICRO-04, MICRO-06, MICRO-09 requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/20-micro-interactions/20-VERIFICATION.md

# Orphaned components to integrate
@src/components/ui/branded-spinner.tsx
@src/components/ui/animated-toggle.tsx
@src/components/ui/error-shake.tsx
@src/components/ui/animated-image.tsx

# Consumer components to modify
@src/components/ui/button.tsx
@src/components/menu/UnifiedMenuItemCard/CardImage.tsx
@src/components/checkout/AddressFormV8.tsx
@src/components/driver/HighContrastToggle.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate BrandedSpinner into Button component</name>
  <files>src/components/ui/button.tsx</files>
  <action>
Replace Loader2 spinner with BrandedSpinner in Button's loading state.

1. Import BrandedSpinner from "@/components/ui/branded-spinner"
2. Remove Loader2 import from lucide-react (or keep if used elsewhere)
3. In buttonContent loading state (lines 175-183), replace:
   ```tsx
   <Loader2 className="animate-spin" aria-hidden="true" />
   ```
   with:
   ```tsx
   <BrandedSpinner size="sm" className="text-current" />
   ```
4. The BrandedSpinner handles its own animation, so remove animate-spin class
5. Preserve the existing layout: spinner + loading text + hidden children for width maintenance

Size mapping for button sizes:
- sm, md buttons: BrandedSpinner size="sm" (20px)
- lg, xl buttons: BrandedSpinner size="md" (32px)

Add a helper to determine spinner size based on button size prop.
  </action>
  <verify>
Run `pnpm typecheck` - no errors
Grep for "BrandedSpinner" in button.tsx - should find import and usage
Grep for "Loader2" in button.tsx - should NOT find (removed)
  </verify>
  <done>Button loading state shows 8-pointed star spinner instead of generic Loader2 circle</done>
</task>

<task type="auto">
  <name>Task 2: Integrate AnimatedImage into CardImage and ItemDetailSheetV8</name>
  <files>src/components/menu/UnifiedMenuItemCard/CardImage.tsx, src/components/ui-v8/menu/ItemDetailSheetV8.tsx</files>
  <action>
Replace next/image with AnimatedImage for menu item images.

**CardImage.tsx:**
1. Import AnimatedImage from "@/components/ui/animated-image"
2. Keep existing next/image import for fallback/compatibility
3. Replace the Image component inside the motion.div (lines 88-95) with:
   ```tsx
   <AnimatedImage
     src={imageUrl}
     alt={alt}
     fill
     sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
     priority={priority}
     variant="blur-scale"
     className="object-cover"
   />
   ```
4. AnimatedImage already handles the reveal animation, so the existing parallax motion.div wrapper still controls position

**ItemDetailSheetV8.tsx:**
1. Import AnimatedImage from "@/components/ui/animated-image"
2. In the hero image section (lines 195-203), replace Image with:
   ```tsx
   <AnimatedImage
     src={item.imageUrl}
     alt={item.nameEn}
     fill
     className="object-cover"
     priority
     sizes="(max-width: 640px) 100vw, 480px"
     variant="blur-scale"
   />
   ```
  </action>
  <verify>
Run `pnpm typecheck` - no errors
Grep for "AnimatedImage" in CardImage.tsx - should find import and usage
Grep for "AnimatedImage" in ItemDetailSheetV8.tsx - should find import and usage
  </verify>
  <done>Menu card images and item detail hero images have blur-to-sharp reveal animation</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ErrorShake into form validation</name>
  <files>src/components/checkout/AddressFormV8.tsx, src/components/auth/AuthModal.tsx</files>
  <action>
Wrap form validation errors with ErrorShake for visual feedback.

**AddressFormV8.tsx:**
1. Import ErrorShake, useErrorShake from "@/components/ui/error-shake"
2. Add useErrorShake hook at component level: `const { shake, triggerShake } = useErrorShake();`
3. Trigger shake on form submit with errors:
   - In submitHandler, after validation fails, call triggerShake()
   - Or use react-hook-form's onError callback in handleSubmit
4. Wrap the form-level error div (lines 83-96) with ErrorShake:
   ```tsx
   <ErrorShake shake={shake && !!error}>
     <AnimatePresence mode="wait">
       {error && (
         <motion.div ... >
           {error}
         </motion.div>
       )}
     </AnimatePresence>
   </ErrorShake>
   ```
5. For individual field errors, the ValidatedInput already has shakeOnError={true}, which should use ErrorShake internally. If not, wrap each AnimatedFormField.

**AuthModal.tsx:**
1. Import ErrorShake, useErrorShake from "@/components/ui/error-shake"
2. Add useErrorShake hook: `const { shake: errorShake, triggerShake } = useErrorShake();`
3. Call triggerShake() when setError is called with a non-null value (lines 236, 247, 258)
4. Wrap the AnimatedInput error section or the entire form with ErrorShake that activates on error state
  </action>
  <verify>
Run `pnpm typecheck` - no errors
Grep for "ErrorShake" in AddressFormV8.tsx - should find import and usage
Grep for "ErrorShake" in AuthModal.tsx - should find import and usage
  </verify>
  <done>Form validation errors have shake animation providing clear visual feedback</done>
</task>

<task type="auto">
  <name>Task 4: Integrate AnimatedToggle into HighContrastToggle</name>
  <files>src/components/driver/HighContrastToggle.tsx</files>
  <action>
Replace manual toggle button with AnimatedToggle component for bouncy spring animation.

1. Import AnimatedToggle from "@/components/ui/animated-toggle"
2. The current HighContrastToggle is a 48x48 icon button that toggles high contrast mode
3. AnimatedToggle is a proper switch component with spring animation
4. Replace the current implementation with AnimatedToggle:
   ```tsx
   export function HighContrastToggle({ className }: HighContrastToggleProps) {
     const { isHighContrast, toggleContrast } = useDriverContrast();

     return (
       <div className={cn("flex items-center gap-3", className)}>
         <span className="text-sm text-text-secondary">
           {isHighContrast ? (
             <Moon className="h-5 w-5" aria-hidden="true" />
           ) : (
             <Sun className="h-5 w-5" aria-hidden="true" />
           )}
         </span>
         <AnimatedToggle
           checked={isHighContrast}
           onCheckedChange={toggleContrast}
           size="md"
           aria-label={isHighContrast ? "Switch to standard contrast" : "Switch to high contrast"}
         />
       </div>
     );
   }
   ```
5. This gives the toggle bouncy spring physics while preserving the icon visual indicator
6. Keep Moon/Sun import from lucide-react for the icon
  </action>
  <verify>
Run `pnpm typecheck` - no errors
Grep for "AnimatedToggle" in HighContrastToggle.tsx - should find import and usage
  </verify>
  <done>Driver high contrast toggle has bouncy spring animation matching MICRO-03 requirement</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **BrandedSpinner integration:**
   ```bash
   grep -n "BrandedSpinner" src/components/ui/button.tsx
   # Should show import and usage in loading state
   ```

2. **AnimatedImage integration:**
   ```bash
   grep -rn "AnimatedImage" src/components/menu/UnifiedMenuItemCard/
   grep -rn "AnimatedImage" src/components/ui-v8/menu/ItemDetailSheetV8.tsx
   # Both should show imports and usage
   ```

3. **ErrorShake integration:**
   ```bash
   grep -rn "ErrorShake" src/components/checkout/AddressFormV8.tsx
   grep -rn "ErrorShake" src/components/auth/AuthModal.tsx
   # Both should show imports and usage
   ```

4. **AnimatedToggle integration:**
   ```bash
   grep -n "AnimatedToggle" src/components/driver/HighContrastToggle.tsx
   # Should show import and usage
   ```

5. **No orphaned components:**
   ```bash
   # All 4 components should now have imports
   grep -rn "from.*branded-spinner" src/
   grep -rn "from.*animated-toggle" src/
   grep -rn "from.*error-shake" src/
   grep -rn "from.*animated-image" src/
   ```

6. **Build passes:**
   ```bash
   pnpm typecheck && pnpm build
   ```
</verification>

<success_criteria>
- [ ] BrandedSpinner imported and used in Button component loading state
- [ ] AnimatedImage imported and used in CardImage.tsx for menu cards
- [ ] AnimatedImage imported and used in ItemDetailSheetV8.tsx for hero image
- [ ] ErrorShake imported and used in AddressFormV8.tsx for form errors
- [ ] ErrorShake imported and used in AuthModal.tsx for auth errors
- [ ] AnimatedToggle imported and used in HighContrastToggle.tsx
- [ ] All imports verified with grep (no orphaned components)
- [ ] `pnpm typecheck` passes
- [ ] `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-micro-interactions/20-04-SUMMARY.md`
</output>
