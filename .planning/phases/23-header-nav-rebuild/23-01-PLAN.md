---
phase: 23-header-nav-rebuild
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/hooks/useScrollDirectionWithVelocity.ts
  - src/lib/hooks/useHeaderVisibility.ts
  - src/lib/hooks/useCommandPalette.ts
  - src/lib/hooks/index.ts
  - package.json
  - pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "Fast scrolling hides header instantly"
    - "Slow scrolling hides header gradually with spring"
    - "Cmd/Ctrl+K opens command palette"
    - "Header stays visible when overlay is open"
  artifacts:
    - path: "src/lib/hooks/useScrollDirectionWithVelocity.ts"
      provides: "Velocity-aware scroll detection"
      exports: ["useScrollDirectionWithVelocity"]
    - path: "src/lib/hooks/useHeaderVisibility.ts"
      provides: "Combined header visibility logic"
      exports: ["useHeaderVisibility"]
    - path: "src/lib/hooks/useCommandPalette.ts"
      provides: "Command palette open/close state"
      exports: ["useCommandPalette"]
  key_links:
    - from: "useScrollDirectionWithVelocity"
      to: "framer-motion useVelocity"
      via: "useScroll + useVelocity composition"
      pattern: "useVelocity\\(scrollY\\)"
    - from: "useHeaderVisibility"
      to: "useScrollDirectionWithVelocity"
      via: "imports and combines with overlay state"
      pattern: "useScrollDirectionWithVelocity"
---

<objective>
Infrastructure hooks for velocity-aware header behavior and command palette keyboard shortcut.

Purpose: Establish foundational hooks that all header components will use for scroll-based hiding and command palette triggering.
Output: Three hooks (useScrollDirectionWithVelocity, useHeaderVisibility, useCommandPalette) + cmdk installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-header-nav-rebuild/23-CONTEXT.md
@.planning/phases/23-header-nav-rebuild/23-RESEARCH.md

@src/lib/hooks/useScrollDirection.ts
@src/lib/motion-tokens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cmdk and create velocity-aware scroll hook</name>
  <files>
    - package.json
    - pnpm-lock.yaml
    - src/lib/hooks/useScrollDirectionWithVelocity.ts
  </files>
  <action>
1. Install cmdk library:
   ```bash
   pnpm add cmdk
   ```

2. Create `src/lib/hooks/useScrollDirectionWithVelocity.ts`:
   - Import useScroll, useVelocity, useMotionValueEvent from framer-motion
   - Accept options: threshold (default 50), velocityThreshold (default 300)
   - Return state object: { direction, isCollapsed, isFastScroll, scrollY, isAtTop }
   - Use useVelocity(scrollY) to get scroll velocity
   - isFastScroll = Math.abs(velocity) > velocityThreshold
   - Direction detection same as existing useScrollDirection but with velocity awareness
   - Export type UseScrollDirectionWithVelocityOptions and UseScrollDirectionWithVelocityReturn
  </action>
  <verify>
    - `pnpm ls cmdk` shows cmdk installed
    - TypeScript compiles: `pnpm typecheck`
    - Hook imports cleanly: grep for useScrollDirectionWithVelocity in hooks/index.ts
  </verify>
  <done>useScrollDirectionWithVelocity hook exists with velocity detection via useVelocity from framer-motion</done>
</task>

<task type="auto">
  <name>Task 2: Create header visibility and command palette hooks</name>
  <files>
    - src/lib/hooks/useHeaderVisibility.ts
    - src/lib/hooks/useCommandPalette.ts
    - src/lib/hooks/index.ts
  </files>
  <action>
1. Create `src/lib/hooks/useHeaderVisibility.ts`:
   - Import useScrollDirectionWithVelocity
   - Accept options: scrollThreshold, velocityThreshold, overlayOpen (boolean)
   - Return: { isVisible, isCollapsed, isFastScroll, scrollY, isAtTop }
   - Logic: When overlayOpen=true, always visible (pinned), reset isCollapsed
   - When scrolling, use velocity to determine animation speed
   - Export getHeaderTransition(isFastScroll) helper that returns { duration: 0.1 } for fast, spring.snappy for slow

2. Create `src/lib/hooks/useCommandPalette.ts`:
   - useState for isOpen
   - useEffect for keyboard shortcut (Cmd/Ctrl+K)
   - preventDefault immediately to avoid browser conflicts
   - Return: { isOpen, open, close, toggle }
   - Handle cleanup on unmount

3. Update `src/lib/hooks/index.ts`:
   - Export useScrollDirectionWithVelocity
   - Export useHeaderVisibility
   - Export useCommandPalette
  </action>
  <verify>
    - `pnpm typecheck` passes
    - All three hooks are exported from index.ts
    - No circular dependencies
  </verify>
  <done>useHeaderVisibility combines scroll/overlay state, useCommandPalette handles Cmd/Ctrl+K shortcut</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with no errors
- `pnpm lint` passes
- cmdk appears in package.json dependencies
- All hooks exported from src/lib/hooks/index.ts
</verification>

<success_criteria>
- cmdk library installed
- useScrollDirectionWithVelocity detects fast vs slow scrolling
- useHeaderVisibility pins header when overlay open
- useCommandPalette fires on Cmd/Ctrl+K keypress
- All hooks TypeScript-safe with exported types
</success_criteria>

<output>
After completion, create `.planning/phases/23-header-nav-rebuild/23-01-SUMMARY.md`
</output>
