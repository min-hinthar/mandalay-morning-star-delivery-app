---
phase: 23-header-nav-rebuild
plan: 05
type: execute
wave: 3
depends_on: [23-02, 23-03, 23-04]
files_modified:
  - src/components/layout/AppHeader/CartIndicator.tsx
  - src/components/layout/AppHeader/AccountIndicator.tsx
  - src/components/layout/AppHeader/SearchTrigger.tsx
  - src/components/layout/AppHeader/AppHeader.tsx
  - src/components/layout/AppHeader/DesktopHeader.tsx
  - src/components/layout/AppHeader/MobileHeader.tsx
  - src/app/providers.tsx
  - src/app/(customer)/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Cart badge bounces and icon shakes on item add"
    - "Account shows avatar or initials when logged in"
    - "Search icon shows Cmd K hint on hover"
    - "All header pieces work together in layout"
    - "Old header replaced with new AppHeader"
  artifacts:
    - path: "src/components/layout/AppHeader/CartIndicator.tsx"
      provides: "Cart icon with animated badge"
      exports: ["CartIndicator"]
    - path: "src/components/layout/AppHeader/AccountIndicator.tsx"
      provides: "Avatar/initials with dropdown"
      exports: ["AccountIndicator"]
    - path: "src/components/layout/AppHeader/SearchTrigger.tsx"
      provides: "Search icon with Cmd K hint"
      exports: ["SearchTrigger"]
  key_links:
    - from: "CartIndicator.tsx"
      to: "useCart"
      via: "cart count and animation trigger"
      pattern: "useCart|useCartAnimationStore"
    - from: "AccountIndicator.tsx"
      to: "useAuth"
      via: "user authentication state"
      pattern: "useAuth"
    - from: "src/app/(customer)/layout.tsx"
      to: "AppHeader"
      via: "header integration"
      pattern: "AppHeader"
---

<objective>
Complete header integration with Cart/Account indicators, search trigger, and layout wiring.

Purpose: Wire all header components together and integrate into customer layout, replacing old header.
Output: Fully functional header with cart (animated badge), account (avatar/dropdown), search trigger, and mobile drawer.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-header-nav-rebuild/23-CONTEXT.md
@.planning/phases/23-header-nav-rebuild/23-RESEARCH.md

@src/components/layout/AppHeader/AppHeader.tsx (after Plan 02)
@src/components/layout/MobileDrawer/MobileDrawer.tsx (after Plan 03)
@src/components/layout/CommandPalette/CommandPalette.tsx (after Plan 04)
@src/components/ui-v8/cart/CartButtonV8.tsx
@src/lib/hooks/useAuth.ts
@src/lib/hooks/useCart.ts
@src/lib/stores/cart-animation-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CartIndicator and SearchTrigger components</name>
  <files>
    - src/components/layout/AppHeader/CartIndicator.tsx
    - src/components/layout/AppHeader/SearchTrigger.tsx
  </files>
  <action>
1. Create `src/components/layout/AppHeader/CartIndicator.tsx`:
   - Reference CartButtonV8.tsx for patterns
   - Props: className
   - Use useCart for itemCount
   - Use useCartDrawer for open function
   - Use useCartAnimationStore for wasItemJustAdded trigger
   - Cart icon: ShoppingBag from lucide-react (same as CartButtonV8)
   - Badge: circle with count, position -top-1 -right-1
   - Animation per CONTEXT.md:
     - Badge bounces: scale [1, 1.4, 1] with spring.rubbery
     - Icon shakes: rotate [0, -8, 8, -8, 0] duration 0.4
   - Trigger both animations when wasItemJustAdded is true
   - Badge key based on itemCount for AnimatePresence re-animation
   - Hover: scale 1.05, tap: scale 0.95

2. Create `src/components/layout/AppHeader/SearchTrigger.tsx`:
   ```tsx
   interface SearchTriggerProps {
     onClick: () => void;
     className?: string;
   }
   ```
   - Search icon (lucide Search)
   - On hover, show keyboard hint tooltip/badge:
     - Motion.span with absolute positioning
     - Shows "Cmd K" (Mac) or "Ctrl K" (Windows)
     - Detect platform via navigator.platform or userAgent
     - Entrance: opacity 0 y: 4 -> opacity 1 y: 0
     - Small rounded badge style with gradient shadow per CONTEXT.md
   - Hover/tap animations same as CartIndicator
  </action>
  <verify>
    - `pnpm typecheck` passes
    - CartIndicator matches CartButtonV8 behavior
    - SearchTrigger shows platform-appropriate hint
  </verify>
  <done>CartIndicator has bounce+shake on add, SearchTrigger shows Cmd K hint on hover</done>
</task>

<task type="auto">
  <name>Task 2: Create AccountIndicator with dropdown</name>
  <files>
    - src/components/layout/AppHeader/AccountIndicator.tsx
  </files>
  <action>
Create `src/components/layout/AppHeader/AccountIndicator.tsx`:
```tsx
interface AccountIndicatorProps {
  className?: string;
}
```

- Use useAuth for user state
- When not logged in: User icon button linking to /auth/login
- When logged in:
  - Avatar image (user.user_metadata.avatar_url) OR initials fallback
  - Initials: first letter of email or name, gradient background
  - Status dot: w-2.5 h-2.5 rounded-full bg-green-500 absolute bottom-0 right-0 with white ring
  - Dropdown on click (not hover):
    - Use local state for open/close
    - AnimatePresence for dropdown animation
    - Animation per CONTEXT.md: slide down + scale + fade
      - initial: opacity: 0, scale: 0.95, y: -10
      - animate: opacity: 1, scale: 1, y: 0
    - Dropdown items: Profile (/account), Orders (/orders), Sign Out
    - Sign Out: call supabase.auth.signOut()
    - Gradient shadow on dropdown per CONTEXT.md
    - Close on click outside (useRef + useEffect)
    - Close on Escape key
  - Use zClass.popover for dropdown z-index
  </action>
  <verify>
    - `pnpm typecheck` passes
    - Dropdown opens/closes correctly
    - Sign out functionality works
  </verify>
  <done>AccountIndicator shows avatar/initials when logged in with working dropdown menu</done>
</task>

<task type="auto">
  <name>Task 3: Integrate all components into AppHeader and customer layout</name>
  <files>
    - src/components/layout/AppHeader/AppHeader.tsx
    - src/components/layout/AppHeader/DesktopHeader.tsx
    - src/components/layout/AppHeader/MobileHeader.tsx
    - src/components/layout/AppHeader/index.ts
    - src/app/(customer)/layout.tsx
  </files>
  <action>
1. Update `src/components/layout/AppHeader/DesktopHeader.tsx`:
   - Add right section with: ThemeToggle, SearchTrigger, CartIndicator, AccountIndicator
   - Spacing: gap-2 between icons
   - Order per CONTEXT.md: Theme, Search, Cart, Account (left to right)

2. Update `src/components/layout/AppHeader/MobileHeader.tsx`:
   - Left: MorphingMenu hamburger
   - Center: Compact logo
   - Right: CartIndicator (always visible per CONTEXT.md)
   - Note: Search is in drawer for mobile, Account is in drawer

3. Update `src/components/layout/AppHeader/AppHeader.tsx`:
   - Add state: mobileMenuOpen, commandPaletteOpen
   - Use useCommandPalette for keyboard shortcut binding
   - Pass overlayOpen={mobileMenuOpen || commandPaletteOpen} to useHeaderVisibility
   - Render MobileDrawer (from Plan 03) with isOpen={mobileMenuOpen}
   - Render CommandPalette (from Plan 04) with open={commandPaletteOpen}
   - Fetch menu items for CommandPalette (can use client-side query or pass as prop)
   - Pass user from useAuth to MobileDrawer

4. Update `src/components/layout/AppHeader/index.ts`:
   - Export all sub-components

5. Update `src/app/(customer)/layout.tsx`:
   - Replace existing Header import with AppHeader
   - Remove old MobileNav if present
   - Add HeaderSpacer below AppHeader to prevent content overlap
   - Ensure CartDrawerV8 still renders (it's separate from header)
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - `pnpm build` succeeds
    - Header renders in browser
  </verify>
  <done>AppHeader fully integrated with all indicators, drawer, palette, replacing old header in layout</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- `pnpm build` succeeds
- All components work together in browser:
  - Header hides/shows on scroll
  - Cart badge animates on add
  - Account dropdown opens/closes
  - Search trigger opens command palette
  - Mobile drawer opens from hamburger
  - Cmd/Ctrl+K opens palette
</verification>

<success_criteria>
- Cart indicator: badge bounces + icon shakes when item added
- Account indicator: avatar/initials with dropdown (Profile, Orders, Sign Out)
- Search trigger: shows Cmd K / Ctrl K hint on hover
- Desktop: Theme toggle, Search, Cart, Account in right section
- Mobile: Hamburger left, logo center, cart right
- Mobile drawer: opens from hamburger, has user section and theme toggle
- Command palette: opens from search click or Cmd/Ctrl+K
- Old header completely replaced in customer layout
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete header rebuild with all indicators, mobile drawer, and command palette</what-built>
  <how-to-verify>
    1. Visit http://localhost:3000 in desktop browser
    2. Verify header has: logo, nav links (Menu, Orders, Account), theme toggle, search, cart, account icons
    3. Scroll down - header should hide. Scroll up - header should reappear.
    4. Fast scroll vs slow scroll - observe different animation speeds
    5. Hover nav links - observe multi-layer hover (lift, underline, background)
    6. Hover search icon - observe "Cmd K" hint appear
    7. Press Cmd/Ctrl+K - command palette should open
    8. Type in palette - menu items should filter
    9. Click cart - cart drawer should open (existing behavior)
    10. If logged in: click account - dropdown should show Profile/Orders/Sign Out
    11. Resize to mobile width (<768px)
    12. Verify: hamburger left, logo center, cart right
    13. Click hamburger - drawer should slide from left
    14. Swipe drawer left - should close
    15. Verify drawer has: user section (or sign in), nav links with stagger, theme toggle, footer
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/23-header-nav-rebuild/23-05-SUMMARY.md`
</output>
