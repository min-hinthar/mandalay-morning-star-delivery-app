---
phase: 32-quality-assurance
plan: 03
type: execute
wave: 2
depends_on: ["32-02"]
files_modified:
  - .husky/pre-commit
  - package.json
  - e2e/visual-regression.spec.ts
autonomous: true

must_haves:
  truths:
    - "Pre-commit hook runs ESLint and Stylelint on staged files"
    - "Commits with token violations are blocked"
    - "Hero section has dedicated visual regression tests"
    - "Visual regression tests cover mobile and desktop viewports"
  artifacts:
    - path: ".husky/pre-commit"
      provides: "Git pre-commit hook running lint-staged"
      min_lines: 2
    - path: "package.json"
      provides: "lint-staged configuration"
      contains: "lint-staged"
    - path: "e2e/visual-regression.spec.ts"
      provides: "Hero section visual regression tests"
      contains: "Hero Section"
  key_links:
    - from: ".husky/pre-commit"
      to: "package.json lint-staged config"
      via: "pnpm lint-staged command"
      pattern: "lint-staged"
---

<objective>
Set up regression prevention infrastructure: Husky pre-commit hooks with lint-staged, and Hero-specific visual regression tests.

Purpose: Prevent future token violations from being committed and ensure Hero redesign changes are captured in visual regression baselines. This fulfills QUAL-02 (ESLint z-index rule enforcement) and QUAL-03 (visual regression tests).

Output: Working pre-commit hook that blocks violations, and expanded visual regression tests for Hero section.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-quality-assurance/32-CONTEXT.md (Husky + lint-staged, visual testing scope)
@.planning/phases/32-quality-assurance/32-RESEARCH.md (Patterns 4-5 for Husky/lint-staged)

Existing visual regression tests:
@e2e/visual-regression.spec.ts

Husky and lint-staged already installed (package.json), just not configured.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Husky and configure lint-staged</name>
  <files>.husky/pre-commit, package.json</files>
  <action>
1. Initialize Husky:
   ```bash
   pnpm exec husky init
   ```
   This creates .husky/ directory with a sample pre-commit hook.

2. Replace .husky/pre-commit content with:
   ```bash
   pnpm lint-staged
   ```

3. Add lint-staged configuration to package.json at the root level:
   ```json
   "lint-staged": {
     "src/**/*.{ts,tsx}": [
       "eslint --max-warnings=0 --no-warn-ignored"
     ],
     "src/**/*.css": [
       "stylelint"
     ]
   }
   ```

4. Verify git hooks path is set correctly:
   ```bash
   git config core.hooksPath
   ```
   Should return `.husky` or be unset (defaults to .git/hooks but husky handles this).

Note: ESLint token rules are already at error level in eslint.config.mjs. The --max-warnings=0 flag ensures even warnings block commits.
  </action>
  <verify>
1. Test hook by staging a file with a token violation (e.g., add `text-white` to a component)
2. Attempt to commit: `git add . && git commit -m "test"`
3. Commit should be blocked with ESLint error about semantic tokens
4. Undo test changes: `git checkout .`
  </verify>
  <done>Pre-commit hook blocks commits with token violations.</done>
</task>

<task type="auto">
  <name>Task 2: Add Hero section visual regression tests</name>
  <files>e2e/visual-regression.spec.ts</files>
  <action>
Add Hero section visual regression tests to e2e/visual-regression.spec.ts.

Add this test describe block (after existing tests):

```typescript
test.describe("Hero Section Visual Regression (Phase 31)", () => {
  test("hero - desktop light mode", async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");
    // Wait for emoji animations to settle
    await page.waitForTimeout(1000);

    const hero = page.locator('[data-testid="hero-section"]');
    if (await hero.isVisible()) {
      await expect(hero).toHaveScreenshot("hero-desktop-light.png", {
        maxDiffPixels: 150,
      });
    } else {
      // Fall back to capturing hero area by position (first viewport height)
      await expect(page).toHaveScreenshot("hero-fullpage-desktop-light.png", {
        clip: { x: 0, y: 0, width: 1280, height: 800 },
        maxDiffPixels: 150,
      });
    }
  });

  test("hero - mobile 375px", async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto("/");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(1000);

    const hero = page.locator('[data-testid="hero-section"]');
    if (await hero.isVisible()) {
      await expect(hero).toHaveScreenshot("hero-mobile-375.png", {
        maxDiffPixels: 150,
      });
    } else {
      await expect(page).toHaveScreenshot("hero-fullpage-mobile-375.png", {
        clip: { x: 0, y: 0, width: 375, height: 667 },
        maxDiffPixels: 150,
      });
    }
  });

  test("hero - desktop dark mode", async ({ page }) => {
    await page.emulateMedia({ colorScheme: "dark" });
    await page.goto("/");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(1000);

    const hero = page.locator('[data-testid="hero-section"]');
    if (await hero.isVisible()) {
      await expect(hero).toHaveScreenshot("hero-desktop-dark.png", {
        maxDiffPixels: 150,
      });
    } else {
      await expect(page).toHaveScreenshot("hero-fullpage-desktop-dark.png", {
        clip: { x: 0, y: 0, width: 1280, height: 800 },
        maxDiffPixels: 150,
      });
    }
  });

  test("hero gradient orbs visible", async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(500);

    // Verify orbs layer exists (not checking exact position due to animation)
    const orbsLayer = page.locator('[class*="orbs"]');
    if (await orbsLayer.first().isVisible()) {
      await expect(orbsLayer.first()).toBeVisible();
    }
  });

  test("hero scroll indicator visible", async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");

    // Scroll indicator should be visible (ChevronDown with bounce animation)
    const scrollIndicator = page.locator('[aria-label*="scroll"], [role="button"]').filter({
      has: page.locator('svg')
    }).last();

    // Just verify something scrollable/clickable exists at bottom of hero
    const heroArea = page.locator('section').first();
    await expect(heroArea).toBeVisible();
  });
});
```

Also ensure Hero section has data-testid="hero-section" if not already present. Check Hero.tsx and add if missing.
  </action>
  <verify>
1. Run `pnpm exec playwright test e2e/visual-regression.spec.ts --grep "Hero Section"`
2. Verify tests pass (may need --update-snapshots first to create baselines)
3. Verify baseline images created in e2e/__snapshots__/ or e2e/visual-regression.spec.ts-snapshots/
  </verify>
  <done>Hero visual regression tests exist and have baseline images.</done>
</task>

<task type="auto">
  <name>Task 3: Update baseline images and verify all visual tests pass</name>
  <files>e2e/visual-regression.spec.ts-snapshots/*</files>
  <action>
1. Generate/update baseline images for Hero tests:
   ```bash
   pnpm exec playwright test e2e/visual-regression.spec.ts --update-snapshots
   ```

2. Run full visual regression suite to verify no regressions:
   ```bash
   pnpm exec playwright test e2e/visual-regression.spec.ts
   ```

3. If any tests fail, investigate:
   - Check if the failure is legitimate (actual regression) or false positive (animation timing)
   - Increase maxDiffPixels if needed for animation-heavy tests
   - Add appropriate waitForTimeout if animations need more settle time

4. Commit baseline images to git (per CONTEXT.md: baselines stored in repo)
  </action>
  <verify>
Run `pnpm exec playwright test e2e/visual-regression.spec.ts` and verify all tests pass.
  </verify>
  <done>All visual regression tests pass with current baselines.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Test pre-commit hook:
   - Create a file with `text-white` violation
   - Stage and attempt commit
   - Should be blocked

2. Visual regression tests:
   - All tests in e2e/visual-regression.spec.ts pass
   - Hero section tests have baselines for light, dark, mobile, desktop

3. Run full verification:
   ```bash
   pnpm lint && pnpm typecheck && pnpm build
   ```
</verification>

<success_criteria>
- .husky/pre-commit exists and runs lint-staged
- lint-staged config in package.json targets src/**/*.{ts,tsx,css}
- Pre-commit hook blocks commits with ESLint errors
- Hero visual regression tests exist with baselines
- All visual regression tests pass
- QUAL-02 satisfied: ESLint rules enforced at commit time
- QUAL-03 satisfied: Visual regression tests cover hero and consolidated components
</success_criteria>

<output>
After completion, create `.planning/phases/32-quality-assurance/32-03-SUMMARY.md`
</output>
