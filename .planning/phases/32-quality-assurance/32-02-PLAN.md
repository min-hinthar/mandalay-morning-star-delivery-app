---
phase: 32-quality-assurance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/contrast-audit.spec.ts
  - .planning/phases/32-quality-assurance/32-CONTRAST-AUDIT.md
autonomous: false

must_haves:
  truths:
    - "WCAG AAA contrast audit runs against all user-facing pages"
    - "All critical contrast violations identified and documented"
    - "Text over gradient backgrounds manually verified"
    - "Both light and dark mode contrast validated"
  artifacts:
    - path: "e2e/contrast-audit.spec.ts"
      provides: "Playwright tests for WCAG AAA (7:1) contrast"
      min_lines: 80
    - path: ".planning/phases/32-quality-assurance/32-CONTRAST-AUDIT.md"
      provides: "Audit results documenting any violations found"
      min_lines: 30
  key_links:
    - from: "e2e/contrast-audit.spec.ts"
      to: "@axe-core/playwright"
      via: "AxeBuilder import"
      pattern: "import.*AxeBuilder.*@axe-core/playwright"
---

<objective>
Run comprehensive WCAG AAA (7:1 contrast ratio) audit on all user-facing pages and fix any violations.

Purpose: Ensure high accessibility standards per CONTEXT.md requirement for WCAG AAA compliance. This fulfills QUAL-01 (theme mode testing) with contrast focus.

Output: Contrast audit test file and documented audit results. Any violations found will be fixed immediately.
</objective>

<execution_context>
@C:\Users\minkk\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minkk\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-quality-assurance/32-CONTEXT.md (WCAG AAA requirement, gradient auditing)

Existing accessibility tests (uses WCAG AA):
@e2e/accessibility.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WCAG AAA contrast audit test suite</name>
  <files>e2e/contrast-audit.spec.ts</files>
  <action>
Create e2e/contrast-audit.spec.ts with comprehensive WCAG AAA contrast testing:

```typescript
import { test, expect } from '@playwright/test';
import AxeBuilder from '@axe-core/playwright';

/**
 * WCAG AAA Contrast Audit (7:1 ratio)
 *
 * Tests all user-facing pages for enhanced contrast compliance.
 * NOTE: axe-core cannot evaluate text over CSS gradients - see manual audit.
 */

// Pages to audit
const PAGES = [
  { name: 'Homepage', path: '/' },
  { name: 'Menu', path: '/menu' },
  { name: 'Cart', path: '/', action: 'openCart' },
  { name: 'Login', path: '/login' },
  { name: 'Checkout', path: '/checkout' },
  { name: 'Tracking', path: '/tracking' },
];

test.describe('WCAG AAA Contrast Audit - Light Mode', () => {
  for (const page of PAGES) {
    test(`${page.name} - light mode contrast (7:1)`, async ({ page: p }) => {
      await p.goto(page.path);
      await p.waitForLoadState('networkidle');

      if (page.action === 'openCart') {
        // Add item and open cart
        const menuItem = p.locator('[data-testid="menu-item"]').first();
        if (await menuItem.isVisible()) {
          await menuItem.click();
          await p.getByRole('button', { name: /add to cart/i }).click();
          await p.keyboard.press('Escape');
          await p.locator('[data-testid="cart-button"]').click();
          await p.waitForTimeout(300);
        }
      }

      const results = await new AxeBuilder({ page: p })
        .withTags(['wcag2aaa'])
        .withRules(['color-contrast-enhanced'])
        .analyze();

      // Log all violations for audit document
      if (results.violations.length > 0) {
        console.log(`\n[${page.name}] Contrast violations:`);
        results.violations.forEach(v => {
          console.log(`  - ${v.id}: ${v.description}`);
          v.nodes.forEach(n => console.log(`    ${n.html}`));
        });
      }

      // Fail on serious/critical violations
      const serious = results.violations.filter(v =>
        v.impact === 'serious' || v.impact === 'critical'
      );
      expect(serious).toHaveLength(0);
    });
  }
});

test.describe('WCAG AAA Contrast Audit - Dark Mode', () => {
  test.beforeEach(async ({ page }) => {
    await page.emulateMedia({ colorScheme: 'dark' });
  });

  for (const page of PAGES) {
    test(`${page.name} - dark mode contrast (7:1)`, async ({ page: p }) => {
      await p.goto(page.path);
      await p.waitForLoadState('networkidle');

      const results = await new AxeBuilder({ page: p })
        .withTags(['wcag2aaa'])
        .withRules(['color-contrast-enhanced'])
        .analyze();

      if (results.violations.length > 0) {
        console.log(`\n[${page.name} - Dark] Contrast violations:`);
        results.violations.forEach(v => {
          console.log(`  - ${v.id}: ${v.description}`);
          v.nodes.forEach(n => console.log(`    ${n.html}`));
        });
      }

      const serious = results.violations.filter(v =>
        v.impact === 'serious' || v.impact === 'critical'
      );
      expect(serious).toHaveLength(0);
    });
  }
});
```

Include tests for:
- Homepage, Menu, Cart, Login, Checkout, Tracking pages
- Both light and dark modes
- Log violations with element HTML for audit document
  </action>
  <verify>
Run `pnpm exec playwright test e2e/contrast-audit.spec.ts` and capture output. Note any failures.
  </verify>
  <done>Contrast audit test suite exists and runs against all pages in both themes.</done>
</task>

<task type="auto">
  <name>Task 2: Run audit and document results</name>
  <files>.planning/phases/32-quality-assurance/32-CONTRAST-AUDIT.md</files>
  <action>
Run the contrast audit tests and create audit document:

1. Run tests: `pnpm exec playwright test e2e/contrast-audit.spec.ts 2>&1 | tee contrast-audit-output.txt`

2. Create 32-CONTRAST-AUDIT.md documenting:
- Date of audit
- Pages tested
- Automated results summary (pass/fail per page)
- List of any violations found with:
  - Page name
  - Element HTML snippet
  - Issue description
  - Suggested fix

3. Manual audit checklist for text over gradients (axe-core cannot check these):
- Hero section headline over gradient background
- Hero CTA button text
- Cart bar text over gradient
- Any badge text over gradient backgrounds

Note: Per CONTEXT.md, gradient text must pass against darkest AND lightest gradient points.
  </action>
  <verify>
Verify 32-CONTRAST-AUDIT.md exists and contains:
- Summary of automated test results
- Manual checklist for gradient backgrounds
- List of violations (if any)
  </verify>
  <done>Audit document exists with comprehensive results.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>WCAG AAA contrast audit covering all user-facing pages in both themes</what-built>
  <how-to-verify>
1. Review 32-CONTRAST-AUDIT.md for any violations found
2. If violations exist:
   - Review each violation
   - Confirm the suggested fix is appropriate
   - Type "fix: [list of files to fix]" to proceed with fixes
3. If no violations: Type "approved - no violations"
4. For gradient text, manually check these in browser:
   - Hero headline text (white over gradient) - readable?
   - Hero CTA button text - readable?
   - Cart bar text - readable?
   Type "gradient check passed" or describe issues found
  </how-to-verify>
  <resume-signal>Type "approved" if no fixes needed, or "fix: [details]" to proceed with fixes</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. e2e/contrast-audit.spec.ts runs without errors
2. 32-CONTRAST-AUDIT.md documents all findings
3. All serious/critical contrast violations either:
   - Pass tests (no violations)
   - Are documented with fix plan
4. Gradient text verified manually
</verification>

<success_criteria>
- Contrast audit tests exist and run
- All pages pass WCAG AAA automated contrast checks OR violations documented
- Manual gradient audit completed
- QUAL-01 requirement satisfied: components tested in both light and dark modes
</success_criteria>

<output>
After completion, create `.planning/phases/32-quality-assurance/32-02-SUMMARY.md`
</output>
