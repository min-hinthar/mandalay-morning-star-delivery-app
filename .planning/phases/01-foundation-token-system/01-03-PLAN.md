---
phase: 01-foundation-token-system
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - eslint.config.mjs
  - .stylelintrc.json
  - package.json
  - docs/STACKING-CONTEXT.md
autonomous: true

must_haves:
  truths:
    - "ESLint errors on z-[number], z-0 through z-100, and inline zIndex: number"
    - "Stylelint errors on z-index: number in CSS files"
    - "Build fails when hardcoded z-index values are present"
    - "Stacking context rules are documented"
  artifacts:
    - path: "eslint.config.mjs"
      provides: "Comprehensive z-index enforcement in JSX"
      contains: "z-index"
    - path: ".stylelintrc.json"
      provides: "Z-index enforcement in CSS files"
      contains: "declaration-use-variable"
    - path: "docs/STACKING-CONTEXT.md"
      provides: "Stacking context rules and isolation boundaries"
      min_lines: 50
  key_links:
    - from: "eslint.config.mjs"
      to: "z-index token system"
      via: "Error messages reference token names"
      pattern: "z-modal|z-dropdown"
    - from: ".stylelintrc.json"
      to: "stylelint-declaration-use-variable"
      via: "Plugin configuration"
      pattern: "sh-waqar/declaration-use-variable"
---

<objective>
Enforce z-index token usage through linting rules and document stacking context patterns.

Purpose: Prevent z-index chaos by failing builds on hardcoded values. Document isolation patterns so developers understand when and how to create new stacking contexts.
Output: Enhanced ESLint rules, Stylelint z-index enforcement, stacking context documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-token-system/01-RESEARCH.md
@.planning/phases/01-foundation-token-system/01-01-SUMMARY.md
@eslint.config.mjs
@.stylelintrc.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance ESLint z-index rules</name>
  <files>eslint.config.mjs</files>
  <action>
Update the existing z-index enforcement rules in eslint.config.mjs to be comprehensive. Current rules only catch `z-[number]` and `z-40/50`. Need to catch ALL hardcoded patterns.

Replace the existing "V4 Design Token Enforcement Rules" section with:

```javascript
{
  // Design Token Enforcement Rules
  files: ["src/components/**/*.tsx", "src/app/**/*.tsx"],
  rules: {
    "no-restricted-syntax": [
      "error", // UPGRADE from "warn" to "error"
      {
        // Catch z-[number] arbitrary values: z-[10], z-[999], etc.
        selector: "Literal[value=/z-\\[\\d+\\]/]",
        message: "Use z-index token (z-modal, z-dropdown, z-sticky, etc.) instead of z-[number]. See docs/STACKING-CONTEXT.md",
      },
      {
        // Catch ALL Tailwind z-* numeric classes: z-0, z-10, z-20, z-30, z-40, z-50, z-auto
        // Negative lookbehind prevents matching our tokens (z-modal, z-dropdown, etc.)
        selector: "Literal[value=/\\bz-(?:0|10|20|30|40|50|60|70|80|90|100|auto)\\b/]",
        message: "Use z-index token (z-modal, z-dropdown, z-sticky, etc.) instead of z-* classes. See docs/STACKING-CONTEXT.md",
      },
      {
        // Catch inline zIndex in style objects: style={{ zIndex: 50 }}
        selector: "Property[key.name='zIndex'][value.type='Literal'][value.raw=/^\\d+$/]",
        message: "Use zIndex token from @/design-system/tokens/z-index (e.g., zIndex.modal) instead of hardcoded number.",
      },
      {
        // Catch hardcoded hex colors in bg-[]
        selector: "Literal[value=/bg-\\[#[0-9a-fA-F]{3,8}\\]/]",
        message: "Use design token colors (e.g., bg-primary) instead of hardcoded hex values.",
      },
      {
        // Catch hardcoded hex colors in text-[]
        selector: "Literal[value=/text-\\[#[0-9a-fA-F]{3,8}\\]/]",
        message: "Use design token colors (e.g., text-primary) instead of hardcoded hex values.",
      },
    ],
  },
},
```

Key changes:
1. Severity upgraded from "warn" to "error" (fails build)
2. Added comprehensive z-* numeric class coverage (z-0 through z-100)
3. Added inline zIndex style object detection
4. Error messages reference documentation
  </action>
  <verify>
Create a test file with `className="z-50"` - ESLint should error.
Create a test file with `style={{ zIndex: 100 }}` - ESLint should error.
`pnpm lint` on clean codebase should pass (no violations yet).
  </verify>
  <done>
ESLint config has comprehensive z-index rules at "error" severity. Rules catch z-[number], z-0 through z-100, and inline zIndex.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Stylelint z-index enforcement</name>
  <files>.stylelintrc.json, package.json</files>
  <action>
First, install the Stylelint plugin:

```bash
pnpm add -D stylelint-declaration-use-variable
```

Then update .stylelintrc.json to enforce z-index uses CSS variables:

```json
{
  "extends": ["stylelint-config-standard"],
  "plugins": ["stylelint-declaration-use-variable"],
  "rules": {
    "sh-waqar/declaration-use-variable": [
      ["/z-index/"],
      {
        "ignoreValues": ["auto", "inherit", "initial", "unset", "-1", "1"]
      }
    ],
    "at-rule-no-unknown": [true, {
      "ignoreAtRules": ["tailwind", "apply", "layer", "config", "theme", "custom-variant", "utility"]
    }],
    "function-no-unknown": [true, {
      "ignoreFunctions": ["theme", "var"]
    }],
    "import-notation": null,
    "color-function-notation": null,
    "color-function-alias-notation": null,
    "alpha-value-notation": null,
    "color-hex-length": null,
    "declaration-block-single-line-max-declarations": null,
    "rule-empty-line-before": null,
    "custom-property-empty-line-before": null,
    "property-no-vendor-prefix": null,
    "length-zero-no-unit": null,
    "no-duplicate-selectors": null,
    "font-family-name-quotes": null,
    "media-feature-range-notation": null,
    "no-descending-specificity": null,
    "declaration-block-no-duplicate-custom-properties": null,
    "value-keyword-case": null,
    "declaration-block-no-redundant-longhand-properties": null
  }
}
```

Key additions:
1. Added "stylelint-declaration-use-variable" plugin
2. Rule enforces z-index MUST use var() - catches `z-index: 50;` but allows `z-index: var(--z-modal);`
3. Ignore values: auto, inherit, initial, unset (valid CSS keywords), -1 and 1 (common exceptions for stacking within component)
  </action>
  <verify>
Create a test CSS file with `z-index: 50;` - `pnpm lint:css` should error.
Create a test CSS file with `z-index: var(--z-modal);` - should pass.
`pnpm lint:css` on existing codebase should pass (tokens.css uses custom properties).
  </verify>
  <done>
Stylelint plugin installed. .stylelintrc.json enforces z-index uses CSS variables. lint:css passes on existing code.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document stacking context rules</name>
  <files>docs/STACKING-CONTEXT.md</files>
  <action>
Create documentation for stacking context patterns and z-index token usage.

```markdown
# Stacking Context Rules

## Overview

This document defines the z-index layer system and stacking context patterns for the Morning Star app. Following these rules prevents z-index conflicts where overlays block clicks or elements appear in wrong order.

## Z-Index Layer System

| Token | Value | Tailwind Class | Use For |
|-------|-------|----------------|---------|
| `--z-base` | 0 | `z-base` | Default stacking, page content |
| `--z-dropdown` | 10 | `z-dropdown` | Dropdown menus, select options |
| `--z-sticky` | 20 | `z-sticky` | Sticky headers, floating buttons |
| `--z-fixed` | 30 | `z-fixed` | Fixed navigation, persistent UI |
| `--z-modal-backdrop` | 40 | `z-modal-backdrop` | Modal/drawer backdrops |
| `--z-modal` | 50 | `z-modal` | Modal dialogs, drawers, sheets |
| `--z-popover` | 60 | `z-popover` | Popovers appearing over modals |
| `--z-tooltip` | 70 | `z-tooltip` | Tooltips (always on top of content) |
| `--z-toast` | 80 | `z-toast` | Toast notifications |
| `--z-max` | 100 | `z-max` | Emergency override (use sparingly) |

## Usage Patterns

### In TailwindCSS (Preferred)

```tsx
// Good - use token classes
<div className="z-modal">Modal content</div>
<header className="z-sticky">Sticky header</header>

// Bad - hardcoded values (ESLint will error)
<div className="z-50">Modal content</div>
<div className="z-[999]">Bad idea</div>
```

### In Inline Styles

```tsx
import { zIndex, zIndexVar } from "@/design-system/tokens/z-index";

// Good - use constants
<div style={{ zIndex: zIndex.modal }}>Using number</div>
<div style={{ zIndex: zIndexVar.modal }}>Using CSS var</div>

// Bad - hardcoded values (ESLint will error)
<div style={{ zIndex: 50 }}>Bad</div>
```

### In CSS Files

```css
/* Good - use CSS variables */
.modal {
  z-index: var(--z-modal);
}

/* Bad - hardcoded values (Stylelint will error) */
.modal {
  z-index: 50;
}
```

## Stacking Context Isolation

A new stacking context is created when an element has:
- `position: relative/absolute/fixed/sticky` with `z-index` other than auto
- `opacity` less than 1
- `transform`, `filter`, `backdrop-filter`, `perspective`
- `isolation: isolate`
- `will-change` with values that create stacking context
- `contain: paint/layout/content/strict`

### Isolation Boundaries

Create isolation boundaries to contain z-index scope:

```tsx
// Isolation boundary - z-index values inside don't leak out
<div className="isolate">
  <div className="z-10">Safe inside boundary</div>
</div>
```

### When to Create Isolation

1. **Component boundaries** - Complex components with internal layering
2. **Card content** - Image overlays, badges on cards
3. **Before transforms** - Elements with hover transforms
4. **Portals entry points** - Where portal content mounts

### Common Patterns

#### Sticky Header

```tsx
<header className="sticky top-0 z-sticky">
  {/* Header content at z-20 */}
</header>
```

#### Modal with Backdrop

```tsx
<div className="fixed inset-0 z-modal-backdrop bg-black/50" />
<div className="fixed z-modal">
  {/* Modal content at z-50, above backdrop at z-40 */}
</div>
```

#### Dropdown in Header

```tsx
<header className="z-sticky">
  <div className="relative">
    <button>Menu</button>
    {/* Dropdown needs to escape header's stacking context */}
    <Portal>
      <div className="z-dropdown">Dropdown content</div>
    </Portal>
  </div>
</header>
```

## Troubleshooting

### Element Behind Another

1. Check if parent has transform/filter/opacity (creates stacking context)
2. Verify element uses correct z-index token
3. Consider if element needs to be in a portal

### Overlay Not Blocking Clicks

1. Verify backdrop has `pointer-events-auto`
2. Check z-index is higher than content being blocked
3. Ensure no `pointer-events-none` on parent

### Click Events Not Reaching Element

1. Check for invisible overlays with high z-index
2. Look for `pointer-events-none` on ancestors
3. Verify closed overlays are removed from DOM (not just hidden)

## Exceptions

The following z-index values are allowed without tokens:

- `z-index: auto` - Reset to default stacking
- `z-index: -1` - Place behind siblings (rare, document usage)
- `z-index: 1` - Slight elevation within isolated component

Document any exceptions with a comment explaining why.

## Related Files

- `src/styles/tokens.css` - CSS custom property definitions
- `src/design-system/tokens/z-index.ts` - TypeScript constants
- `src/app/globals.css` - TailwindCSS @theme integration
- `eslint.config.mjs` - JSX enforcement rules
- `.stylelintrc.json` - CSS enforcement rules
```
  </action>
  <verify>
File exists at docs/STACKING-CONTEXT.md.
Contains token table, usage examples, isolation patterns, troubleshooting.
  </verify>
  <done>
Documentation file created with comprehensive stacking context rules, examples, and troubleshooting guide.
  </done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes on clean codebase
2. `pnpm lint:css` passes on clean codebase
3. Test file with `z-50` class - ESLint errors
4. Test CSS with `z-index: 50` - Stylelint errors
5. docs/STACKING-CONTEXT.md exists and is comprehensive
</verification>

<success_criteria>
- ESLint catches all hardcoded z-index patterns in JSX at error severity
- Stylelint catches hardcoded z-index in CSS files
- Build fails when violations present (`pnpm lint && pnpm lint:css` in build)
- Stacking context documentation provides clear guidance
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-token-system/01-03-SUMMARY.md`
</output>
