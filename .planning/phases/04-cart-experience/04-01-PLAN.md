---
phase: 04-cart-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui-v8/cart/CartButtonV8.tsx
  - src/lib/stores/cart-animation-store.ts
  - src/components/ui-v8/cart/index.ts
autonomous: true

must_haves:
  truths:
    - "Cart button appears in header with item count badge"
    - "Badge animates (pulse) when cart count changes"
    - "Clicking cart button opens cart drawer"
    - "Badge ref is accessible for fly-to-cart animation target"
  artifacts:
    - path: "src/components/ui-v8/cart/CartButtonV8.tsx"
      provides: "V8 cart button with animated badge"
      exports: ["CartButtonV8"]
    - path: "src/lib/stores/cart-animation-store.ts"
      provides: "Zustand store for cart animation coordination (badge ref)"
      exports: ["useCartAnimationStore"]
    - path: "src/components/ui-v8/cart/index.ts"
      provides: "Barrel export for V8 cart components"
      exports: ["CartButtonV8"]
  key_links:
    - from: "src/components/ui-v8/cart/CartButtonV8.tsx"
      to: "useCartDrawer"
      via: "open() on click"
      pattern: "useCartDrawer.*open"
    - from: "src/components/ui-v8/cart/CartButtonV8.tsx"
      to: "useCart"
      via: "itemCount for badge"
      pattern: "useCart.*itemCount"
    - from: "src/components/ui-v8/cart/CartButtonV8.tsx"
      to: "useCartAnimationStore"
      via: "setBadgeRef on mount"
      pattern: "useCartAnimationStore.*setBadgeRef"
---

<objective>
Create V8 cart button with animated badge for header integration

Purpose: Provide accessible cart entry point with visual feedback on cart changes, and expose badge ref for fly-to-cart celebration animation target.

Output:
- CartButtonV8 component with animated badge
- Cart animation store for badge ref coordination
- Barrel exports for V8 cart components
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-cart-experience/04-RESEARCH.md

@src/components/cart/cart-button.tsx (reference existing implementation)
@src/lib/hooks/useCart.ts
@src/lib/hooks/useCartDrawer.ts
@src/lib/animations/cart.ts (badgeVariants, badgePop)
@src/components/ui-v8/navigation/Header.tsx (rightContent prop)
@src/components/ui-v8/navigation/AppShell.tsx (headerSlot prop)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cart animation store for badge ref</name>
  <files>src/lib/stores/cart-animation-store.ts</files>
  <action>
Create Zustand store for cart animation coordination:

```typescript
import { create } from "zustand";
import type { RefObject } from "react";

interface CartAnimationStore {
  badgeRef: RefObject<HTMLSpanElement> | null;
  setBadgeRef: (ref: RefObject<HTMLSpanElement> | null) => void;
  isAnimating: boolean;
  setIsAnimating: (isAnimating: boolean) => void;
}

export const useCartAnimationStore = create<CartAnimationStore>((set) => ({
  badgeRef: null,
  setBadgeRef: (ref) => set({ badgeRef: ref }),
  isAnimating: false,
  setIsAnimating: (isAnimating) => set({ isAnimating }),
}));
```

This store coordinates the fly-to-cart animation by:
- Storing the badge element ref as animation target
- Tracking animation state to prevent overlapping animations
  </action>
  <verify>TypeScript compiles: `pnpm typecheck`</verify>
  <done>Cart animation store exists with badgeRef and isAnimating state</done>
</task>

<task type="auto">
  <name>Task 2: Create CartButtonV8 component</name>
  <files>src/components/ui-v8/cart/CartButtonV8.tsx, src/components/ui-v8/cart/index.ts</files>
  <action>
Create CartButtonV8 with these features:

1. **Badge with ref registration:**
   - useRef for badge span element
   - useEffect to register ref with useCartAnimationStore on mount
   - Cleanup ref on unmount

2. **Badge animation:**
   - Use badgeVariants from cart.ts for enter/exit
   - Track itemCount changes to trigger pulse animation
   - Use useAnimationPreference for reduced motion support

3. **Integration points:**
   - useCart for itemCount
   - useCartDrawer for open()
   - Use V8 design tokens (zIndex, colors)
   - Proper aria-label with item count

4. **Styling:**
   - Match existing cart-button.tsx styling but use V8 color tokens
   - 44x44 touch target minimum
   - Focus visible ring
   - Badge positioned absolute top-right with ring-2 ring-background

5. **Hydration safety:**
   - Use mounted state to avoid hydration mismatch (cart persists to localStorage)
   - Return skeleton/placeholder before mounted

Create barrel export in index.ts:
```typescript
export { CartButtonV8 } from "./CartButtonV8";
```
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
  </verify>
  <done>
- CartButtonV8 renders cart icon with badge showing item count
- Badge pulses when count changes
- Badge ref registered in cart animation store
- Component handles hydration safely
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration with AppShell</name>
  <files>none (verification only)</files>
  <action>
Create a test scenario to verify CartButtonV8 works with AppShell:

1. Check that CartButtonV8 can be passed to AppShell headerSlot:
   ```tsx
   <AppShell headerSlot={<CartButtonV8 />}>
     {children}
   </AppShell>
   ```

2. Verify the component tree works:
   - CartButtonV8 imports compile
   - Props are compatible with headerSlot (ReactNode)
   - No circular dependencies

3. Run full verification:
   ```bash
   pnpm lint && pnpm typecheck && pnpm build
   ```
  </action>
  <verify>`pnpm lint && pnpm typecheck && pnpm build` all pass</verify>
  <done>CartButtonV8 is ready for use in AppShell headerSlot</done>
</task>

</tasks>

<verification>
1. CartButtonV8 component exists and exports correctly
2. Cart animation store created with badgeRef state
3. Badge shows item count from useCart
4. Badge animates on count change (pulse effect)
5. Click opens cart drawer via useCartDrawer.open()
6. All lint, typecheck, build pass
</verification>

<success_criteria>
- CartButtonV8 renders in isolation without errors
- Badge ref is registered in useCartAnimationStore on mount
- Badge pulses when itemCount changes (verifiable via React DevTools or visual inspection)
- Component is hydration-safe (no console warnings about mismatches)
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-cart-experience/04-01-SUMMARY.md`
</output>
