---
phase: 04-cart-experience
plan: 05
type: execute
wave: 3
depends_on: ["04-01", "04-02", "04-03", "04-04"]
files_modified:
  - src/app/providers.tsx
  - src/components/layout/HeaderClient.tsx
  - src/components/ui-v8/cart/CartDrawerV8.tsx
autonomous: true
gap_closure: true

deferred:
  - requirement: "CART-05"
    reason: "AddToCartButton and FlyToCart belong on menu item cards, not cart drawer. Integration deferred to Phase 5 (Menu Browsing) where menu item components are built."
    components:
      - "src/components/ui-v8/cart/AddToCartButton.tsx"
      - "src/components/ui-v8/cart/FlyToCart.tsx"

must_haves:
  truths:
    - "Cart drawer opens as V8 BottomSheet on mobile"
    - "Cart drawer opens as V8 Drawer on desktop"
    - "Cart button in header shows animated badge with item count"
    - "Clear cart button in drawer triggers confirmation modal"
    - "Confirming clear removes all items from cart"
    - "Cart items display with swipe-to-delete gesture on mobile"
    - "Quantity controls show animated number transitions"
    - "Subtotal and free delivery progress display in cart footer"
    - "Empty cart shows friendly state with browse menu CTA"
  artifacts:
    - path: "src/app/providers.tsx"
      provides: "V8 CartDrawer integration"
      contains: "CartDrawerV8"
    - path: "src/components/layout/HeaderClient.tsx"
      provides: "V8 CartButton integration"
      contains: "CartButtonV8"
    - path: "src/components/ui-v8/cart/CartDrawerV8.tsx"
      provides: "Clear cart confirmation integration"
      contains: "ClearCartConfirmation"
  key_links:
    - from: "src/app/providers.tsx"
      to: "@/components/ui-v8/cart"
      via: "import CartDrawerV8"
      pattern: "import.*CartDrawerV8.*from.*ui-v8/cart"
    - from: "src/components/layout/HeaderClient.tsx"
      to: "@/components/ui-v8/cart"
      via: "import CartButtonV8"
      pattern: "import.*CartButtonV8.*from.*ui-v8/cart"
    - from: "src/components/ui-v8/cart/CartDrawerV8.tsx"
      to: "ClearCartConfirmation"
      via: "import and render"
      pattern: "useClearCartConfirmation"
---

<objective>
Integrate V8 cart components into the app, replacing V7 implementations

Purpose: Phase 4 created all V8 cart components but none were integrated. This gap closure plan connects CartDrawerV8, CartButtonV8, and ClearCartConfirmation to the live app.
Output: Users see the V8 cart experience with animations and swipe gestures
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cart-experience/04-VERIFICATION.md
@.planning/phases/04-cart-experience/04-03-SUMMARY.md
@src/app/providers.tsx
@src/components/layout/HeaderClient.tsx
@src/components/ui-v8/cart/index.ts
@src/components/ui-v8/cart/CartDrawerV8.tsx
@src/components/ui-v8/cart/CartButtonV8.tsx
@src/components/ui-v8/cart/ClearCartConfirmation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace V7 CartDrawer with CartDrawerV8 in providers.tsx</name>
  <files>src/app/providers.tsx</files>
  <action>
Update the import statement on line 6:
- Remove: `import { CartDrawer } from "@/components/cart/v7-index";`
- Add: `import { CartDrawerV8 } from "@/components/ui-v8/cart";`

Update the JSX on line 27:
- Replace: `<CartDrawer />`
- With: `<CartDrawerV8 />`

CartDrawerV8 uses the same hooks (useCart, useCartDrawer) so no prop changes needed.
  </action>
  <verify>
Run `pnpm typecheck` - no errors in providers.tsx
  </verify>
  <done>
providers.tsx imports and renders CartDrawerV8 instead of V7 CartDrawer
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate CartButtonV8 into HeaderClient.tsx</name>
  <files>src/components/layout/HeaderClient.tsx</files>
  <action>
Add import at top of file:
```typescript
import { CartButtonV8 } from "@/components/ui-v8/cart";
```

Update the rightContent prop in Header (around line 83-88):
- Current rightContent only has ThemeToggle and UserMenu
- Add CartButtonV8 BEFORE ThemeToggle in the flex container

Update the rightContent JSX:
```tsx
rightContent={
  <div className="flex items-center gap-2">
    <CartButtonV8 />
    <ThemeToggle />
    <UserMenu user={user} />
  </div>
}
```

Remove the cartCount and onCartClick props from Header component (lines 78-79):
- Delete: `cartCount={itemCount}`
- Delete: `onCartClick={openCart}`

The useCart and useCartDrawer imports can remain (MobileNav might use them), or remove if unused after this change.
  </action>
  <verify>
Run `pnpm typecheck` - no errors in HeaderClient.tsx
  </verify>
  <done>
HeaderClient.tsx renders CartButtonV8 in header's rightContent, V7 cart button props removed
  </done>
</task>

<task type="auto">
  <name>Task 3: Add ClearCartConfirmation to CartDrawerV8</name>
  <files>src/components/ui-v8/cart/CartDrawerV8.tsx</files>
  <action>
**Step 1: Add imports (lines 19-31)**
After line 19 (existing Lucide import `import { ShoppingBag, X } from "lucide-react";`):
- Change to: `import { ShoppingBag, X, Trash2 } from "lucide-react";`

After line 31 (after `import { CartEmptyState } from "./CartEmptyState";`), add:
```typescript
import { ClearCartConfirmation, useClearCartConfirmation } from "./ClearCartConfirmation";
```

**Step 2: Extend CartHeaderProps interface (lines 46-49)**
Replace the existing interface:
```typescript
interface CartHeaderProps {
  itemCount: number;
  onClose: () => void;
}
```
With:
```typescript
interface CartHeaderProps {
  itemCount: number;
  onClose: () => void;
  onClearClick: () => void;
  showClear: boolean;
}
```

**Step 3: Update CartHeader function signature (line 51)**
Replace:
```typescript
function CartHeader({ itemCount, onClose }: CartHeaderProps) {
```
With:
```typescript
function CartHeader({ itemCount, onClose, onClearClick, showClear }: CartHeaderProps) {
```

**Step 4: Add clear cart button in CartHeader (insert before line 105)**
After the closing `</h2>` tag (line 103) and before the `{/* Close button */}` comment (line 105), insert:
```tsx
      {/* Clear cart button */}
      {showClear && (
        <motion.button
          type="button"
          onClick={onClearClick}
          whileHover={shouldAnimate ? { scale: 1.05 } : undefined}
          whileTap={shouldAnimate ? { scale: 0.95 } : undefined}
          transition={getSpring(spring.snappy)}
          className={cn(
            "flex h-10 w-10 items-center justify-center rounded-full",
            "bg-red-100 dark:bg-red-900/30 text-red-500 dark:text-red-400",
            "hover:bg-red-200 dark:hover:bg-red-900/50",
            "transition-colors duration-150",
            "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2"
          )}
          aria-label="Clear cart"
        >
          <Trash2 className="h-5 w-5" />
        </motion.button>
      )}
```

**Step 5: Update CartContent function (lines 231-254)**
Replace the entire CartContent function with:
```tsx
function CartContent({ onClose }: CartContentProps) {
  const router = useRouter();
  const { isEmpty, itemCount } = useCart();
  const {
    isOpen: isClearOpen,
    openConfirmation,
    handleConfirm: handleClearConfirm,
    close: closeClear,
  } = useClearCartConfirmation();

  const handleCheckout = useCallback(() => {
    onClose();
    router.push("/checkout");
  }, [onClose, router]);

  return (
    <div className="flex flex-col h-full">
      <CartHeader
        itemCount={itemCount}
        onClose={onClose}
        onClearClick={openConfirmation}
        showClear={!isEmpty}
      />

      {isEmpty ? (
        <CartEmptyState onClose={onClose} />
      ) : (
        <>
          <CartItemsList onClose={onClose} />
          <CartFooter onClose={onClose} onCheckout={handleCheckout} />
        </>
      )}

      {/* Clear cart confirmation modal */}
      <ClearCartConfirmation
        isOpen={isClearOpen}
        onClose={closeClear}
        onConfirm={handleClearConfirm}
        itemCount={itemCount}
      />
    </div>
  );
}
```
  </action>
  <verify>
Run `pnpm typecheck` - no errors in CartDrawerV8.tsx
Run `pnpm build` - successful build
  </verify>
  <done>
CartDrawerV8 has clear cart button in header that triggers ClearCartConfirmation modal
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `pnpm typecheck` passes with no errors
2. `pnpm build` completes successfully
3. Manual test: Open cart drawer on mobile - should see V8 BottomSheet with swipe-to-dismiss
4. Manual test: Open cart drawer on desktop - should see V8 Drawer from right
5. Manual test: Cart badge in header animates when items added
6. Manual test: Trash icon in cart header opens confirmation modal
7. Manual test: Confirming "Clear Cart" removes all items
8. Manual test: Cart items have swipe-to-delete gesture (mobile)
9. Manual test: Quantity +/- shows animated number transitions
10. Manual test: Cart footer shows subtotal and free delivery progress bar
11. Manual test: Empty cart shows friendly message with "Browse Menu" button
</verification>

<success_criteria>
- V7 CartDrawer replaced with CartDrawerV8 in providers.tsx
- V8 CartButtonV8 renders in header with animated badge
- Clear cart button visible in drawer header when cart has items
- ClearCartConfirmation modal appears when clear button clicked
- Swipe-to-delete works on cart items (mobile)
- Quantity controls animate number changes
- Free delivery progress displays in footer
- Empty state shows browse menu CTA
- All type checks pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-cart-experience/04-05-SUMMARY.md`
</output>
