---
phase: 04-cart-experience
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/ui-v8/cart/FlyToCart.tsx
  - src/components/ui-v8/cart/AddToCartButton.tsx
  - src/components/ui-v8/cart/ClearCartConfirmation.tsx
  - src/lib/stores/cart-animation-store.ts
  - src/components/ui-v8/cart/index.ts
autonomous: true

must_haves:
  truths:
    - "Add-to-cart triggers fly animation from source to cart badge"
    - "Cart badge pulses after fly animation completes"
    - "Clear cart shows confirmation modal before clearing"
    - "Confirming clear cart empties the cart"
    - "Animation respects reduced motion preference"
  artifacts:
    - path: "src/components/ui-v8/cart/FlyToCart.tsx"
      provides: "GSAP Flip fly-to-cart celebration animation"
      exports: ["FlyToCart", "useFlyToCart"]
    - path: "src/components/ui-v8/cart/AddToCartButton.tsx"
      provides: "Add-to-cart button with celebration trigger"
      exports: ["AddToCartButton"]
    - path: "src/components/ui-v8/cart/ClearCartConfirmation.tsx"
      provides: "Clear cart confirmation modal"
      exports: ["ClearCartConfirmation"]
  key_links:
    - from: "src/components/ui-v8/cart/FlyToCart.tsx"
      to: "useCartAnimationStore"
      via: "badgeRef target"
      pattern: "useCartAnimationStore.*badgeRef"
    - from: "src/components/ui-v8/cart/FlyToCart.tsx"
      to: "GSAP Flip"
      via: "fly animation"
      pattern: "Flip\\.(getState|from)"
    - from: "src/components/ui-v8/cart/ClearCartConfirmation.tsx"
      to: "Modal"
      via: "confirmation dialog"
      pattern: "Modal.*isOpen"
    - from: "src/components/ui-v8/cart/ClearCartConfirmation.tsx"
      to: "useCart"
      via: "clearCart action"
      pattern: "useCart.*clearCart"
---

<objective>
Create celebration animations and clear cart confirmation for delightful cart interactions

Purpose: Deliver the "over-the-top animated" experience with fly-to-cart celebration that makes adding items feel rewarding, and safe clear cart flow that prevents accidental data loss.

Output:
- FlyToCart animation using GSAP Flip
- AddToCartButton with integrated celebration
- ClearCartConfirmation modal
- Covers requirements: CART-04, CART-05
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-cart-experience/04-RESEARCH.md
@.planning/phases/04-cart-experience/04-01-SUMMARY.md

@src/lib/gsap/index.ts (gsap, Flip, useGSAP)
@src/lib/stores/cart-animation-store.ts (from 04-01)
@src/lib/animations/cart.ts (calculateFlyToCartPath, badgePop)
@src/components/ui-v8/Modal.tsx (V8 modal primitive)
@src/lib/hooks/useCart.ts (addItem, clearCart)
@src/lib/hooks/useAnimationPreference.ts
@src/design-system/tokens/z-index.ts (zIndex.popover for flying element)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FlyToCart animation component and hook</name>
  <files>src/components/ui-v8/cart/FlyToCart.tsx, src/lib/stores/cart-animation-store.ts</files>
  <action>
Create the fly-to-cart celebration animation:

1. **Update cart-animation-store.ts:**
   Add fields for fly animation:
   ```typescript
   // Add to existing store
   flyingElement: HTMLElement | null;
   setFlyingElement: (el: HTMLElement | null) => void;
   triggerBadgePulse: () => void;
   shouldPulseBadge: boolean;
   ```

2. **useFlyToCart hook:**
   ```typescript
   export function useFlyToCart() {
     const { badgeRef, isAnimating, setIsAnimating } = useCartAnimationStore();
     const { shouldAnimate } = useAnimationPreference();

     const fly = useCallback((sourceElement: HTMLElement) => {
       if (!shouldAnimate || !badgeRef?.current || isAnimating) {
         return; // Skip animation, just add item
       }

       setIsAnimating(true);
       // GSAP Flip animation logic
     }, [badgeRef, isAnimating, setIsAnimating, shouldAnimate]);

     return { fly, isAnimating };
   }
   ```

3. **GSAP Flip animation sequence:**
   - Clone source element (or create thumbnail representation)
   - Get initial state with Flip.getState
   - Position clone at source location
   - Animate to badge position using Flip.from with:
     - duration: 0.5
     - ease: "power2.inOut"
     - scale: shrink from 1 to 0.3
     - Add arc via custom y values (calculate midpoint above)
   - On complete:
     - Remove clone
     - Trigger badge pulse
     - Set isAnimating false

4. **FlyToCart container component:**
   - Renders Portal for flying element
   - Absolute positioning with z-index.popover
   - Manages flying element lifecycle

5. **Important patterns:**
   - Import gsap from "@/lib/gsap" (never direct)
   - Use useGSAP for proper cleanup
   - Respect useAnimationPreference
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>FlyToCart animation works with GSAP Flip, triggers badge pulse on complete</done>
</task>

<task type="auto">
  <name>Task 2: Create AddToCartButton component</name>
  <files>src/components/ui-v8/cart/AddToCartButton.tsx</files>
  <action>
Create AddToCartButton that integrates fly animation:

1. **Props interface:**
   ```typescript
   interface AddToCartButtonProps {
     item: {
       id: string;
       name: string;
       price: number;
       image?: string;
     };
     quantity?: number;
     modifiers?: CartModifier[];
     onAdd?: () => void;
     className?: string;
     children?: ReactNode; // Custom button content
   }
   ```

2. **Integration with fly animation:**
   - Ref to button element (source for animation)
   - On click:
     1. Call useFlyToCart().fly(buttonRef.current)
     2. Call useCart().addItem(item)
     3. Call onAdd callback if provided

3. **Button states:**
   - idle: normal appearance
   - loading: brief disabled state during animation
   - success: flash green (jade) color

4. **Visual feedback:**
   - Use addToCartButton variants from cart.ts
   - Scale pulse on success
   - Color flash to jade

5. **Accessibility:**
   - aria-label: "Add {item.name} to cart"
   - disabled during animation

6. **Fallback:**
   - If reduced motion, skip fly animation
   - Still add item and show success state
  </action>
  <verify>`pnpm typecheck && pnpm lint` passes</verify>
  <done>AddToCartButton triggers fly animation and adds item to cart</done>
</task>

<task type="auto">
  <name>Task 3: Create ClearCartConfirmation modal</name>
  <files>src/components/ui-v8/cart/ClearCartConfirmation.tsx, src/components/ui-v8/cart/index.ts</files>
  <action>
Create confirmation modal for clear cart action:

1. **Component structure:**
   ```typescript
   interface ClearCartConfirmationProps {
     isOpen: boolean;
     onClose: () => void;
     onConfirm: () => void;
   }
   ```

2. **Modal content:**
   - Warning icon (AlertTriangle from lucide)
   - Title: "Clear your cart?"
   - Message: "This will remove all {itemCount} items from your cart."
   - Cancel button (outline, calls onClose)
   - Confirm button (destructive red, calls onConfirm then onClose)

3. **Use V8 Modal primitive:**
   ```typescript
   <Modal isOpen={isOpen} onClose={onClose}>
     <ModalContent />
   </Modal>
   ```

4. **Animation:**
   - Modal handles entrance/exit
   - Buttons have hover/tap animations

5. **Integration helper (optional):**
   ```typescript
   export function useClearCartConfirmation() {
     const [isOpen, setIsOpen] = useState(false);
     const { clearCart, itemCount } = useCart();

     const openConfirmation = () => setIsOpen(true);
     const handleConfirm = () => {
       clearCart();
       setIsOpen(false);
     };

     return { isOpen, openConfirmation, handleConfirm, close: () => setIsOpen(false) };
   }
   ```

**Update barrel exports:**
```typescript
export { CartButtonV8 } from "./CartButtonV8";
export { CartItemV8 } from "./CartItemV8";
export { QuantitySelector } from "./QuantitySelector";
export { CartDrawerV8 } from "./CartDrawerV8";
export { CartSummary } from "./CartSummary";
export { CartEmptyState } from "./CartEmptyState";
export { FlyToCart, useFlyToCart } from "./FlyToCart";
export { AddToCartButton } from "./AddToCartButton";
export { ClearCartConfirmation, useClearCartConfirmation } from "./ClearCartConfirmation";
```

Run full verification:
```bash
pnpm lint && pnpm typecheck && pnpm build
```
  </action>
  <verify>`pnpm lint && pnpm typecheck && pnpm build` all pass</verify>
  <done>ClearCartConfirmation modal prevents accidental cart clearing, all exports complete</done>
</task>

</tasks>

<verification>
1. FlyToCart animates element from source to badge
2. Badge pulses after fly animation completes
3. AddToCartButton integrates fly animation on click
4. ClearCartConfirmation shows before clearing cart
5. Confirming clears cart and closes modal
6. Animations respect reduced motion preference
7. All lint, typecheck, build pass
</verification>

<success_criteria>
- Fly-to-cart animation visible (element moves in arc to badge)
- Badge pulses after animation
- Animation skipped gracefully with prefers-reduced-motion
- Clear cart requires explicit confirmation
- All V8 cart components export correctly
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-cart-experience/04-04-SUMMARY.md`
</output>
