---
phase: 05-menu-browsing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui-v8/menu/ItemDetailSheetV8.tsx
autonomous: true

must_haves:
  truths:
    - "Item detail opens as BottomSheet on mobile (<640px)"
    - "Item detail opens as Modal on desktop (>=640px)"
    - "User can add item to cart from detail view"
    - "Modifiers and quantity selection work"
  artifacts:
    - path: "src/components/ui-v8/menu/ItemDetailSheetV8.tsx"
      provides: "Responsive item detail overlay using Phase 2 components"
      exports: ["ItemDetailSheetV8"]
  key_links:
    - from: "ItemDetailSheetV8.tsx"
      to: "Modal (Phase 2)"
      via: "import"
      pattern: "import.*Modal.*from.*ui-v8/Modal"
    - from: "ItemDetailSheetV8.tsx"
      to: "BottomSheet (Phase 2)"
      via: "import"
      pattern: "import.*BottomSheet.*from.*ui-v8/BottomSheet"
    - from: "ItemDetailSheetV8.tsx"
      to: "AddToCartButton (Phase 4)"
      via: "import"
      pattern: "import.*AddToCartButton.*from.*cart/AddToCartButton"
---

<objective>
Build V8 item detail sheet that displays full item information with modifiers and add-to-cart functionality, using Phase 2 Modal/BottomSheet overlays.

Purpose: MENU-03 requirement - item detail modal/sheet
Output: ItemDetailSheetV8 component using Phase 2 overlay infrastructure
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-menu-browsing/05-RESEARCH.md

@src/components/ui-v8/Modal.tsx
@src/components/ui-v8/BottomSheet.tsx
@src/components/ui-v8/cart/AddToCartButton.tsx
@src/components/menu/item-detail-modal.tsx
@src/components/menu/modifier-group.tsx
@src/components/menu/quantity-selector.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ItemDetailSheetV8 component</name>
  <files>src/components/ui-v8/menu/ItemDetailSheetV8.tsx</files>
  <action>
Create ItemDetailSheetV8 using Phase 2 Modal/BottomSheet:

1. Props interface:
   ```tsx
   interface ItemDetailSheetV8Props {
     item: MenuItem | null;
     isOpen: boolean;
     onClose: () => void;
     onAddToCart?: (item: MenuItem, modifiers: SelectedModifier[], quantity: number, notes: string) => void;
     /** Amount needed for free delivery (in cents) */
     freeDeliveryThreshold?: number;
     /** Current cart subtotal (in cents) */
     cartSubtotal?: number;
   }
   ```

2. Responsive overlay selection:
   ```tsx
   const isMobile = useMediaQuery("(max-width: 640px)");
   const Overlay = isMobile ? BottomSheet : Modal;
   ```

3. State management (same pattern as V3 item-detail-modal):
   - selectedModifiers: SelectedModifier[]
   - quantity: number (default 1)
   - notes: string
   - Reset state when item changes

4. Price calculation using existing utilities:
   ```tsx
   const priceCalc = useMemo(() => {
     if (!item) return null;
     return calculateItemPrice(item, selectedModifiers, quantity);
   }, [item, selectedModifiers, quantity]);
   ```

5. Validation using existing utilities:
   ```tsx
   const validation = useMemo(() => {
     if (!item) return { isValid: false, errors: [] };
     return validateModifierSelection(item, selectedModifiers);
   }, [item, selectedModifiers]);
   ```

6. Content structure:
   ```tsx
   <Overlay
     isOpen={isOpen && item !== null}
     onClose={onClose}
     title={item?.nameEn ?? "Item Detail"}
   >
     {item && (
       <div className="flex flex-col h-full">
         {/* Hero Image */}
         <div className="relative aspect-video shrink-0">
           {item.imageUrl ? (
             <BlurImage src={item.imageUrl} alt={item.nameEn} priority />
           ) : (
             <EmojiPlaceholder categorySlug={item.categorySlug} />
           )}
           {item.isSoldOut && (
             <div className="absolute inset-0 flex items-center justify-center bg-black/60">
               <Badge>Sold Out</Badge>
             </div>
           )}
         </div>

         {/* Scrollable Content */}
         <div className="flex-1 overflow-y-auto p-4 space-y-4">
           {/* Header */}
           <div>
             <h2 className="font-display text-2xl font-bold text-text-primary">
               {item.nameEn}
             </h2>
             {item.nameMy && (
               <p className="font-burmese text-text-muted">{item.nameMy}</p>
             )}
             <p className="font-display text-2xl font-bold text-primary">
               {formatPrice(item.basePriceCents)}
             </p>
           </div>

           {/* Description */}
           {item.descriptionEn && (
             <p className="text-text-secondary">{item.descriptionEn}</p>
           )}

           {/* Allergen Warning */}
           {item.allergens?.length > 0 && (
             <AllergenWarning allergens={item.allergens} />
           )}

           {/* Modifier Groups */}
           {item.modifierGroups?.map((group) => (
             <ModifierGroup
               key={group.id}
               group={group}
               selectedOptions={selectedModifiers
                 .filter((m) => m.groupId === group.id)
                 .map((m) => m.optionId)}
               onSelect={handleModifierSelect}
               onDeselect={handleModifierDeselect}
             />
           ))}

           {/* Special Instructions */}
           <div className="space-y-2">
             <Label>Special Instructions (Optional)</Label>
             <Textarea
               value={notes}
               onChange={(e) => setNotes(e.target.value.slice(0, 500))}
               placeholder="Any special requests..."
               rows={3}
             />
           </div>

           {/* Quantity */}
           <div className="flex items-center justify-between">
             <Label>Quantity</Label>
             <QuantitySelector
               value={quantity}
               onChange={setQuantity}
               disabled={item.isSoldOut}
             />
           </div>
         </div>

         {/* Footer with Add to Cart */}
         <div className="shrink-0 border-t border-border p-4 safe-area-inset-bottom">
           {/* Free delivery incentive if applicable */}
           {!validation.isValid && validation.errors[0] && (
             <p className="mb-2 text-sm text-status-error">{validation.errors[0]}</p>
           )}
           <AddToCartButton
             item={{
               menuItemId: item.id,
               menuItemSlug: item.slug,
               nameEn: item.nameEn,
               nameMy: item.nameMy,
               imageUrl: item.imageUrl,
               basePriceCents: priceCalc?.totalCents ?? item.basePriceCents,
               modifiers: selectedModifiers,
               quantity,
               notes: notes.trim(),
             }}
             disabled={item.isSoldOut || !validation.isValid}
             onAdd={handleAddToCart}
             label={`Add to Cart - ${formatPrice(priceCalc?.totalCents ?? 0)}`}
           />
         </div>
       </div>
     )}
   </Overlay>
   ```

7. Handler functions:
   - handleModifierSelect: Add/replace modifier based on selectionType
   - handleModifierDeselect: Remove modifier
   - handleAddToCart: Call onAddToCart then onClose

8. Use existing components:
   - ModifierGroup from @/components/menu/modifier-group (reuse V6)
   - QuantitySelector from @/components/menu/quantity-selector (reuse V6) OR use V8 cart QuantitySelector
   - BlurImage from this plan (05-02 creates it, but if running parallel, include inline)
   - formatPrice from @/lib/utils/currency
   - calculateItemPrice, validateModifierSelection from @/lib/utils/price

Note: If BlurImage doesn't exist yet (parallel execution), either:
- Create minimal inline version
- Or use next/image directly with blur placeholder
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>ItemDetailSheetV8 renders using Modal on desktop, BottomSheet on mobile, with modifier selection and add-to-cart</done>
</task>

<task type="auto">
  <name>Task 2: Add AllergenWarning subcomponent</name>
  <files>src/components/ui-v8/menu/ItemDetailSheetV8.tsx</files>
  <action>
Add inline AllergenWarning component within ItemDetailSheetV8.tsx:

```tsx
function AllergenWarning({ allergens }: { allergens: string[] }) {
  return (
    <div className={cn(
      "flex items-start gap-3 rounded-card p-3",
      "border border-status-warning/30 bg-status-warning/10"
    )}>
      <AlertTriangle className="mt-0.5 h-5 w-5 flex-shrink-0 text-status-warning" />
      <div>
        <p className="font-medium text-text-primary">Allergen Information</p>
        <p className="text-sm text-text-secondary">
          Contains:{" "}
          {allergens
            .map((a) => ALLERGEN_MAP[a]?.label || a)
            .join(", ")}
        </p>
      </div>
    </div>
  );
}
```

Import ALLERGEN_MAP from @/lib/constants/allergens.
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>AllergenWarning displays allergen information with warning styling</done>
</task>

<task type="auto">
  <name>Task 3: Verify overlay integration</name>
  <files>src/components/ui-v8/menu/ItemDetailSheetV8.tsx</files>
  <action>
Verify the component:

1. Check imports resolve correctly:
   - Modal from @/components/ui-v8/Modal
   - BottomSheet from @/components/ui-v8/BottomSheet
   - AddToCartButton from @/components/ui-v8/cart/AddToCartButton
   - useMediaQuery from @/lib/hooks/useMediaQuery

2. Ensure proper cleanup on unmount:
   - State resets when item changes (useEffect with item dependency)

3. Run full verification:
   ```bash
   pnpm lint && pnpm typecheck
   ```

4. If AddToCartButton expects different props, adapt:
   - Check AddToCartButton interface
   - Map item data to expected format
  </action>
  <verify>`pnpm lint && pnpm typecheck` passes</verify>
  <done>ItemDetailSheetV8 compiles without errors, uses Phase 2 overlays and Phase 4 AddToCartButton</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- ItemDetailSheetV8 imports Modal and BottomSheet correctly
- ItemDetailSheetV8 imports AddToCartButton correctly
- useMediaQuery switches between overlays at 640px breakpoint
</verification>

<success_criteria>
- ItemDetailSheetV8 opens as BottomSheet on mobile
- ItemDetailSheetV8 opens as Modal on desktop
- Modifier selection works with existing ModifierGroup
- Add to cart triggers AddToCartButton with fly animation
- Allergen warning displays when item has allergens
</success_criteria>

<output>
After completion, create `.planning/phases/05-menu-browsing/05-03-SUMMARY.md`
</output>
