---
phase: 16-3d-hero-core
plan: 03
type: execute
wave: 3
depends_on: ["16-01", "16-02"]
files_modified:
  - src/components/homepage/Hero3DSection.tsx
  - src/components/homepage/Hero.tsx
  - public/images/hero-dish-2d.jpg (fallback image, needs sourcing)
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Low-end devices see 2D fallback image instead of 3D"
    - "3D canvas appears in hero section on capable devices"
    - "Loading state shows while GPU tier is detected"
    - "2D fallback has subtle visual interest (not just static)"
    - "Hero section layering works correctly with 3D canvas"
  artifacts:
    - path: "src/components/homepage/Hero3DSection.tsx"
      provides: "Conditional 3D/2D wrapper based on GPU tier"
      exports: ["Hero3DSection"]
    - path: "src/components/homepage/Hero.tsx"
      provides: "Updated Hero with 3D layer integration"
  key_links:
    - from: "src/components/homepage/Hero3DSection.tsx"
      to: "src/components/3d/hooks/useGPUTier.ts"
      via: "useGPUTier hook"
      pattern: "useGPUTier.*shouldRender3D"
    - from: "src/components/homepage/Hero3DSection.tsx"
      to: "src/components/3d/Hero3DCanvas.tsx"
      via: "dynamic import"
      pattern: "dynamic.*Hero3DCanvas"
    - from: "src/components/homepage/Hero.tsx"
      to: "src/components/homepage/Hero3DSection.tsx"
      via: "ParallaxLayer"
      pattern: "<Hero3DSection"
---

<objective>
Integrate 3D hero into homepage with GPU-based fallback for low-end devices.

Purpose: This plan wires everything together - the 3D scene appears in the hero section on capable devices, 2D fallback on low-end devices. Completes the Phase 16 user experience.

Output: Hero3DSection component with GPU detection and conditional rendering, Hero.tsx updated with 3D layer.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-3d-hero-core/16-RESEARCH.md
@.planning/phases/16-3d-hero-core/16-CONTEXT.md
@.planning/phases/16-3d-hero-core/16-01-SUMMARY.md
@.planning/phases/16-3d-hero-core/16-02-SUMMARY.md
@src/components/homepage/Hero.tsx
@src/components/3d/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hero3DSection with GPU-based conditional rendering</name>
  <files>src/components/homepage/Hero3DSection.tsx</files>
  <action>
Create the 3D/2D switching component at `src/components/homepage/Hero3DSection.tsx`:

```typescript
"use client";

import dynamic from "next/dynamic";
import { motion } from "framer-motion";
import { useAnimationPreference } from "@/lib/hooks/useAnimationPreference";
import { useGPUTier } from "@/components/3d";

// Dynamic import with SSR disabled - prevents WebGL errors during SSR
const Hero3DCanvas = dynamic(
  () => import("@/components/3d").then((m) => m.Hero3DCanvas),
  {
    ssr: false,
    loading: () => <Hero2DFallback isLoading />,
  }
);

interface Hero2DFallbackProps {
  isLoading?: boolean;
}

/**
 * 2D fallback for low-end devices or while loading.
 * Shows the same dish as a high-quality image with subtle motion.
 */
function Hero2DFallback({ isLoading = false }: Hero2DFallbackProps) {
  const { shouldAnimate } = useAnimationPreference();

  return (
    <div className="relative w-full h-full flex items-center justify-center">
      {/* Background gradient for depth */}
      <div className="absolute inset-0 bg-gradient-radial from-secondary/10 via-transparent to-transparent" />

      {/* Food image with subtle float animation */}
      <motion.div
        className="relative w-[80%] max-w-md aspect-square"
        animate={
          shouldAnimate && !isLoading
            ? {
                y: [0, -10, 0],
                rotate: [0, 1, 0, -1, 0],
              }
            : undefined
        }
        transition={{
          duration: 6,
          repeat: Infinity,
          ease: "easeInOut",
        }}
      >
        {/* Glow behind image */}
        <div className="absolute inset-0 blur-3xl bg-secondary/20 rounded-full scale-75" />

        {/* The food image */}
        <img
          src="/images/hero-dish-2d.jpg"
          alt="Authentic Burmese rice bowl"
          className="relative w-full h-full object-contain drop-shadow-2xl"
          style={{
            filter: isLoading ? "blur(4px)" : "none",
            transition: "filter 0.3s ease-out",
          }}
        />

        {/* Loading shimmer overlay */}
        {isLoading && (
          <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent animate-shimmer" />
        )}
      </motion.div>
    </div>
  );
}

export interface Hero3DSectionProps {
  className?: string;
}

/**
 * Conditional 3D/2D hero content based on device capability.
 *
 * Behavior:
 * - While GPU tier detecting: Show 2D with loading state
 * - GPU tier 0-1 (low-end): Show 2D fallback permanently
 * - GPU tier 2+ (capable): Show 3D Canvas
 *
 * The 2D fallback is NOT a failure state - it's a designed experience
 * for devices where 3D would cause poor performance.
 */
export function Hero3DSection({ className }: Hero3DSectionProps) {
  const { shouldRender3D, isLoading } = useGPUTier();

  // Still detecting GPU capability - show loading state
  if (isLoading) {
    return (
      <div className={className}>
        <Hero2DFallback isLoading />
      </div>
    );
  }

  // Low-end device - show optimized 2D experience
  if (!shouldRender3D) {
    return (
      <div className={className}>
        <Hero2DFallback />
      </div>
    );
  }

  // Capable device - show full 3D experience
  return (
    <div className={className}>
      <Hero3DCanvas />
    </div>
  );
}
```

Note: The 2D fallback image `/images/hero-dish-2d.jpg` needs to be sourced.
For now, the component will work but show a broken image until the asset exists.
A placeholder can be added or this can be flagged for asset sourcing.
  </action>
  <verify>
TypeScript compiles: `pnpm typecheck`
Component renders without errors when imported
  </verify>
  <done>Hero3DSection conditionally renders 3D or 2D based on GPU tier</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Hero3DSection into Hero.tsx</name>
  <files>src/components/homepage/Hero.tsx</files>
  <action>
Update Hero.tsx to include the 3D section as a new parallax layer.

**Add import at top of file:**
```typescript
import { Hero3DSection } from "./Hero3DSection";
```

**Add new ParallaxLayer after the "Floating food elements" layer (around line 265):**

Find this section:
```typescript
{/* Floating food elements */}
{showFloatingFood && (
  <ParallaxLayer speed="near" zIndex={3}>
    <FloatingFood
      items={defaultFoodItems}
      mouseParallax={true}
      parallaxIntensity={0.4}
    />
  </ParallaxLayer>
)}
```

Add the 3D section BEFORE the floating food (so food floats in front of 3D model):

```typescript
{/* 3D Hero Section - interactive food model */}
<ParallaxLayer speed="mid" zIndex={2}>
  <Hero3DSection className="absolute inset-0" />
</ParallaxLayer>

{/* Floating food elements */}
{showFloatingFood && (
  <ParallaxLayer speed="near" zIndex={3}>
    <FloatingFood
      items={defaultFoodItems}
      mouseParallax={true}
      parallaxIntensity={0.4}
    />
  </ParallaxLayer>
)}
```

**Add prop to control 3D display:**

Update HeroProps interface (around line 25):
```typescript
export interface HeroProps {
  // ... existing props ...
  /** Show 3D hero section */
  show3D?: boolean;
}
```

Update Hero function signature:
```typescript
export function Hero({
  // ... existing props ...
  show3D = true,
  className,
}: HeroProps) {
```

Make the 3D layer conditional:
```typescript
{/* 3D Hero Section - interactive food model */}
{show3D && (
  <ParallaxLayer speed="mid" zIndex={2}>
    <Hero3DSection className="absolute inset-0" />
  </ParallaxLayer>
)}
```

This allows disabling 3D for specific use cases or A/B testing.
  </action>
  <verify>
1. `pnpm typecheck` passes
2. `pnpm build` passes
3. Run `pnpm dev` and visit homepage
4. Confirm 3D model appears in hero section
5. Confirm interactions work (rotate, zoom)
  </verify>
  <done>Hero.tsx includes Hero3DSection as a parallax layer</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete 3D hero integration:
- GPU tier detection decides 3D vs 2D
- Hero3DCanvas with interactive food model (placeholder)
- OrbitControls for drag rotation and pinch zoom
- Spring entrance animation
- 2D fallback for low-end devices
- Integration into Hero.tsx parallax layers
  </what-built>
  <how-to-verify>
1. Visit http://localhost:3000 (homepage)
2. Check 3D model appears in hero section
3. Test interactions:
   - Mouse drag: Model rotates smoothly with inertia
   - Scroll/pinch: Model zooms within limits
   - Model stays "right side up" (can't flip it)
4. Check spring animation plays on page load (model scales up)
5. To test 2D fallback: Open DevTools > Performance > CPU throttling 6x
   - Refresh page - may show 2D fallback on simulated low-end

Known limitations (acceptable for Phase 16):
- Using placeholder model (bowl primitive) - real GLB model to be sourced
- 2D fallback image missing - shows broken image until asset sourced
- Environment uses preset (may need bundled HDRI in production)
  </how-to-verify>
  <resume-signal>
Type "approved" if 3D hero works as expected.
Describe any issues if interaction or visual problems occur.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm build` passes
2. Homepage shows 3D hero section
3. All Phase 16 requirements verified:
   - HERO3D-01: 3D food model renders (placeholder)
   - HERO3D-02: Drag/touch rotation works
   - HERO3D-03: Pinch/scroll zoom works (constrained)
   - HERO3D-04: Studio lighting makes food look good
   - HERO3D-05: Loading state shows during 3D load
   - HERO3D-06: Low-end devices show 2D fallback (via GPU tier)
   - HERO3D-07: Reduced motion disables spring animation
</verification>

<success_criteria>
- [ ] Hero3DSection renders 3D on capable devices
- [ ] Hero3DSection renders 2D fallback on low-end devices
- [ ] GPU tier detection works without SSR errors
- [ ] Hero.tsx includes 3D layer in parallax stack
- [ ] All interactions work on desktop and mobile
- [ ] Human verification confirms 3D hero works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/16-3d-hero-core/16-03-SUMMARY.md`
</output>
