---
phase: 16-3d-hero-core
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/components/3d/models/FoodModel.tsx
  - src/components/3d/Hero3DCanvas.tsx
  - src/components/3d/index.ts
  - public/models/rice-bowl.glb (placeholder)
  - public/hdri/studio.hdr (optional - may use preset initially)
autonomous: true
user_setup: []

must_haves:
  truths:
    - "3D food model renders in Canvas without SSR errors"
    - "User can rotate model by dragging (touch and mouse)"
    - "User can zoom model with scroll/pinch (within limits)"
    - "Model stays 'right side up' (constrained rotation)"
    - "Model scales up with spring animation on load"
    - "Lighting makes food look appetizing (studio-style)"
  artifacts:
    - path: "src/components/3d/models/FoodModel.tsx"
      provides: "GLTF food model with spring entrance"
      exports: ["FoodModel"]
    - path: "src/components/3d/Hero3DCanvas.tsx"
      provides: "Complete 3D hero scene with controls and lighting"
      exports: ["Hero3DCanvas"]
  key_links:
    - from: "src/components/3d/Hero3DCanvas.tsx"
      to: "src/components/3d/models/FoodModel.tsx"
      via: "Suspense-wrapped import"
      pattern: "<FoodModel"
    - from: "src/components/3d/Hero3DCanvas.tsx"
      to: "@react-three/drei"
      via: "OrbitControls import"
      pattern: "OrbitControls.*drei"
    - from: "src/components/3d/models/FoodModel.tsx"
      to: "@react-spring/three"
      via: "animated.primitive"
      pattern: "animated.*react-spring"
---

<objective>
Create the core 3D hero scene with interactive food model, OrbitControls, and studio lighting.

Purpose: This is the main 3D experience - user sees and interacts with a beautiful food model. Drag to rotate, pinch to zoom, spring animation on reveal.

Output: Hero3DCanvas component ready for integration into Hero.tsx, with FoodModel, OrbitControls, Environment lighting, and spring entrance animation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-3d-hero-core/16-RESEARCH.md
@.planning/phases/16-3d-hero-core/16-CONTEXT.md
@.planning/phases/16-3d-hero-core/16-01-SUMMARY.md
@src/components/3d/Scene.tsx
@src/components/3d/index.ts
@src/lib/hooks/useAnimationPreference.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FoodModel component with spring entrance</name>
  <files>src/components/3d/models/FoodModel.tsx</files>
  <action>
Create food model component at `src/components/3d/models/FoodModel.tsx`:

```typescript
"use client";

import { useRef, useEffect, useState } from "react";
import { useGLTF } from "@react-three/drei";
import { useSpring, animated } from "@react-spring/three";
import type { Group } from "three";

interface FoodModelProps {
  url: string;
  shouldAnimate?: boolean;
  position?: [number, number, number];
  scale?: number;
}

/**
 * GLTF food model with spring scale-up entrance animation.
 * Respects shouldAnimate prop for reduced motion preference.
 */
export function FoodModel({
  url,
  shouldAnimate = true,
  position = [0, 0, 0],
  scale = 1,
}: FoodModelProps) {
  const groupRef = useRef<Group>(null);
  const { scene } = useGLTF(url);
  const [isReady, setIsReady] = useState(false);

  // Trigger animation after model loads
  useEffect(() => {
    setIsReady(true);
  }, []);

  // Spring scale-up entrance
  const { springScale } = useSpring({
    springScale: isReady ? scale : 0,
    from: { springScale: shouldAnimate ? 0 : scale },
    config: { tension: 200, friction: 20 },
    immediate: !shouldAnimate,
  });

  return (
    <animated.group
      ref={groupRef}
      position={position}
      scale={springScale}
    >
      <primitive object={scene.clone()} />
    </animated.group>
  );
}
```

NOTE: Uses scene.clone() to prevent issues with multiple instances.
If no GLB model exists yet, the component will work once model is added.

**Placeholder model strategy:** Create a simple placeholder primitive for testing until real model is sourced:

```typescript
// Temporary placeholder - remove when real model added
export function FoodModelPlaceholder({
  shouldAnimate = true,
  position = [0, 0, 0],
  scale = 1,
}: Omit<FoodModelProps, "url">) {
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    setIsReady(true);
  }, []);

  const { springScale } = useSpring({
    springScale: isReady ? scale : 0,
    from: { springScale: shouldAnimate ? 0 : scale },
    config: { tension: 200, friction: 20 },
    immediate: !shouldAnimate,
  });

  // Simple bowl shape as placeholder
  return (
    <animated.group position={position} scale={springScale}>
      {/* Bowl base */}
      <mesh position={[0, -0.2, 0]}>
        <cylinderGeometry args={[0.8, 0.5, 0.4, 32]} />
        <meshStandardMaterial color="#D4A574" metalness={0.1} roughness={0.8} />
      </mesh>
      {/* Rice/content */}
      <mesh position={[0, 0.1, 0]}>
        <sphereGeometry args={[0.7, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2]} />
        <meshStandardMaterial color="#FAFAFA" metalness={0} roughness={1} />
      </mesh>
      {/* Garnish dots */}
      <mesh position={[0.3, 0.3, 0.2]}>
        <sphereGeometry args={[0.08, 16, 16]} />
        <meshStandardMaterial color="#52A52E" />
      </mesh>
      <mesh position={[-0.2, 0.35, 0.3]}>
        <sphereGeometry args={[0.06, 16, 16]} />
        <meshStandardMaterial color="#A41034" />
      </mesh>
    </animated.group>
  );
}
```
  </action>
  <verify>
TypeScript compiles: `pnpm typecheck`
File exists with correct exports
  </verify>
  <done>FoodModel component renders GLTF with spring entrance, FoodModelPlaceholder available for testing</done>
</task>

<task type="auto">
  <name>Task 2: Create Hero3DCanvas with OrbitControls and lighting</name>
  <files>src/components/3d/Hero3DCanvas.tsx</files>
  <action>
Create the main 3D scene at `src/components/3d/Hero3DCanvas.tsx`:

```typescript
"use client";

import { Suspense } from "react";
import { Canvas } from "@react-three/fiber";
import { OrbitControls, Environment, ContactShadows } from "@react-three/drei";
import { useAnimationPreference } from "@/lib/hooks/useAnimationPreference";
import { Hero3DLoader } from "./loaders/Hero3DLoader";
import { FoodModelPlaceholder } from "./models/FoodModel";
// import { FoodModel } from "./models/FoodModel"; // Uncomment when real model exists

/**
 * Hero 3D Canvas - Interactive food model showcase.
 *
 * Features:
 * - OrbitControls with inertia and constrained rotation
 * - Studio lighting via Environment
 * - Contact shadows for grounding
 * - Spring entrance animation (respects reduced motion)
 * - Touch-friendly (touch-action: none on Canvas)
 *
 * Anti-patterns avoided:
 * - No autoRotate (Phase 17 scope)
 * - No frameloop="demand" (causes choppy react-spring)
 */
export function Hero3DCanvas() {
  const { shouldAnimate } = useAnimationPreference();

  return (
    <Canvas
      style={{ touchAction: "none" }}
      gl={{
        powerPreference: "default",
        antialias: false, // Better mobile performance
      }}
      camera={{
        position: [0, 1, 4],
        fov: 50,
      }}
    >
      {/* Loading state - shown while model loads */}
      <Suspense fallback={<Hero3DLoader />}>
        {/* Food Model - using placeholder until real GLB sourced */}
        <FoodModelPlaceholder
          shouldAnimate={shouldAnimate}
          position={[0, 0, 0]}
          scale={1}
        />
        {/* Real model (uncomment when /public/models/rice-bowl.glb exists):
        <FoodModel
          url="/models/rice-bowl.glb"
          shouldAnimate={shouldAnimate}
          position={[0, 0, 0]}
          scale={1}
        />
        */}

        {/* OrbitControls - constrained rotation, zoom with limits */}
        <OrbitControls
          // Inertia/damping - drei enables by default
          enableDamping
          dampingFactor={0.05}
          // Rotation constraints - keep food "right side up"
          minPolarAngle={Math.PI / 4}      // Don't go below 45deg
          maxPolarAngle={Math.PI / 2.2}    // Don't go above ~82deg
          minAzimuthAngle={-Math.PI / 3}   // Limit horizontal -60deg
          maxAzimuthAngle={Math.PI / 3}    // Limit horizontal +60deg
          // Zoom constraints
          enableZoom
          minDistance={2}
          maxDistance={6}
          // Disable pan - only rotate and zoom
          enablePan={false}
          // Auto-rotate disabled (Phase 17 feature)
          autoRotate={false}
        />

        {/* Studio lighting - Environment handles ambient + reflections */}
        <Environment preset="studio" />

        {/* Contact shadow for grounding */}
        <ContactShadows
          opacity={0.4}
          scale={10}
          blur={2}
          position={[0, -1, 0]}
        />

        {/* Ambient fill light */}
        <ambientLight intensity={0.3} />
      </Suspense>
    </Canvas>
  );
}
```

Key decisions:
- `touchAction: "none"` - Required for touch rotation on mobile
- `antialias: false` - Better performance on mobile, minimal visual difference
- `powerPreference: "default"` - Avoids iOS memory pressure issues
- OrbitControls constraints keep food viewable from appetizing angles
- Environment preset="studio" for now - can bundle HDRI later if CDN issues arise
- ContactShadows grounds the model visually
  </action>
  <verify>
1. Run `pnpm dev`
2. Create quick test page or modify /3d-test to use Hero3DCanvas
3. Confirm:
   - Model renders (placeholder bowl)
   - Drag to rotate works (mouse and touch if testing on mobile)
   - Scroll to zoom works within limits
   - Spring animation plays on load
   - No SSR errors
  </verify>
  <done>Hero3DCanvas renders interactive 3D scene with OrbitControls, lighting, and spring entrance</done>
</task>

<task type="auto">
  <name>Task 3: Update barrel exports and verify scene</name>
  <files>src/components/3d/index.ts</files>
  <action>
Update barrel export at `src/components/3d/index.ts`:

```typescript
// Core
export { Scene } from "./Scene";

// Hero 3D
export { Hero3DCanvas } from "./Hero3DCanvas";

// Models
export { FoodModel, FoodModelPlaceholder } from "./models/FoodModel";

// Hooks
export { useGPUTier } from "./hooks/useGPUTier";

// Loaders
export { Hero3DLoader } from "./loaders/Hero3DLoader";
```

Then verify the complete scene by updating the 3d-test page temporarily:

At `src/app/(dev)/3d-test/page.tsx`, add:

```typescript
import dynamic from "next/dynamic";

const Hero3DCanvas = dynamic(
  () => import("@/components/3d").then((m) => m.Hero3DCanvas),
  { ssr: false }
);

// Add to the page JSX below existing content:
<section className="p-8">
  <h2 className="text-xl font-bold mb-4">Hero 3D Canvas Test</h2>
  <div className="w-full h-[400px] bg-gradient-to-br from-primary to-primary-dark rounded-lg overflow-hidden">
    <Hero3DCanvas />
  </div>
</section>
```

Test interactions:
1. Mouse drag rotates model
2. Touch drag rotates model (mobile or touch simulation)
3. Scroll zooms in/out (within min/max distance)
4. Model snaps to constraints (can't flip upside down)
5. Spring animation plays on page load
  </action>
  <verify>
1. `pnpm typecheck` passes
2. `pnpm build` passes
3. Visit /3d-test in browser
4. Confirm all interactions work
  </verify>
  <done>All 3D components exported and Hero3DCanvas verified working</done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm build` passes
2. `pnpm typecheck` passes
3. Files exist:
   - src/components/3d/models/FoodModel.tsx
   - src/components/3d/Hero3DCanvas.tsx
4. /3d-test page shows interactive 3D scene
5. All HERO3D requirements covered:
   - HERO3D-01: Model renders (placeholder, ready for real GLB)
   - HERO3D-02: OrbitControls enables drag/touch rotation
   - HERO3D-03: Zoom with minDistance/maxDistance limits
   - HERO3D-04: Environment preset="studio" provides lighting
   - HERO3D-07: shouldAnimate respected in spring animation
</verification>

<success_criteria>
- [ ] FoodModel component with spring entrance animation
- [ ] FoodModelPlaceholder for testing until real model sourced
- [ ] Hero3DCanvas with OrbitControls (drag rotate, pinch zoom)
- [ ] Rotation constraints keep food "right side up"
- [ ] Studio lighting via Environment
- [ ] shouldAnimate respected (instant if reduced motion)
- [ ] Touch interactions work on mobile
- [ ] Build and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-3d-hero-core/16-02-SUMMARY.md`
</output>
