---
phase: 15-foundation-r3f-setup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/3d/Scene.tsx
  - src/components/3d/index.ts
  - src/app/(dev)/3d-test/page.tsx
  - src/app/(dev)/3d-test/RotatingCube.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "import { Canvas } from '@react-three/fiber' works without SSR errors"
    - "Basic 3D scene renders in browser (test page with rotating cube)"
    - "Build completes without Three.js window/WebGL SSR crashes"
  artifacts:
    - path: "src/components/3d/Scene.tsx"
      provides: "SSR-safe Canvas wrapper with mounted check"
      exports: ["Scene"]
      min_lines: 20
    - path: "src/components/3d/index.ts"
      provides: "Barrel exports for 3d components"
      exports: ["Scene"]
    - path: "src/app/(dev)/3d-test/page.tsx"
      provides: "Test page with rotating 3D cube"
      contains: "dynamic"
    - path: "src/app/(dev)/3d-test/RotatingCube.tsx"
      provides: "Rotating cube component using useFrame"
      exports: ["RotatingCube"]
  key_links:
    - from: "src/app/(dev)/3d-test/page.tsx"
      to: "src/components/3d/Scene.tsx"
      via: "dynamic import"
      pattern: "dynamic.*import.*3d/Scene"
    - from: "src/components/3d/Scene.tsx"
      to: "@react-three/fiber"
      via: "Canvas import"
      pattern: "import.*Canvas.*from.*@react-three/fiber"
---

<objective>
Install React Three Fiber and create SSR-safe 3D foundation for subsequent phases.

Purpose: Establish R3F infrastructure (INFRA-03, INFRA-04) with verified React 19 compatibility and SSR-safe patterns.
Output: Working 3D test page with rotating cube, SSR-safe Scene wrapper ready for Phase 16.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-foundation-r3f-setup/15-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Three Fiber packages</name>
  <files>package.json</files>
  <action>
Install Three.js ecosystem with React 19 compatible versions:

```bash
pnpm add three @react-three/fiber @react-three/drei
pnpm add -D @types/three
```

After installation, verify versions are correct:

```bash
pnpm ls react @react-three/fiber three
```

Expected output:
- react@19.2.3
- @react-three/fiber@9.x.x (must be 9.5.0 or higher, NOT 8.x)
- three@0.180.0 or higher

If @react-three/fiber installs as v8.x, the installation failed. Run:
```bash
pnpm add @react-three/fiber@^9.5.0
```

The version constraint is CRITICAL - v8.x throws `Cannot read properties of undefined (reading 'ReactCurrentOwner')` with React 19.
  </action>
  <verify>
1. `pnpm ls @react-three/fiber` shows version 9.x.x
2. `pnpm ls three` shows version 0.180.0+
3. `pnpm ls @react-three/drei` shows version 10.x.x
4. `pnpm ls @types/three` shows installed
5. No peer dependency warnings for React 19
  </verify>
  <done>React Three Fiber 9.5.0+ installed with three, drei, and types packages</done>
</task>

<task type="auto">
  <name>Task 2: Create SSR-safe Scene wrapper</name>
  <files>
    src/components/3d/Scene.tsx
    src/components/3d/index.ts
  </files>
  <action>
Create the 3D component folder structure and SSR-safe Canvas wrapper:

**src/components/3d/Scene.tsx:**
```typescript
"use client";

import { useEffect, useState, type ReactNode } from "react";
import { Canvas, type CanvasProps } from "@react-three/fiber";

interface SceneProps extends Omit<CanvasProps, "children"> {
  children: ReactNode;
  fallback?: ReactNode;
}

/**
 * SSR-safe Canvas wrapper for React Three Fiber
 *
 * Uses mounted state check to prevent SSR hydration errors.
 * Three.js requires browser APIs (window, WebGL) that don't exist during SSR.
 *
 * Usage: Always import via dynamic() with ssr: false in page components.
 *
 * @example
 * const Scene = dynamic(() => import("@/components/3d").then(m => m.Scene), { ssr: false });
 */
export function Scene({ children, fallback = null, ...props }: SceneProps) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    return () => setMounted(false);
  }, []);

  if (!mounted) {
    return <>{fallback}</>;
  }

  return (
    <Canvas {...props}>
      {children}
    </Canvas>
  );
}
```

**src/components/3d/index.ts:**
```typescript
export { Scene } from "./Scene";
```

Key implementation notes:
- "use client" directive required (Three.js uses browser APIs)
- useState(false) + useEffect pattern prevents SSR render
- Fallback prop allows showing placeholder during mount
- Cleanup function in useEffect prevents memory leaks during HMR
  </action>
  <verify>
1. `ls src/components/3d/` shows Scene.tsx and index.ts
2. `grep -n "use client" src/components/3d/Scene.tsx` - shows directive at line 1
3. `grep -n "useState(false)" src/components/3d/Scene.tsx` - shows mounted check pattern
4. `pnpm typecheck` - should pass
  </verify>
  <done>Scene.tsx created with SSR-safe mounted check pattern; barrel export in index.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create 3D test page with rotating cube</name>
  <files>
    src/app/(dev)/3d-test/page.tsx
    src/app/(dev)/3d-test/RotatingCube.tsx
  </files>
  <action>
Create a dev-only test page to verify R3F setup works:

**src/app/(dev)/3d-test/page.tsx:**
```typescript
import dynamic from "next/dynamic";
import { Suspense } from "react";

// Dynamic import with SSR disabled - REQUIRED for R3F components
const Scene = dynamic(
  () => import("@/components/3d").then((m) => m.Scene),
  {
    ssr: false,
    loading: () => (
      <div className="h-full w-full animate-pulse bg-muted flex items-center justify-center">
        <span className="text-muted-foreground">Loading 3D...</span>
      </div>
    ),
  }
);

// Separate component for 3D content (also client-side only)
const RotatingCube = dynamic(
  () => import("./RotatingCube").then((m) => m.RotatingCube),
  { ssr: false }
);

export default function ThreeDTestPage() {
  return (
    <div className="min-h-screen bg-surface-primary">
      <header className="border-b border-border p-4">
        <h1 className="text-2xl font-bold">3D Test Page</h1>
        <p className="text-muted-foreground">
          React Three Fiber setup verification
        </p>
      </header>

      <main className="h-[calc(100vh-100px)]">
        <Suspense fallback={<div className="h-full animate-pulse bg-muted" />}>
          <Scene
            camera={{ position: [0, 0, 5], fov: 50 }}
            fallback={<div className="h-full animate-pulse bg-muted" />}
          >
            <ambientLight intensity={0.5} />
            <directionalLight position={[5, 5, 5]} intensity={1} />
            <RotatingCube />
          </Scene>
        </Suspense>
      </main>
    </div>
  );
}
```

**src/app/(dev)/3d-test/RotatingCube.tsx:**
```typescript
"use client";

import { useRef } from "react";
import { useFrame } from "@react-three/fiber";
import type { Mesh } from "three";

/**
 * Simple rotating cube for R3F setup verification
 * Uses useFrame for animation (runs every frame at 60fps)
 */
export function RotatingCube() {
  const meshRef = useRef<Mesh>(null);

  // Rotate cube every frame
  useFrame((_, delta) => {
    if (meshRef.current) {
      meshRef.current.rotation.x += delta * 0.5;
      meshRef.current.rotation.y += delta * 0.7;
    }
  });

  return (
    <mesh ref={meshRef}>
      <boxGeometry args={[1.5, 1.5, 1.5]} />
      <meshStandardMaterial color="#8b1a1a" /> {/* Primary brand color */}
    </mesh>
  );
}
```

The (dev) route group keeps test pages organized. The page verifies:
- R3F Canvas renders without SSR errors
- useFrame animation works
- Dynamic imports load correctly
- Three.js mesh and geometry render
  </action>
  <verify>
1. `pnpm build` - should complete without SSR/window errors
2. `pnpm dev` - start dev server
3. Navigate to http://localhost:3000/3d-test - should show rotating cube
4. No console errors about window, WebGL, or React internals
5. Cube animates smoothly (rotating on X and Y axes)
  </verify>
  <done>Test page at /3d-test shows rotating cube; R3F setup verified working</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. `pnpm build` passes (no SSR errors)
4. Manual test: Navigate to /3d-test, see rotating cube
5. Version check: `pnpm ls @react-three/fiber` shows 9.5.0+
</verification>

<success_criteria>
- INFRA-03: React Three Fiber 9.5.0 installed and SSR-safe
- INFRA-04: Three.js + drei packages configured with proper imports
- Test page renders 3D content without errors
- Build passes without SSR/hydration issues
</success_criteria>

<output>
After completion, create `.planning/phases/15-foundation-r3f-setup/15-02-SUMMARY.md`
</output>
