---
phase: 30-mobile-stability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/menu/UnifiedMenuItemCard/GlassOverlay.tsx
  - src/components/ui/menu/UnifiedMenuItemCard/CardImage.tsx
  - src/components/ui/menu/UnifiedMenuItemCard/UnifiedMenuItemCard.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "No content clipping or disappearing on iOS Safari"
    - "Glassmorphism blur renders correctly during 3D transforms"
    - "Animated shine sweep visible on touch devices"
    - "Long-press (500ms) opens item detail sheet"
  artifacts:
    - path: "src/components/ui/menu/UnifiedMenuItemCard/GlassOverlay.tsx"
      provides: "Safari-compatible glassmorphism with isolation"
      contains: "isolation: isolate"
    - path: "src/components/ui/menu/UnifiedMenuItemCard/CardImage.tsx"
      provides: "Touch fallback shine animation"
      contains: "animate-shine-sweep"
    - path: "src/components/ui/menu/UnifiedMenuItemCard/UnifiedMenuItemCard.tsx"
      provides: "500ms long-press to detail sheet"
      contains: "500"
  key_links:
    - from: "GlassOverlay.tsx"
      to: "CSS isolation property"
      via: "inline style"
      pattern: "isolation"
    - from: "CardImage.tsx"
      to: "globals.css"
      via: "animate-shine-sweep class"
      pattern: "animate-shine-sweep"
    - from: "UnifiedMenuItemCard.tsx"
      to: "onSelect callback"
      via: "long press handler"
      pattern: "onSelect"
---

<objective>
Apply Safari compositing fixes and add animated shine fallback for touch devices. Update long-press timing to iOS standard 500ms.

Purpose: Safari has known bugs with backdrop-filter and 3D transforms that cause content clipping and blur artifacts. Touch devices need an animated shine sweep (not cursor-tracked) for visual delight without tilt.

Output: Stable glassmorphism rendering on Safari with animated shine on touch devices and proper long-press behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-mobile-stability/30-CONTEXT.md
@.planning/phases/30-mobile-stability/30-RESEARCH.md

@src/components/ui/menu/UnifiedMenuItemCard/GlassOverlay.tsx
@src/components/ui/menu/UnifiedMenuItemCard/CardImage.tsx
@src/components/ui/menu/UnifiedMenuItemCard/UnifiedMenuItemCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply Safari compositing fixes to GlassOverlay</name>
  <files>src/components/ui/menu/UnifiedMenuItemCard/GlassOverlay.tsx</files>
  <action>
Apply Safari-specific fixes for backdrop-filter rendering bugs. The glassmorphism effect needs isolation to prevent compositing conflicts with 3D transforms.

**Update the outer container div (~line 39) to add isolation:**

Change from:
```tsx
<div className={cn("absolute inset-0 pointer-events-none", zClass.base, rounded, className)}>
```

To:
```tsx
<div
  className={cn("absolute inset-0 pointer-events-none", zClass.base, rounded, className)}
  style={{ isolation: "isolate" }}
>
```

**Update the glass surface div (~line 41-45) to add overflow containment:**

Change from:
```tsx
<div
  className={cn(
    "absolute inset-0 glass-menu-card",
    rounded
  )}
/>
```

To:
```tsx
<div
  className={cn(
    "absolute inset-0 glass-menu-card",
    rounded
  )}
  style={{
    overflow: "hidden",
    // Safari backface fix
    WebkitBackfaceVisibility: "hidden",
    backfaceVisibility: "hidden",
  }}
/>
```

These fixes address:
1. `isolation: isolate` - Creates new stacking context to prevent backdrop-filter bleed
2. `overflow: hidden` - Contains the backdrop-filter effect within bounds
3. `backfaceVisibility: hidden` - Prevents flicker during 3D transforms
  </action>
  <verify>
- `pnpm typecheck` passes
- Component renders without visual artifacts
- Glassmorphism effect still visible
  </verify>
  <done>GlassOverlay has Safari compositing fixes: isolation, overflow hidden, backface-visibility</done>
</task>

<task type="auto">
  <name>Task 2: Add animated shine fallback for touch devices</name>
  <files>src/components/ui/menu/UnifiedMenuItemCard/CardImage.tsx</files>
  <action>
Add an animated shine sweep that displays on touch devices (when cursor-tracked shine is not available). The existing cursor-tracked shine only shows during hover with shouldAnimate && isHovered.

**1. Add useCanHover import (top of file):**
```tsx
import { useCanHover } from "@/lib/hooks/useResponsive";
```

**2. Add hook call (after useAnimationPreference, ~line 59):**
```tsx
const canHover = useCanHover();
```

**3. Add touch shine element AFTER the existing cursor-tracked shine (~line 120):**

After the existing shine overlay block (`{shouldAnimate && isHovered && (...)}`) and BEFORE the gradient overlay, add:

```tsx
{/* Animated shine sweep for touch devices (no cursor tracking) */}
{shouldAnimate && !canHover && (
  <div
    className={cn(
      "absolute inset-0 pointer-events-none touch-only",
      zClass.cardShine
    )}
  >
    <div
      className="absolute inset-0 animate-shine-sweep bg-gradient-card-shine"
      style={{
        width: "50%",
        height: "200%",
        top: "-50%",
      }}
    />
  </div>
)}
```

This provides:
- Animated shine sweep on touch devices (4.5 second cycle from CSS)
- Uses existing bg-gradient-card-shine for consistent look
- Pauses during tap/interaction (from CSS :active rule)
- Hidden on hover-capable devices (CSS touch-only class)
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Shine animation visible in mobile DevTools emulation
- Cursor-tracked shine still works on desktop
  </verify>
  <done>CardImage shows animated shine sweep on touch devices, cursor-tracked shine on hover devices</done>
</task>

<task type="auto">
  <name>Task 3: Update long-press timing and wire to detail sheet</name>
  <files>src/components/ui/menu/UnifiedMenuItemCard/UnifiedMenuItemCard.tsx</files>
  <action>
Update the long-press duration from 300ms to 500ms (iOS standard per CONTEXT.md) and make it open the item detail sheet instead of enabling tilt play.

**1. Add constant for long-press duration (after SPRING_CONFIG, ~line 93):**
```tsx
// Long-press duration for opening detail sheet (iOS standard per CONTEXT.md)
const LONG_PRESS_DURATION = 500;
```

**2. Add touch start position ref for scroll detection (after longPressTimer ref, ~line 125):**
```tsx
const touchStartPos = useRef<{ x: number; y: number } | null>(null);
```

**3. Update handleTouchStart (~line 213-222):**

Replace the existing implementation:
```tsx
const handleTouchStart = useCallback(
  (e: React.TouchEvent) => {
    // On touch devices without hover, long-press opens detail sheet
    // On hybrid devices with hover, this won't fire (tilt handled by mouse)
    if (item.isSoldOut) return;

    const touch = e.touches[0];
    if (touch) {
      touchStartPos.current = { x: touch.clientX, y: touch.clientY };
    }

    longPressTimer.current = setTimeout(() => {
      // Haptic feedback
      if (typeof navigator !== "undefined" && "vibrate" in navigator) {
        navigator.vibrate(20);
      }
      // Open detail sheet (same as card click)
      onSelect?.(item);
    }, LONG_PRESS_DURATION);
  },
  [item, onSelect]
);
```

**4. Add handleTouchMove to cancel on scroll (replace existing ~line 238-253):**
```tsx
const handleTouchMove = useCallback(
  (e: React.TouchEvent) => {
    // Cancel long-press if user scrolls (10px threshold)
    if (!touchStartPos.current || !longPressTimer.current) return;

    const touch = e.touches[0];
    if (!touch) return;

    const dx = Math.abs(touch.clientX - touchStartPos.current.x);
    const dy = Math.abs(touch.clientY - touchStartPos.current.y);

    if (dx > 10 || dy > 10) {
      clearTimeout(longPressTimer.current);
      longPressTimer.current = null;
      touchStartPos.current = null;
    }
  },
  []
);
```

**5. Update handleTouchEnd (~line 224-236):**
```tsx
const handleTouchEnd = useCallback(() => {
  if (longPressTimer.current) {
    clearTimeout(longPressTimer.current);
    longPressTimer.current = null;
  }
  touchStartPos.current = null;

  // Reset tilt on hybrid devices (if tilt was enabled)
  if (shouldEnableTilt) {
    requestAnimationFrame(() => {
      setIsMobileTiltActive(false);
      mouseX.set(0.5);
      mouseY.set(0.5);
    });
  }
}, [shouldEnableTilt, mouseX, mouseY]);
```

**6. Remove isMobileTiltActive related code if not needed:**
Since we're now using long-press for detail sheet instead of tilt play, the isMobileTiltActive state and its usage in handleMouseMove may no longer be needed. However, keep it for hybrid devices (laptops with touchscreen) where shouldEnableTilt might be true.
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Long-press (500ms) triggers onSelect callback
- Scrolling cancels long-press timer
- No regressions in desktop tilt behavior
  </verify>
  <done>Long-press opens detail sheet after 500ms, cancels on scroll, provides haptic feedback</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   pnpm typecheck && pnpm lint && pnpm lint:css && pnpm build
   ```

2. **Safari fix verification (manual in DevTools):**
   - Glassmorphism blur renders without artifacts
   - Content doesn't clip during card hover
   - No white blocks or flicker during animations

3. **Touch behavior verification (DevTools mobile emulation):**
   - Animated shine sweep visible and loops
   - Shine pauses during tap
   - Long-press (hold ~500ms) opens detail (calls onSelect)
   - Scrolling during long-press cancels it

4. **Desktop verification:**
   - Cursor-tracked shine works (not animated sweep)
   - 3D tilt still functional
   - No visual regressions
</verification>

<success_criteria>
- [ ] GlassOverlay has isolation: isolate and overflow: hidden
- [ ] GlassOverlay has backface-visibility: hidden
- [ ] CardImage shows animated shine on touch devices
- [ ] CardImage shows cursor-tracked shine on hover devices
- [ ] Long-press duration is 500ms
- [ ] Long-press opens detail sheet (calls onSelect)
- [ ] Long-press cancels on scroll (10px threshold)
- [ ] Build passes (typecheck, lint, lint:css, build)
</success_criteria>

<output>
After completion, create `.planning/phases/30-mobile-stability/30-02-SUMMARY.md`
</output>
