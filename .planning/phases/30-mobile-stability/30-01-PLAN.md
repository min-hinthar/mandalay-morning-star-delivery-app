---
phase: 30-mobile-stability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/hooks/useResponsive.ts
  - src/app/globals.css
  - src/components/ui/menu/UnifiedMenuItemCard/UnifiedMenuItemCard.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "3D tilt disabled on touch-only devices"
    - "Hover-capable devices with fine pointer still have tilt"
    - "Touch devices get tap feedback (shadow elevation + lift)"
    - "Animated shine sweep plays on touch devices"
  artifacts:
    - path: "src/lib/hooks/useResponsive.ts"
      provides: "Updated useCanHover with fine pointer check"
      contains: "(hover: hover) and (pointer: fine)"
    - path: "src/app/globals.css"
      provides: "Touch fallback CSS utilities"
      contains: "shine-sweep"
    - path: "src/components/ui/menu/UnifiedMenuItemCard/UnifiedMenuItemCard.tsx"
      provides: "Touch-aware tilt behavior"
      exports: ["UnifiedMenuItemCard"]
  key_links:
    - from: "UnifiedMenuItemCard.tsx"
      to: "useCanHover"
      via: "import from useResponsive"
      pattern: "useCanHover"
    - from: "UnifiedMenuItemCard.tsx"
      to: "globals.css"
      via: "animate-shine-sweep class"
      pattern: "animate-shine-sweep"
---

<objective>
Implement touch device detection and disable 3D tilt effects on touch-only devices while providing quality fallback visual feedback.

Purpose: Mobile users experience content clipping and erratic behavior with 3D tilt effects. Disabling tilt on touch devices eliminates these issues while maintaining a delightful tap feedback experience.

Output: UnifiedMenuItemCard that gracefully degrades on touch devices with animated shine sweep and shadow lift on tap.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-mobile-stability/30-CONTEXT.md
@.planning/phases/30-mobile-stability/30-RESEARCH.md

@src/lib/hooks/useResponsive.ts
@src/lib/hooks/useMediaQuery.ts
@src/app/globals.css
@src/components/ui/menu/UnifiedMenuItemCard/UnifiedMenuItemCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update useCanHover hook for proper touch detection</name>
  <files>src/lib/hooks/useResponsive.ts</files>
  <action>
Update the `useCanHover` hook to check for BOTH hover capability AND fine pointer. The current implementation only checks `(hover: hover)` which is insufficient for detecting touch-only devices.

**Current (line ~115):**
```tsx
export function useCanHover(): boolean {
  return useMediaQuery("(hover: hover)");
}
```

**Update to:**
```tsx
/**
 * Check if device has hover capability AND fine pointer (mouse/trackpad).
 * Use for hover-dependent interactions like 3D tilt effects.
 *
 * Returns false on:
 * - Pure touch devices (phones, tablets)
 * - SSR (safe default for touch)
 *
 * Returns true on:
 * - Desktop with mouse
 * - Laptops with trackpad
 * - Hybrid devices with mouse connected
 *
 * Note: Static detection at mount - no runtime switching per CONTEXT.md decision.
 */
export function useCanHover(): boolean {
  return useMediaQuery("(hover: hover) and (pointer: fine)");
}
```

This matches the CSS media query exactly for consistency between JS and CSS behavior.
  </action>
  <verify>
- File saved without syntax errors
- Hook exports unchanged (still exports useCanHover)
- `pnpm typecheck` passes
  </verify>
  <done>useCanHover returns true only on devices with both hover AND fine pointer capability</done>
</task>

<task type="auto">
  <name>Task 2: Add touch fallback CSS utilities</name>
  <files>src/app/globals.css</files>
  <action>
Add CSS utilities for touch device fallback behavior inside the `@layer utilities` block (after the existing gradient utilities, around line 543).

**Add these utilities:**

```css
/* ============================================
   TOUCH DEVICE FALLBACK UTILITIES
   Mobile-first: base styles for touch, enhanced for hover-capable
   ============================================ */

/* Animated shine sweep for touch devices (4.5 second cycle per CONTEXT.md) */
@keyframes shine-sweep {
  0% {
    transform: translateX(-100%) rotate(45deg);
    opacity: 0;
  }
  10% {
    opacity: 0.3;
  }
  50% {
    opacity: 0.3;
  }
  90% {
    opacity: 0;
  }
  100% {
    transform: translateX(200%) rotate(45deg);
    opacity: 0;
  }
}

.animate-shine-sweep {
  animation: shine-sweep 4.5s ease-in-out infinite;
}

/* Pause animation during interaction */
.animate-shine-sweep:active,
.animate-shine-sweep:focus-within {
  animation-play-state: paused;
}

/* Show only on touch devices (hidden on hover-capable) */
.touch-only {
  display: block;
}

@media (hover: hover) and (pointer: fine) {
  .touch-only {
    display: none;
  }
}

/* Safari GPU compositing fixes for 3D tilt elements */
.tilt-safari-fix {
  /* Force GPU layer creation */
  will-change: transform;

  /* Prevent backface flicker */
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;

  /* Ensure proper compositing */
  -webkit-transform: translate3d(0, 0, 0);
  transform: translate3d(0, 0, 0);
}

/* Parent container for tilt cards - isolate stacking context */
.tilt-container {
  isolation: isolate;
}

/* Backdrop-filter element fix - keep separate from transform element */
.glass-safari-fix {
  isolation: isolate;
  overflow: hidden;
}
```

Place this BEFORE the existing `/* Reduce motion preference */` media query block.
  </action>
  <verify>
- `pnpm lint:css` passes (no CSS syntax errors)
- New classes visible in globals.css
- Keyframes defined outside @layer (at bottom with other keyframes)
  </verify>
  <done>Touch fallback CSS utilities available: animate-shine-sweep, touch-only, tilt-safari-fix, tilt-container, glass-safari-fix</done>
</task>

<task type="auto">
  <name>Task 3: Update UnifiedMenuItemCard with touch-aware tilt behavior</name>
  <files>src/components/ui/menu/UnifiedMenuItemCard/UnifiedMenuItemCard.tsx</files>
  <action>
Update UnifiedMenuItemCard to use useCanHover for touch detection and add fallback tap feedback for touch devices.

**1. Add import (after existing hooks import, ~line 13):**
```tsx
import { useCanHover } from "@/lib/hooks/useResponsive";
```

**2. Add hook call (after useAnimationPreference, ~line 121):**
```tsx
const canHover = useCanHover();
```

**3. Update shouldEnableTilt logic (~line 149):**
```tsx
// Disable tilt on touch-only devices (complete disable per CONTEXT.md)
const shouldEnableTilt =
  config.enableTilt && !disableTilt && shouldAnimate && !item.isSoldOut && canHover;
```

**4. Add touch tap feedback variants (after SPRING_CONFIG, ~line 93):**
```tsx
// Touch device tap feedback (shadow elevation + lift per CONTEXT.md)
const TOUCH_TAP_VARIANTS = {
  idle: {
    y: 0,
    boxShadow: "var(--shadow-sm)",
  },
  pressed: {
    y: -4,
    boxShadow: "var(--shadow-xl)",
    transition: { duration: 0.15, ease: "easeOut" },
  },
};
```

**5. Update the motion.article element (~line 365):**
Add touch feedback when tilt is disabled:

```tsx
<motion.article
  ref={cardRef}
  className={cn(
    "relative group cursor-pointer",
    config.rounded,
    "overflow-visible",
    // Add tilt-container for Safari stacking context isolation
    shouldEnableTilt && "tilt-container",
    item.isSoldOut && "opacity-60 cursor-not-allowed",
    className
  )}
  style={tiltStyle}
  onMouseMove={handleMouseMove}
  onMouseEnter={handleMouseEnter}
  onMouseLeave={handleMouseLeave}
  onTouchStart={handleTouchStart}
  onTouchEnd={handleTouchEnd}
  onTouchMove={handleTouchMove}
  onClick={handleCardClick}
  // Touch tap feedback when tilt disabled, scale when no animation
  variants={!shouldEnableTilt && shouldAnimate ? TOUCH_TAP_VARIANTS : undefined}
  initial={!shouldEnableTilt && shouldAnimate ? "idle" : undefined}
  whileTap={
    shouldAnimate && !item.isSoldOut
      ? shouldEnableTilt
        ? undefined // 3D tilt IS the feedback
        : "pressed" // Touch tap feedback
      : undefined
  }
  whileHover={
    // Disable scale when tilt is enabled - 3D tilt IS the hover feedback
    shouldAnimate && !item.isSoldOut && !shouldEnableTilt ? { scale: 1.03 } : undefined
  }
  transition={springConfig}
  // ... rest unchanged
>
```

**6. Update touch handlers to respect canHover:**
The existing touch handlers for mobile tilt play should only fire when canHover is true (for hybrid devices). When canHover is false (touch-only), these handlers should be no-ops since tilt is disabled.

Update handleTouchStart (~line 213):
```tsx
const handleTouchStart = useCallback(() => {
  // Only enable mobile tilt play on hybrid devices with hover capability
  if (!shouldEnableTilt) return;
  // ... rest unchanged
}, [shouldEnableTilt]);
```

This is already correct since shouldEnableTilt now includes canHover check.
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Component renders without errors
- On desktop: tilt still works
- Variants properly typed (no TS errors)
  </verify>
  <done>UnifiedMenuItemCard disables tilt on touch devices and provides shadow elevation + lift tap feedback</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   pnpm typecheck && pnpm lint && pnpm lint:css && pnpm build
   ```

2. **Behavior verification (manual):**
   - Desktop with mouse: 3D tilt effect works on menu cards
   - Touch device (or DevTools mobile emulation): Cards stay flat, show shadow lift on tap
   - Reduced motion: All animations respect preference

3. **Code verification:**
   - useCanHover uses `(hover: hover) and (pointer: fine)`
   - globals.css contains shine-sweep keyframes and touch utilities
   - UnifiedMenuItemCard imports and uses useCanHover
</verification>

<success_criteria>
- [ ] useCanHover checks both hover AND fine pointer
- [ ] Touch fallback CSS utilities added (shine-sweep, touch-only, safari fixes)
- [ ] UnifiedMenuItemCard uses canHover to disable tilt on touch
- [ ] Touch tap feedback (shadow + lift) works when tilt disabled
- [ ] Build passes (typecheck, lint, lint:css, build)
</success_criteria>

<output>
After completion, create `.planning/phases/30-mobile-stability/30-01-SUMMARY.md`
</output>
