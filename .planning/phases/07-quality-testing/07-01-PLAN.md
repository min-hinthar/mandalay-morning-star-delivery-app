---
phase: 07-quality-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/v8-overlay-behavior.spec.ts
autonomous: true

must_haves:
  truths:
    - "Header buttons are clickable on home, menu, and checkout pages"
    - "Cart drawer opens with visible content and closes completely"
    - "Dropdowns appear above content and dismiss on outside click"
    - "Closed overlays do not intercept clicks on background content"
  artifacts:
    - path: "e2e/v8-overlay-behavior.spec.ts"
      provides: "E2E tests for V8 overlay behavior"
      min_lines: 150
      contains: "test.describe"
  key_links:
    - from: "e2e/v8-overlay-behavior.spec.ts"
      to: "[data-testid='cart-button']"
      via: "Playwright locator"
      pattern: "data-testid.*cart-button"
    - from: "e2e/v8-overlay-behavior.spec.ts"
      to: "[data-testid='overlay-backdrop']"
      via: "DOM removal verification"
      pattern: "\\.count\\(\\).*0"
---

<objective>
Create E2E tests verifying V8 overlay clickability and DOM removal behavior.

Purpose: Validate the core V7->V8 fix: overlays no longer block clicks when closed because AnimatePresence fully removes them from DOM.
Output: `e2e/v8-overlay-behavior.spec.ts` covering TEST-01 through TEST-04
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-quality-testing/07-RESEARCH.md
@e2e/happy-path.spec.ts
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Header clickability tests (TEST-01)</name>
  <files>e2e/v8-overlay-behavior.spec.ts</files>
  <action>
Create `e2e/v8-overlay-behavior.spec.ts` with:

```typescript
import { test, expect } from "@playwright/test";

/**
 * V8 Overlay Behavior Tests
 * Validates clickability and DOM removal for V8 overlays.
 * Critical verification that AnimatePresence removes elements from DOM.
 */

test.describe("Header Clickability (TEST-01)", () => {
  const routes = ["/", "/menu", "/checkout"];

  for (const route of routes) {
    test(`header buttons clickable on ${route}`, async ({ page }) => {
      await page.goto(route);
      await page.waitForLoadState("networkidle");

      // Cart button should be clickable
      const cartButton = page.locator('[data-testid="cart-button"]');
      if (await cartButton.isVisible()) {
        await expect(cartButton).toBeEnabled();
        await cartButton.click();
        // Should open drawer/sheet dialog
        await expect(page.getByRole("dialog")).toBeVisible();
        await page.keyboard.press("Escape");
        await page.waitForTimeout(400); // Wait for exit animation
      }
    });
  }

  test.describe("Mobile", () => {
    test.use({ viewport: { width: 375, height: 667 } });

    test("mobile menu button clickable", async ({ page }) => {
      await page.goto("/");
      await page.waitForLoadState("networkidle");

      // Look for hamburger/menu button
      const menuButton = page.getByRole("button", { name: /menu/i });
      if (await menuButton.isVisible()) {
        await menuButton.click();
        // Should open mobile menu
        await expect(page.getByRole("navigation")).toBeVisible();
      }
    });
  });
});
```

Patterns:
- Use `test.use({ viewport })` at describe level for mobile tests
- Wait 400ms after Escape for exit animation
- Check `isVisible()` before interacting (routes may vary)
  </action>
  <verify>File exists at `e2e/v8-overlay-behavior.spec.ts` with Header Clickability describe block</verify>
  <done>TEST-01 tests written for header clickability on /, /menu, /checkout routes including mobile</done>
</task>

<task type="auto">
  <name>Task 2: Cart drawer behavior tests (TEST-02)</name>
  <files>e2e/v8-overlay-behavior.spec.ts</files>
  <action>
Add Cart Drawer Behavior test describe block to `e2e/v8-overlay-behavior.spec.ts`:

```typescript
test.describe("Cart Drawer Behavior (TEST-02)", () => {
  test.beforeEach(async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");

    // Add item to cart to enable drawer content
    const menuItem = page.locator('[data-testid="menu-item"]').first();
    if (await menuItem.isVisible()) {
      await menuItem.click();
      await page.getByRole("button", { name: /add to cart/i }).click();
      await page.keyboard.press("Escape");
      await page.waitForTimeout(400);
    }
  });

  test("cart drawer opens with visible content", async ({ page }) => {
    const cartButton = page.locator('[data-testid="cart-button"]');
    await cartButton.click();

    const drawer = page.getByRole("dialog");
    await expect(drawer).toBeVisible();

    // Content should be visible
    await expect(page.getByText(/your cart|cart/i)).toBeVisible();
    await expect(page.getByText(/subtotal/i)).toBeVisible();
  });

  test("cart drawer closes completely on Escape", async ({ page }) => {
    const cartButton = page.locator('[data-testid="cart-button"]');
    await cartButton.click();
    await expect(page.getByRole("dialog")).toBeVisible();

    await page.keyboard.press("Escape");
    await page.waitForTimeout(400); // Exit animation

    // Verify DOM removal, not just visibility
    await expect(page.getByRole("dialog")).not.toBeVisible();
    const backdropCount = await page.locator('[data-testid="overlay-backdrop"]').count();
    expect(backdropCount).toBe(0);
  });

  test("cart drawer closes on backdrop click", async ({ page }) => {
    const cartButton = page.locator('[data-testid="cart-button"]');
    await cartButton.click();
    await expect(page.getByRole("dialog")).toBeVisible();

    // Click backdrop
    await page.locator('[data-testid="overlay-backdrop"]').click();
    await page.waitForTimeout(400);

    await expect(page.getByRole("dialog")).not.toBeVisible();
  });

  test.describe("Mobile", () => {
    test.use({ viewport: { width: 375, height: 667 } });

    test("cart renders as bottom sheet on mobile", async ({ page }) => {
      const cartButton = page.locator('[data-testid="cart-button"]');
      await cartButton.click();

      // On mobile, CartDrawerV8 uses BottomSheet
      const sheet = page.locator('[data-testid="bottom-sheet-content"]');
      await expect(sheet).toBeVisible();
    });
  });
});
```

Critical patterns:
- Use `.count()` to verify DOM removal (not just `not.toBeVisible()`)
- Wait 400ms for AnimatePresence exit animation
- Test both desktop (Drawer) and mobile (BottomSheet) rendering
  </action>
  <verify>`pnpm exec playwright test e2e/v8-overlay-behavior.spec.ts --grep "TEST-02" --list` lists cart drawer tests</verify>
  <done>TEST-02 tests verify cart drawer opens with content, closes on Escape/backdrop, DOM fully removed</done>
</task>

<task type="auto">
  <name>Task 3: Dropdown dismissal and no-blocking tests (TEST-03, TEST-04)</name>
  <files>e2e/v8-overlay-behavior.spec.ts</files>
  <action>
Add Dropdown and No-Blocking test describe blocks to `e2e/v8-overlay-behavior.spec.ts`:

```typescript
test.describe("Dropdown Visibility and Dismissal (TEST-03)", () => {
  test("dropdown appears above page content", async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");

    // Find dropdown trigger (profile button or similar)
    const dropdownTrigger = page.locator('[data-testid="profile-button"]');

    if (await dropdownTrigger.isVisible()) {
      await dropdownTrigger.click();

      const dropdownContent = page.locator('[data-testid="dropdown-content"]');
      await expect(dropdownContent).toBeVisible();

      // Verify dropdown is above other content (z-index working)
      const dropdownBox = await dropdownContent.boundingBox();
      expect(dropdownBox).not.toBeNull();
    }
  });

  test("dropdown dismisses on outside click", async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");

    const dropdownTrigger = page.locator('[data-testid="profile-button"]');

    if (await dropdownTrigger.isVisible()) {
      await dropdownTrigger.click();
      await expect(page.locator('[data-testid="dropdown-content"]')).toBeVisible();

      // Click outside (mousedown triggers close in V8 Dropdown)
      await page.locator("body").click({ position: { x: 10, y: 10 } });
      await page.waitForTimeout(300);

      // Verify DOM removal
      const dropdownCount = await page.locator('[data-testid="dropdown-content"]').count();
      expect(dropdownCount).toBe(0);
    }
  });

  test("dropdown dismisses on Escape", async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");

    const dropdownTrigger = page.locator('[data-testid="profile-button"]');

    if (await dropdownTrigger.isVisible()) {
      await dropdownTrigger.click();
      await expect(page.locator('[data-testid="dropdown-content"]')).toBeVisible();

      await page.keyboard.press("Escape");
      await page.waitForTimeout(300);

      await expect(page.locator('[data-testid="dropdown-content"]')).not.toBeVisible();
    }
  });
});

test.describe("Overlay No Background Blocking (TEST-04)", () => {
  test("closed cart drawer does not block menu item clicks", async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");

    // Add item to cart
    const firstItem = page.locator('[data-testid="menu-item"]').first();
    await firstItem.click();
    await page.getByRole("button", { name: /add to cart/i }).click();
    await page.keyboard.press("Escape");
    await page.waitForTimeout(400);

    // Open and close cart drawer
    await page.locator('[data-testid="cart-button"]').click();
    await expect(page.getByRole("dialog")).toBeVisible();
    await page.keyboard.press("Escape");
    await page.waitForTimeout(400);

    // Critical test: click menu item AFTER drawer closed
    const secondItem = page.locator('[data-testid="menu-item"]').nth(1);
    if (await secondItem.isVisible()) {
      await secondItem.click();
      // If overlay was blocking, this click would fail
      await expect(page.getByRole("dialog")).toBeVisible();
    }
  });

  test("closed modal does not block page interaction", async ({ page }) => {
    await page.goto("/");
    await page.waitForLoadState("networkidle");

    // Open item modal
    const menuItem = page.locator('[data-testid="menu-item"]').first();
    await menuItem.click();
    await expect(page.getByRole("dialog")).toBeVisible();

    // Close modal
    await page.keyboard.press("Escape");
    await page.waitForTimeout(400);

    // Verify DOM removal
    const modalBackdropCount = await page.locator('[data-testid="modal-backdrop"]').count();
    expect(modalBackdropCount).toBe(0);

    // Click another menu item - should work
    const secondItem = page.locator('[data-testid="menu-item"]').nth(1);
    if (await secondItem.isVisible()) {
      await secondItem.click();
      await expect(page.getByRole("dialog")).toBeVisible();
    }
  });

  test("closed bottom sheet does not block scrolling", async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto("/");
    await page.waitForLoadState("networkidle");

    // Open item detail (shows as bottom sheet on mobile)
    await page.locator('[data-testid="menu-item"]').first().click();
    await expect(page.getByRole("dialog")).toBeVisible();

    // Close
    await page.keyboard.press("Escape");
    await page.waitForTimeout(400);

    // Verify DOM removal
    const sheetBackdropCount = await page.locator('[data-testid="bottom-sheet-backdrop"]').count();
    expect(sheetBackdropCount).toBe(0);

    // Page should be scrollable
    await page.evaluate(() => window.scrollTo(0, 200));
    const scrollY = await page.evaluate(() => window.scrollY);
    expect(scrollY).toBeGreaterThan(0);
  });
});
```

Critical patterns:
- Verify `.count() === 0` for backdrop elements after close
- Test interaction AFTER overlay close (the V7 bug was overlays blocking when closed)
- Conditional tests with `if (await element.isVisible())` for optional elements
  </action>
  <verify>`pnpm exec playwright test e2e/v8-overlay-behavior.spec.ts --list` shows all test cases</verify>
  <done>TEST-03 (dropdown dismissal) and TEST-04 (no background blocking) tests written with DOM removal verification</done>
</task>

</tasks>

<verification>
Run tests to verify all pass:
```bash
pnpm exec playwright test e2e/v8-overlay-behavior.spec.ts
```

Test coverage should include:
- TEST-01: Header clickability on 3 routes + mobile
- TEST-02: Cart drawer open/close/DOM removal
- TEST-03: Dropdown visibility and dismissal
- TEST-04: Closed overlays don't block background
</verification>

<success_criteria>
- [ ] `e2e/v8-overlay-behavior.spec.ts` exists with 150+ lines
- [ ] Header clickability tests cover /, /menu, /checkout
- [ ] Cart drawer tests verify DOM removal with `.count() === 0`
- [ ] Dropdown tests verify outside click dismissal
- [ ] Background blocking tests verify clicks work after overlay close
- [ ] Mobile viewport tests included for responsive components
</success_criteria>

<output>
After completion, create `.planning/phases/07-quality-testing/07-01-SUMMARY.md`
</output>
