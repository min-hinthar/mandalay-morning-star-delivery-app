---
phase: 25-audit-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/audit-tokens.js
  - eslint.config.mjs
  - package.json
  - .planning/audit-report.md
autonomous: true

must_haves:
  truths:
    - "Running `pnpm audit:tokens` produces terminal output with violation counts"
    - "Running `pnpm audit:tokens` generates `.planning/audit-report.md` with full violation details"
    - "ESLint catches text-white, text-black, bg-white, bg-black in component files"
    - "Audit script exits with code 1 when violations increase from baseline"
    - "Report shows violations organized by-file AND by-type"
  artifacts:
    - path: "scripts/audit-tokens.js"
      provides: "Comprehensive token violation detection"
      min_lines: 300
    - path: ".planning/audit-report.md"
      provides: "Baseline violation inventory"
      contains: "## Baseline"
    - path: "eslint.config.mjs"
      provides: "Extended color token enforcement rules"
      contains: "text-white"
    - path: "package.json"
      provides: "audit:tokens script command"
      contains: "audit:tokens"
  key_links:
    - from: "package.json"
      to: "scripts/audit-tokens.js"
      via: "npm script"
      pattern: "node scripts/audit-tokens"
    - from: "scripts/audit-tokens.js"
      to: ".planning/audit-report.md"
      via: "file write"
      pattern: "writeFileSync.*audit-report"
---

<objective>
Build automated token violation detection infrastructure.

Purpose: Establish complete visibility into 221+ hardcoded color violations and enable regression prevention. This audit becomes the source of truth for tracking progress toward zero violations across v1.3.

Output:
- `scripts/audit-tokens.js` - comprehensive audit script with terminal progress and markdown report
- Extended ESLint rules catching common hardcoded colors
- `pnpm audit:tokens` command
- Initial `.planning/audit-report.md` baseline
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-audit-infrastructure/25-CONTEXT.md
@.planning/phases/25-audit-infrastructure/25-RESEARCH.md
@eslint.config.mjs
@package.json
@src/styles/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive audit script</name>
  <files>scripts/audit-tokens.js</files>
  <action>
Create `scripts/audit-tokens.js` that implements multi-category token violation detection.

**Detection patterns (all categories):**

Colors (CRITICAL when user-facing):
- `text-white`, `text-black`, `bg-white`, `bg-black` (plain classes)
- `text-white/\d+`, `bg-black/\d+` etc. (opacity variants)
- `text-[#hex]`, `bg-[#hex]`, `border-[#hex]` (bracket syntax)
- `border-white`, `border-black`
- Inline `style={{` with `color:`, `backgroundColor:` containing `#hex` or `rgb(`

Spacing (WARNING):
- Arbitrary Tailwind values like `p-[17px]`, `m-[23px]`
- Inline `style={{` with hardcoded `px` values for margin/padding

Effects (WARNING):
- Hardcoded `shadow-[...]` values
- Hardcoded `blur-[...]` values
- Hardcoded `transition-[...]` duration values

Deprecated (WARNING):
- `v6-`, `v7-` prefixed patterns
- `v7Palette`, `v7Palettes` references

Duplicate Imports (WARNING):
- Files importing from BOTH `@/components/ui/` AND `@/components/ui-v8/`

**File severity classification:**
- CRITICAL: `src/app/(public)/*`, `src/app/(customer)/*`, `src/components/homepage/*`, `src/components/menu/*`, `src/components/checkout/*`, `src/components/cart/*`, `src/components/ui/*`, `src/components/ui-v8/*`, `src/components/tracking/*`
- WARNING: `src/app/(admin)/*`, `src/components/admin/*`, `src/app/(driver)/*`, `src/components/driver/*`, `src/app/(auth)/*`, `src/components/auth/*`
- INFO: `*.stories.tsx`, `*.test.tsx`, `src/stories/*`

**Combined severity:** Violation severity = max(file_severity, pattern_severity)

**Terminal output features:**
- TTY detection (`process.stdout.isTTY`) for colors and progress bar
- Progress bar showing scan progress (file count)
- Summary counts by category and severity
- Top 10 files with most violations (for quick wins)
- Suggested fixes inline (e.g., `text-white -> text-text-inverse`)

**Report generation (.planning/audit-report.md):**
- Header with timestamp, files scanned, total violations
- Summary table by category
- By-type section: all violations grouped by pattern type
- By-file section: sorted by severity then violation count
- Each violation shows: file:line, pattern, suggested fix
- Baseline section at bottom with:
  - Current counts per category
  - Historical trend (last 5 runs)
  - Delta from previous run

**Exit codes:**
- 0: No violations (clean)
- 1: Critical violations found OR regression detected
- 2: Warnings but no critical
- 3: Info only

**Baseline handling:**
- Read existing baseline from `.planning/audit-report.md` if exists
- Compare current vs previous counts
- Auto-update baseline ONLY if counts decrease
- If ANY category count increases: exit 1 with regression warning

**Suggested fix mappings:**
```javascript
const FIX_SUGGESTIONS = {
  'text-white': 'text-text-inverse (or text-hero-text in hero sections)',
  'text-black': 'text-text-primary',
  'bg-white': 'bg-surface-primary',
  'bg-black': 'bg-surface-inverse or bg-[var(--color-text-primary)]',
  'border-white': 'border-border-default or border-text-inverse',
  'border-black': 'border-border-strong',
};
```

**Technical requirements:**
- Use Node.js built-ins only (fs, path, process)
- Use `node:fs/promises` for async file reading
- Glob pattern matching via custom implementation (avoid external deps)
- Handle Windows/Unix path differences
- Handle template literals: `className={\`bg-white ${x}\`}`
- Handle cn() calls: `cn("bg-white", other)`
- Parse CSS files differently than TSX files
  </action>
  <verify>
Run `node scripts/audit-tokens.js` and verify:
1. Terminal shows progress bar and summary
2. Exit code is 1 (critical violations exist)
3. `.planning/audit-report.md` is created with baseline
  </verify>
  <done>
Audit script detects all hardcoded colors with file:line locations, generates markdown report, and establishes baseline of 221+ primary violations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend ESLint rules and add npm script</name>
  <files>eslint.config.mjs, package.json</files>
  <action>
**Extend eslint.config.mjs:**

Add new `no-restricted-syntax` selectors to the existing design token enforcement block:

```javascript
// Catch hardcoded color classes in string literals
{
  selector: "Literal[value=/\\btext-white\\b/]",
  message: "Use semantic token: text-text-inverse or text-hero-text instead of text-white",
},
{
  selector: "Literal[value=/\\btext-black\\b/]",
  message: "Use semantic token: text-text-primary instead of text-black",
},
{
  selector: "Literal[value=/\\bbg-white\\b/]",
  message: "Use semantic token: bg-surface-primary instead of bg-white",
},
{
  selector: "Literal[value=/\\bbg-black\\b/]",
  message: "Use semantic token: bg-surface-inverse instead of bg-black",
},
```

Keep severity at "warn" level initially to avoid breaking the build during migration. The audit script handles enforcement via exit codes.

**Add package.json script:**

Add to the "scripts" section:
```json
"audit:tokens": "node scripts/audit-tokens.js"
```

Place it alphabetically near other audit/analysis scripts.
  </action>
  <verify>
Run these commands and verify:
1. `pnpm lint` completes (may show warnings for hardcoded colors)
2. `pnpm audit:tokens` runs successfully
3. Both commands produce expected output
  </verify>
  <done>
ESLint rules catch text-white/black and bg-white/black patterns at warning level. `pnpm audit:tokens` command is available.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate initial baseline report</name>
  <files>.planning/audit-report.md</files>
  <action>
Run the audit script to generate the initial baseline report.

After running, verify the report contains:
1. Header with accurate timestamp
2. Summary table showing all violation categories
3. By-type section with grouped violations
4. By-file section sorted by priority (critical files first)
5. Baseline section at bottom

**Expected baseline structure:**
```markdown
## Baseline

### Current Run
| Category | Critical | Warning | Info | Total |
|----------|----------|---------|------|-------|
| Colors   | XX       | XX      | 0    | XXX   |
| Spacing  | 0        | XX      | XX   | XX    |
| Effects  | 0        | XX      | XX   | XX    |
| Deprecated | 0      | XX      | 0    | XX    |
| Imports  | 0        | XX      | 0    | XX    |

### Historical Trend
| Run | Date | Critical | Warning | Info | Total |
|-----|------|----------|---------|------|-------|
| 1   | YYYY-MM-DD | XX | XX | XX | XXX |

### Category Baselines
- colors: XXX
- spacing: XX
- effects: XX
- deprecated: XX
- imports: XX
```

The numbers will be populated from the actual scan results.
  </action>
  <verify>
1. File `.planning/audit-report.md` exists
2. Contains "## Baseline" section
3. Contains both by-file and by-type views
4. Total violations >= 221 (known baseline from research)
5. Running `pnpm audit:tokens` again shows delta of 0
  </verify>
  <done>
Initial baseline established with 221+ primary color violations documented. Regression detection active for future runs.
  </done>
</task>

</tasks>

<verification>
Run the complete verification sequence:

```bash
# 1. Verify audit script runs and produces output
node scripts/audit-tokens.js
echo "Exit code: $?"

# 2. Verify ESLint catches violations (will show warnings)
pnpm lint 2>&1 | grep -E "(text-white|bg-white)" | head -5

# 3. Verify npm script works
pnpm audit:tokens

# 4. Verify report exists with required sections
test -f .planning/audit-report.md && echo "Report exists"
grep -q "## Baseline" .planning/audit-report.md && echo "Has baseline section"
grep -q "By File" .planning/audit-report.md && echo "Has by-file section"
grep -q "By Type" .planning/audit-report.md && echo "Has by-type section"

# 5. Test regression detection (run twice, should show delta: 0)
pnpm audit:tokens
pnpm audit:tokens
```
</verification>

<success_criteria>
1. `pnpm audit:tokens` runs without errors and produces terminal summary
2. Terminal output shows progress bar, violation counts, and top files
3. `.planning/audit-report.md` exists with complete baseline
4. Report shows >= 221 primary color violations (matching research baseline)
5. Report contains both by-file AND by-type violation views
6. Each violation includes file:line location and suggested fix
7. ESLint `pnpm lint` catches text-white/black and bg-white/black patterns
8. Running audit twice shows "delta: 0" (no regression)
9. Exit code is 1 when critical violations exist
10. Baseline auto-updates only when violations decrease
</success_criteria>

<output>
After completion, create `.planning/phases/25-audit-infrastructure/25-01-SUMMARY.md`
</output>
