---
phase: 17-3d-hero-advanced
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - package.json
  - pnpm-lock.yaml
  - src/components/3d/carousel/FoodCarousel.tsx
  - src/components/3d/carousel/CarouselDots.tsx
  - src/components/3d/particles/ParticleSystem.tsx
  - src/components/3d/particles/presets.ts
  - src/components/3d/Hero3DCanvas.tsx
  - src/components/homepage/Hero3DSection.tsx
  - public/models/noodles.glb
  - public/models/salad.glb
autonomous: false

must_haves:
  truths:
    - "User can swipe left/right to change food model"
    - "User can click dot indicators to jump to specific model"
    - "Carousel auto-advances every 6 seconds when not interacting"
    - "Model transitions with 3D spin (180-degree rotation)"
    - "Particles emit while dragging the model (subtle trail)"
    - "Particles burst on drag release (30-50 particles)"
    - "Particle style matches food type (steam for hot, sparkles for dessert, herbs for salad)"
  artifacts:
    - path: "src/components/3d/carousel/FoodCarousel.tsx"
      provides: "Carousel logic with swipe, auto-advance, spin transition"
      exports: ["FoodCarousel", "FOOD_MODELS"]
    - path: "src/components/3d/carousel/CarouselDots.tsx"
      provides: "Dot navigation UI"
      exports: ["CarouselDots"]
    - path: "src/components/3d/particles/ParticleSystem.tsx"
      provides: "VFX particle system with emission controls"
      exports: ["ParticleSystem"]
    - path: "src/components/3d/particles/presets.ts"
      provides: "Particle presets for hot, fresh, sweet food types"
      exports: ["PARTICLE_PRESETS"]
    - path: "public/models/noodles.glb"
      provides: "Second food model for carousel"
    - path: "public/models/salad.glb"
      provides: "Third food model for carousel"
  key_links:
    - from: "src/components/3d/Hero3DCanvas.tsx"
      to: "src/components/3d/carousel/FoodCarousel.tsx"
      via: "import and render"
      pattern: "import.*FoodCarousel"
    - from: "src/components/3d/carousel/FoodCarousel.tsx"
      to: "src/components/3d/particles/ParticleSystem.tsx"
      via: "interaction callbacks trigger particles"
      pattern: "onInteraction.*emit"
    - from: "src/components/homepage/Hero3DSection.tsx"
      to: "src/components/3d/carousel/CarouselDots.tsx"
      via: "render dots below canvas"
      pattern: "CarouselDots"
---

<objective>
Add food carousel with swipe navigation and contextual particle effects

Purpose: Allow users to browse multiple food models with satisfying swipe gestures and magical 3D transitions. Particles celebrate user interaction with contextual effects (steam for hot dishes, sparkles for desserts).

Output: FoodCarousel with 3 food models, swipe/dot navigation, 180-degree spin transitions, auto-advance, and particle system with drag trail + release burst.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-3d-hero-advanced/17-CONTEXT.md
@.planning/phases/17-3d-hero-advanced/17-RESEARCH.md
@.planning/phases/17-3d-hero-advanced/17-01-SUMMARY.md
@src/components/3d/Hero3DCanvas.tsx
@src/components/3d/controls/RotationController.tsx
@src/components/homepage/Hero3DSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install wawa-vfx and source additional GLB models</name>
  <files>package.json, pnpm-lock.yaml, public/models/noodles.glb, public/models/salad.glb, public/models/ATTRIBUTION.md</files>
  <action>
**Install wawa-vfx for GPU particles:**

```bash
pnpm add wawa-vfx
```

**Source 2 additional food models for carousel:**

The carousel needs 3 food models with different types:
1. rice-bowl.glb (existing) - type: "hot"
2. noodles.glb (new) - type: "hot"
3. salad.glb (new) - type: "fresh"

**Model sourcing approach:**

Try these sources in order:
1. Sketchfab CC0 models - search "noodles glb", "salad glb"
2. Free3D CC0 food models
3. Poly Haven food models
4. Turbosquid free section

Use curl/wget to download GLB files directly. Target file size: under 500KB each for mobile performance.

If external sources fail (like Phase 16), create simple procedural placeholder models in code (similar to FoodModelPlaceholder pattern from Phase 16).

**Update ATTRIBUTION.md** with licenses for any downloaded assets.

**Fallback:** If no suitable GLBs found within 10 minutes, create procedural placeholders:
- NoodlePlaceholder: cylinder bowl + draped "noodle" meshes
- SaladPlaceholder: bowl with green sphere clusters
  </action>
  <verify>
```bash
# wawa-vfx installed
pnpm list wawa-vfx

# Check models exist (or procedural fallback code exists)
ls public/models/*.glb | wc -l
# Should be 3 (or 1 if using procedural fallbacks)
```
  </verify>
  <done>
wawa-vfx installed.
3 food models available (GLB files or procedural placeholders).
ATTRIBUTION.md updated if external assets used.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FoodCarousel and CarouselDots components</name>
  <files>src/components/3d/carousel/FoodCarousel.tsx, src/components/3d/carousel/CarouselDots.tsx</files>
  <action>
**FoodCarousel.tsx:**

Create carousel component that manages multiple food models with swipe navigation.

**Requirements from CONTEXT.md:**
- Navigation: swipe gestures AND clickable dot indicators
- Transition: 3D spin (scene rotates 180 degrees revealing new model)
- Auto-advance: every 6 seconds when not interacting
- Stop auto-advance during user interaction (drag or hover)

**Implementation:**

```typescript
// Model registry with food types for particle selection
export const FOOD_MODELS = [
  { id: "rice-bowl", url: "/models/rice-bowl.glb", type: "hot" as const, name: "Rice Bowl" },
  { id: "noodles", url: "/models/noodles.glb", type: "hot" as const, name: "Noodles" },
  { id: "salad", url: "/models/salad.glb", type: "fresh" as const, name: "Salad" },
];

interface FoodCarouselProps {
  onModelChange?: (model: typeof FOOD_MODELS[number]) => void;
  onInteractionStart?: () => void;
  onInteractionEnd?: (velocity: [number, number]) => void;
}
```

**State machine:**
1. idle: auto-rotating, auto-advancing carousel
2. interacting: user dragging model, no auto-advance
3. transitioning: 180-degree spin animation playing

**Swipe detection:**
Use @use-gesture/react useDrag with `axis: "x"` and velocity threshold (0.3) for swipe.

**Spin transition using @react-spring/three:**
1. Spin out: rotationY 0 -> PI, opacity 1 -> 0
2. Change model (instant, model hidden)
3. Spin in: rotationY -PI -> 0, opacity 0 -> 1

**Auto-advance timer:**
- useEffect with setInterval (6000ms)
- Clear on interaction start
- Restart on interaction end (after resume delay)

**CarouselDots.tsx:**

Simple UI component for dot navigation.

```typescript
interface CarouselDotsProps {
  total: number;
  activeIndex: number;
  onSelect: (index: number) => void;
  className?: string;
}
```

Style:
- Inactive: `w-2 h-2 rounded-full bg-white/30`
- Active: `w-6 h-2 rounded-full bg-primary` (pill shape)
- Transition: `transition-all duration-300`

This component renders OUTSIDE the Canvas (in Hero3DSection), so use normal React/Tailwind.
  </action>
  <verify>
```bash
# Files exist
ls src/components/3d/carousel/

# Exports correct
grep -l "export.*FoodCarousel" src/components/3d/carousel/FoodCarousel.tsx
grep -l "export.*CarouselDots" src/components/3d/carousel/CarouselDots.tsx
```
  </verify>
  <done>
FoodCarousel.tsx with swipe, spin transition, auto-advance.
CarouselDots.tsx with active/inactive states.
FOOD_MODELS array with 3 models.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ParticleSystem with contextual presets</name>
  <files>src/components/3d/particles/ParticleSystem.tsx, src/components/3d/particles/presets.ts</files>
  <action>
**presets.ts:**

Define particle presets for each food type:

```typescript
export type FoodType = "hot" | "fresh" | "sweet";

export const PARTICLE_PRESETS: Record<FoodType, ParticlePreset> = {
  hot: {
    // Steam/smoke for rice bowl, noodles
    particles: {
      nbParticles: 100,
      gravity: [0, 0.5, 0],     // Float upward
      fadeSize: [1, 0.5],
      fadeOpacity: [1, 0],
      renderMode: "billboard",
      intensity: 1.5,
    },
    trail: { nbParticles: 2, size: [0.05, 0.1], color: "#FFFFFF" },
    burst: { nbParticles: 40, size: [0.1, 0.25], color: ["#FFFFFF", "#CCCCCC"] },
  },
  fresh: {
    // Floating herbs for salads
    particles: {
      nbParticles: 50,
      gravity: [0, -0.1, 0],    // Gentle fall
      fadeOpacity: [1, 0],
      renderMode: "billboard",
    },
    trail: { nbParticles: 2, size: [0.03, 0.08], color: "#52A52E" },
    burst: { nbParticles: 30, size: [0.05, 0.15], color: ["#52A52E", "#7CB342", "#8BC34A"] },
  },
  sweet: {
    // Sparkles for desserts (not used in initial 3 models, but available)
    particles: {
      nbParticles: 80,
      gravity: [0, -0.3, 0],
      fadeSize: [0, 0.5],
      fadeOpacity: [0.5, 1, 0],
      renderMode: "billboard",
      intensity: 3,
    },
    trail: { nbParticles: 3, size: [0.02, 0.05], color: "#FFD700" },
    burst: { nbParticles: 50, size: [0.02, 0.08], color: ["#FFD700", "#FFF8DC", "#FFFFFF"] },
  },
};
```

**ParticleSystem.tsx:**

Component that wraps wawa-vfx VFXParticles and exposes emission controls.

**Props:**
```typescript
interface ParticleSystemProps {
  foodType: FoodType;
  isTrailActive: boolean;       // True during drag
  triggerBurst: boolean;        // True on release
  position?: [number, number, number];
}
```

**Behavior:**
- Trail: Emit small particles every 100ms while `isTrailActive` is true
- Burst: Emit 30-50 particles when `triggerBurst` transitions true -> false

**Important from RESEARCH.md:**
- Only emit on USER interaction, NOT during auto-rotation
- Set `intensity > 0` for visibility
- Use `renderMode: "billboard"` so particles always face camera

**Performance:**
- Steam trail: 2-3 particles per emission
- Burst: 30-50 particles once
- Total pool: ~200 particles max
  </action>
  <verify>
```bash
# Files exist
ls src/components/3d/particles/

# Exports
grep -l "PARTICLE_PRESETS" src/components/3d/particles/presets.ts
grep -l "ParticleSystem" src/components/3d/particles/ParticleSystem.tsx
```
  </verify>
  <done>
presets.ts with hot/fresh/sweet particle configs.
ParticleSystem.tsx with trail and burst emission.
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire everything into Hero3DCanvas and Hero3DSection</name>
  <files>src/components/3d/Hero3DCanvas.tsx, src/components/homepage/Hero3DSection.tsx</files>
  <action>
**Hero3DCanvas.tsx changes:**

Replace single FoodModel with FoodCarousel:

```tsx
// Before (from Plan 01)
<RotationController ...>
  <FoodModel url="/models/rice-bowl.glb" ... />
</RotationController>

// After
<FoodCarousel
  onModelChange={handleModelChange}
  onInteractionStart={handleInteractionStart}
  onInteractionEnd={handleInteractionEnd}
/>
<ParticleSystem
  foodType={currentFoodType}
  isTrailActive={isDragging}
  triggerBurst={justReleased}
/>
```

**State to track:**
- currentFoodType: for particle preset selection
- activeIndex: for CarouselDots (lift state up)
- isDragging: for trail particles
- justReleased: for burst trigger

**Hero3DSection.tsx changes:**

Add CarouselDots below the Canvas:

```tsx
<div className="relative">
  {/* 3D Canvas */}
  {shouldRender3D ? <Hero3DCanvas ... /> : <Hero2DFallback />}

  {/* Carousel dots - only show if 3D and multiple models */}
  {shouldRender3D && (
    <CarouselDots
      total={3}
      activeIndex={activeIndex}
      onSelect={handleDotSelect}
      className="absolute bottom-4 left-1/2 -translate-x-1/2"
    />
  )}
</div>
```

**Lift state pattern:**
Hero3DSection manages carousel state (activeIndex).
Pass down to Hero3DCanvas -> FoodCarousel.
Pass down to CarouselDots.

**Integration test points:**
1. Swipe left/right changes model with spin
2. Clicking dot jumps to that model
3. Dragging creates trail particles
4. Releasing creates burst
5. 6-second auto-advance works
6. Build passes
  </action>
  <verify>
```bash
# Build passes
pnpm build

# Hero3DCanvas uses FoodCarousel
grep -q "FoodCarousel" src/components/3d/Hero3DCanvas.tsx

# Hero3DSection has CarouselDots
grep -q "CarouselDots" src/components/homepage/Hero3DSection.tsx
```
  </verify>
  <done>
FoodCarousel integrated into Hero3DCanvas.
ParticleSystem wired to interaction callbacks.
CarouselDots rendered in Hero3DSection.
State properly lifted for coordination.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete 3D hero advanced features:
- Food carousel with 3 models (swipe + dot navigation)
- 180-degree spin transitions
- Auto-advance every 6 seconds
- Particle trail while dragging
- Particle burst on release
- Contextual particles per food type
  </what-built>
  <how-to-verify>
1. Open http://localhost:3000

2. Test auto-rotation (from Plan 01):
   - Model should be slowly rotating
   - Hover or touch stops rotation instantly
   - Wait 4 seconds - rotation resumes in opposite direction

3. Test momentum (from Plan 01):
   - Drag and throw the model quickly
   - Should spin multiple times with smooth deceleration
   - Model stays where it stops (no snap-back)

4. Test carousel swipe:
   - Swipe left on the model
   - Model should spin 180 degrees and reveal next model
   - Swipe right to go back

5. Test carousel dots:
   - Click the dot indicators below the model
   - Should jump directly to that model with spin transition

6. Test auto-advance:
   - Don't interact for 6+ seconds
   - Carousel should automatically advance to next model

7. Test particles:
   - Drag the model slowly - should see subtle particle trail
   - Release with velocity - should see particle burst (30-50 particles)
   - Different food types should have different particle colors:
     - Rice bowl/Noodles: white steam
     - Salad: green herbs

8. Test mobile (device preview or real device):
   - Touch and drag works
   - Swipe carousel works
   - Particles emit on touch interaction
  </how-to-verify>
  <resume-signal>Type "approved" if all features work. Describe any issues for fixes.</resume-signal>
</task>

</tasks>

<verification>
All must-have truths verified:
- [ ] Swipe left/right changes food model
- [ ] Dot clicks navigate carousel
- [ ] Auto-advance every 6 seconds (observe)
- [ ] Spin transition (180-degree rotation)
- [ ] Trail particles during drag
- [ ] Burst particles on release
- [ ] Particle style matches food type

Build verification:
```bash
pnpm lint && pnpm typecheck && pnpm build
```
</verification>

<success_criteria>
- wawa-vfx installed
- 3 food models available (GLB or procedural)
- FoodCarousel with swipe, dots, auto-advance, spin transition
- ParticleSystem with trail and burst
- Contextual particle presets (hot/fresh/sweet)
- Everything wired in Hero3DCanvas and Hero3DSection
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/17-3d-hero-advanced/17-02-SUMMARY.md`
</output>
