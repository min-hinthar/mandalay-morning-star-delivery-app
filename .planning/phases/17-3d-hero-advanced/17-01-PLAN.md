---
phase: 17-3d-hero-advanced
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - src/components/3d/controls/RotationController.tsx
  - src/components/3d/Hero3DCanvas.tsx
  - src/components/3d/models/FoodModel.tsx
autonomous: true

must_haves:
  truths:
    - "Model auto-rotates slowly when user is not interacting"
    - "Auto-rotation stops instantly on hover/touch"
    - "Auto-rotation resumes after 4 seconds of no interaction"
    - "Auto-rotation direction alternates after each interaction"
    - "Drag has weighty momentum - hard throws spin multiple rotations"
    - "Momentum decelerates smoothly like a lazy susan"
    - "Model stays wherever user left it (no spring-back to home)"
    - "Polar angle limits have rubber band overscroll effect"
  artifacts:
    - path: "src/components/3d/controls/RotationController.tsx"
      provides: "Auto-rotation + momentum + rubber band physics"
      exports: ["RotationController"]
    - path: "src/components/3d/Hero3DCanvas.tsx"
      provides: "Updated canvas using RotationController"
      contains: "RotationController"
  key_links:
    - from: "src/components/3d/Hero3DCanvas.tsx"
      to: "src/components/3d/controls/RotationController.tsx"
      via: "import and wrap FoodModel"
      pattern: "import.*RotationController"
    - from: "src/components/3d/controls/RotationController.tsx"
      to: "@use-gesture/react"
      via: "useDrag hook for velocity"
      pattern: "useDrag"
    - from: "src/components/3d/controls/RotationController.tsx"
      to: "@react-spring/three"
      via: "useSpring for momentum decay"
      pattern: "useSpring.*decay"
---

<objective>
Add auto-rotation and physics-based momentum to 3D hero model

Purpose: Make the 3D hero feel alive and interactive. Auto-rotation showcases the model when idle. Physics momentum gives a weighty, satisfying feel like spinning a lazy susan.

Output: RotationController component with auto-rotate, momentum physics, and rubber band polar limits. OrbitControls replaced with gesture-based rotation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-3d-hero-advanced/17-CONTEXT.md
@.planning/phases/17-3d-hero-advanced/17-RESEARCH.md
@src/components/3d/Hero3DCanvas.tsx
@src/components/3d/models/FoodModel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @use-gesture/react</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
Install gesture library for velocity-based drag handling:

```bash
pnpm add @use-gesture/react
```

This library provides:
- useDrag hook with velocity and direction
- Touch support built-in
- Works with @react-spring (already installed)

Note: @react-spring/three is already installed from Phase 16.
  </action>
  <verify>
```bash
pnpm list @use-gesture/react
```
Shows version ^10.x installed.
  </verify>
  <done>@use-gesture/react appears in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create RotationController with auto-rotate and momentum</name>
  <files>src/components/3d/controls/RotationController.tsx</files>
  <action>
Create RotationController component that replaces OrbitControls with custom rotation logic.

**Requirements from CONTEXT.md:**

Auto-rotation:
- Speed: one full rotation every 8-10 seconds (~0.7-0.8 rad/s)
- Instant stop on hover/touch (no deceleration)
- Resume after 4 seconds of no interaction
- Direction alternates after each interaction ends

Momentum physics:
- Weighty feel: slight resistance like spinning a real object
- Unlimited spin: hard throws spin multiple rotations with smooth deceleration
- No spring-back: stays wherever user left it
- Auto-rotation resumes from current position

Rubber band:
- Polar limits: allow ~0.15 rad overscroll past limits
- Resistance when past limits (30% of input)
- Spring back to valid range on release

**Implementation approach:**

1. Use useFrame for auto-rotation (delta-based for frame independence)
2. Use @use-gesture/react useDrag for:
   - Direct rotation during drag
   - Velocity capture on release
3. Use @react-spring/three useSpring for:
   - Smooth momentum decay after release
   - Rubber band snap-back
4. Track interaction state (isInteracting, lastInteractionTime)
5. Track direction (alternates after each interaction)

**Props interface:**
```typescript
interface RotationControllerProps {
  children: React.ReactNode;
  autoRotateSpeed?: number;       // Default: Math.PI / 4.5 (~8s per rotation)
  resumeDelay?: number;           // Default: 4000ms
  polarLimits?: [number, number]; // Default: [PI/4, PI/2.2]
  azimuthLimits?: [number, number]; // Default: [-PI/3, PI/3]
  enableRubberBand?: boolean;     // Default: true
  onInteractionStart?: () => void;
  onInteractionEnd?: (velocity: [number, number]) => void;
}
```

**Key patterns from RESEARCH.md:**
- Use `pointer: { touch: true }` in useDrag for mobile
- Scale velocity by factor (0.5-1.0) for momentum projection
- Use MathUtils.clamp for angle limits
- Use `immediate: true` in spring.set() during drag for responsiveness

**Anti-patterns to avoid:**
- Don't use OrbitControls - conflicts with gesture handling
- Don't emit during auto-rotation (interaction only)
- Don't use decay without velocity (decay needs initial velocity)
  </action>
  <verify>
```bash
# File exists and exports RotationController
grep -l "export.*RotationController" src/components/3d/controls/RotationController.tsx
```
  </verify>
  <done>RotationController.tsx exists with auto-rotate, momentum, and rubber band physics</done>
</task>

<task type="auto">
  <name>Task 3: Replace OrbitControls with RotationController in Hero3DCanvas</name>
  <files>src/components/3d/Hero3DCanvas.tsx, src/components/3d/models/FoodModel.tsx</files>
  <action>
Update Hero3DCanvas to use RotationController instead of OrbitControls.

**Hero3DCanvas.tsx changes:**

1. Remove OrbitControls import from drei
2. Import RotationController from ./controls/RotationController
3. Wrap FoodModel with RotationController
4. Remove OrbitControls component
5. Keep: Canvas, Environment, ContactShadows, Suspense, Hero3DLoader

**Structure after change:**
```tsx
<Canvas>
  <Suspense fallback={<Hero3DLoader />}>
    <RotationController
      autoRotateSpeed={Math.PI / 4.5}
      resumeDelay={4000}
      polarLimits={[Math.PI / 4, Math.PI / 2.2]}
      azimuthLimits={[-Math.PI / 3, Math.PI / 3]}
    >
      <FoodModel url="/models/rice-bowl.glb" shouldAnimate={shouldAnimate} />
    </RotationController>

    <Environment preset="studio" />
    <ContactShadows ... />
    <ambientLight ... />
  </Suspense>
</Canvas>
```

**FoodModel.tsx changes:**

Add interaction callbacks for future particle system:
- onInteractionStart?: () => void
- onInteractionEnd?: () => void

These will be wired in Plan 02 for particle triggering.
  </action>
  <verify>
```bash
# OrbitControls removed
! grep -q "OrbitControls" src/components/3d/Hero3DCanvas.tsx && echo "OrbitControls removed"

# RotationController imported
grep -q "RotationController" src/components/3d/Hero3DCanvas.tsx && echo "RotationController used"

# Build passes
pnpm build
```

Manual check: Open localhost:3000, see 3D model auto-rotating. Touch/hover stops it. Drag and release with velocity - model continues spinning with momentum.
  </verify>
  <done>
Hero3DCanvas uses RotationController, OrbitControls removed.
Model auto-rotates when idle, stops on interaction, resumes after 4s.
Drag momentum works with smooth deceleration.
  </done>
</task>

</tasks>

<verification>
All must-have truths verified:
- [ ] Model auto-rotates slowly when not interacting (observe in browser)
- [ ] Auto-rotation stops instantly on hover/touch
- [ ] Auto-rotation resumes after ~4 seconds idle
- [ ] Direction alternates after interaction (observe reversal)
- [ ] Hard throw causes multiple rotations with smooth decay
- [ ] Model stays where user left it (no snap to home)
- [ ] Polar overscroll has rubber band feel

Build verification:
```bash
pnpm lint && pnpm typecheck && pnpm build
```
</verification>

<success_criteria>
- @use-gesture/react installed
- RotationController component created with all physics behaviors
- Hero3DCanvas uses RotationController (OrbitControls removed)
- Auto-rotate, momentum, and rubber band all functional
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-3d-hero-advanced/17-01-SUMMARY.md`
</output>
