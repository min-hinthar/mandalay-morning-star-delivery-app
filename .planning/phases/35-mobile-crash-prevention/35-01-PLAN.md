---
phase: 35-mobile-crash-prevention
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/35-mobile-crash-prevention/35-AUDIT.md
  - src/lib/hooks/useSafeEffects.ts
  - src/lib/hooks/index.ts
  - .claude/CLEANUP-PATTERNS.md
autonomous: true

must_haves:
  truths:
    - "Audit report documents every file with cleanup issues"
    - "Utility hooks provide safe timeout, interval, and async patterns"
    - "Documentation explains cleanup patterns with code examples"
  artifacts:
    - path: ".planning/phases/35-mobile-crash-prevention/35-AUDIT.md"
      provides: "Comprehensive cleanup audit findings"
      contains: "## Critical Issues"
    - path: "src/lib/hooks/useSafeEffects.ts"
      provides: "Safe cleanup utility hooks"
      exports: ["useMountedRef", "useSafeTimeout", "useSafeInterval", "useSafeAsync"]
      min_lines: 80
    - path: ".claude/CLEANUP-PATTERNS.md"
      provides: "Cleanup pattern documentation"
      contains: "## Timer Cleanup"
  key_links:
    - from: "src/lib/hooks/index.ts"
      to: "src/lib/hooks/useSafeEffects.ts"
      via: "barrel export"
      pattern: "export.*useSafeEffects"
---

<objective>
Audit all components and hooks for cleanup issues, create reusable utility hooks, and document cleanup patterns.

Purpose: Establish foundation for systematic crash prevention by identifying all issues before fixing and providing standardized tools.
Output: AUDIT.md report, useSafeEffects.ts utility hooks, CLEANUP-PATTERNS.md documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-mobile-crash-prevention/35-CONTEXT.md
@.planning/phases/35-mobile-crash-prevention/35-RESEARCH.md
@src/lib/hooks/useBodyScrollLock.ts
@src/lib/gsap/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comprehensive Cleanup Audit</name>
  <files>.planning/phases/35-mobile-crash-prevention/35-AUDIT.md</files>
  <action>
Scan ALL files in src/components/ and src/lib/ (excluding .test.ts, .stories.tsx, __tests__/) for cleanup issues.

Search patterns and categorize findings:

1. **Critical (crashes):**
   - setTimeout without clearTimeout in cleanup
   - setInterval without clearInterval in cleanup
   - addEventListener without removeEventListener in cleanup

2. **High (memory leaks):**
   - GSAP animations not using useGSAP (direct gsap.to/from in useEffect)
   - ScrollTrigger without kill() in cleanup
   - IntersectionObserver without disconnect() in cleanup
   - requestAnimationFrame without cancelAnimationFrame in cleanup
   - AudioContext without close() in cleanup

3. **Medium (best practice):**
   - Async operations without isMounted check
   - Modals not using useBodyScrollLock with deferRestore: true
   - Event handlers that could leak (inline functions in addEventListener)

For EACH file with issues, record:
- File path
- Severity (Critical/High/Medium)
- Pattern (e.g., "setTimeout without cleanup")
- Line numbers
- Recommended fix

Structure AUDIT.md:
```markdown
# Phase 35: Cleanup Audit Report

**Audited:** YYYY-MM-DD
**Files scanned:** [count]
**Issues found:** [count]

## Summary

| Severity | Count | Pattern |
|----------|-------|---------|
| Critical | X | setTimeout/setInterval/addEventListener |
| High | X | GSAP/Observer/rAF/AudioContext |
| Medium | X | async/scroll-lock |

## Critical Issues

### setTimeout/setInterval Without Cleanup
| File | Line | Current | Fix |
|------|------|---------|-----|
| ... | ... | ... | ... |

### addEventListener Without Cleanup
| File | Line | Handler | Fix |
|------|------|---------|-----|
| ... | ... | ... | ... |

## High Issues
...

## Medium Issues
...

## Already Compliant
[List files with proper cleanup patterns as examples]
```

Use grep/search commands to find patterns:
- `setTimeout(` followed by no `clearTimeout` in same file
- `addEventListener(` without matching `removeEventListener`
- `gsap.to|from|fromTo` not inside useGSAP
- `new IntersectionObserver` without `disconnect()`
- `requestAnimationFrame` without `cancelAnimationFrame`
- `new AudioContext` without `close()`
  </action>
  <verify>AUDIT.md exists with all sections filled, file count matches actual scanned files, issue count > 0</verify>
  <done>Comprehensive audit report documents all cleanup issues by severity with file paths and line numbers</done>
</task>

<task type="auto">
  <name>Task 2: Create useSafeEffects Utility Hooks</name>
  <files>src/lib/hooks/useSafeEffects.ts, src/lib/hooks/index.ts</files>
  <action>
Create `src/lib/hooks/useSafeEffects.ts` with these hooks (implementation from 35-RESEARCH.md):

1. **useMountedRef()** - Returns ref that tracks mount state
   - Sets ref.current = true on mount
   - Sets ref.current = false on unmount
   - Returns the ref for use in async callbacks

2. **useSafeTimeout()** - Safe setTimeout with auto-cleanup
   - Returns { set, clear } functions
   - set(callback, delay) - schedules timeout, clears any existing
   - clear() - cancels pending timeout
   - Auto-clears on unmount

3. **useSafeInterval()** - Safe setInterval with auto-cleanup
   - Returns { set, clear } functions
   - set(callback, delay) - starts interval, clears any existing
   - clear() - stops interval
   - Auto-clears on unmount

4. **useSafeAsync<T>()** - Safe async operations with AbortController
   - Returns { execute, isMounted }
   - execute(asyncFn) - runs async fn, returns null if unmounted
   - Passes AbortSignal to asyncFn for fetch cancellation
   - Auto-aborts on unmount

Add comprehensive JSDoc comments with:
- Description of what hook does
- @param and @returns documentation
- @example showing usage pattern

Add "use client" directive at top.

Update `src/lib/hooks/index.ts` to export all hooks:
```typescript
export * from "./useSafeEffects";
```
  </action>
  <verify>
`pnpm typecheck` passes
`pnpm lint` passes
File exports all 4 hooks
JSDoc comments present on each hook
  </verify>
  <done>useSafeEffects.ts exports useMountedRef, useSafeTimeout, useSafeInterval, useSafeAsync with full TypeScript types and documentation</done>
</task>

<task type="auto">
  <name>Task 3: Create Cleanup Patterns Documentation</name>
  <files>.claude/CLEANUP-PATTERNS.md</files>
  <action>
Create `.claude/CLEANUP-PATTERNS.md` with comprehensive cleanup pattern guide.

Include these sections:

1. **Introduction** - Why cleanup matters (iOS Safari memory limits, React Strict Mode)

2. **Timer Cleanup** - setTimeout/setInterval patterns
   - Bad: inline setTimeout without cleanup
   - Good: useSafeTimeout hook
   - Good: ref-based cleanup for complex cases

3. **Event Listener Cleanup** - addEventListener patterns
   - Bad: inline function in addEventListener
   - Good: stable callback reference with removeEventListener
   - Good: useCallback with proper deps

4. **GSAP Animation Cleanup** - GSAP/ScrollTrigger patterns
   - Bad: gsap.to() in useEffect
   - Good: useGSAP from @/lib/gsap
   - Good: contextSafe for event handlers

5. **Observer Cleanup** - IntersectionObserver/ResizeObserver
   - Bad: new Observer without disconnect
   - Good: disconnect() in cleanup

6. **Async Operation Cleanup** - fetch/Promise patterns
   - Bad: setState in .then() without mount check
   - Good: useSafeAsync hook
   - Good: AbortController for fetch

7. **Audio Cleanup** - AudioContext patterns
   - Bad: creating new AudioContext per action
   - Good: reuse single context, close on unmount

8. **Modal Scroll Lock** - useBodyScrollLock patterns
   - Bad: basic scroll lock without deferred restore
   - Good: deferRestore: true with onExitComplete

Each section should have:
- Why this matters
- Code example of anti-pattern
- Code example of correct pattern
- Reference to useSafeEffects hook if applicable
  </action>
  <verify>File exists with all 8 sections, code examples are syntactically correct</verify>
  <done>Cleanup patterns documentation provides actionable guidance with code examples for all cleanup scenarios</done>
</task>

</tasks>

<verification>
- AUDIT.md contains categorized findings by severity
- useSafeEffects.ts passes typecheck and lint
- All 4 utility hooks exported from hooks/index.ts
- CLEANUP-PATTERNS.md has examples for each pattern category
</verification>

<success_criteria>
- Complete audit of all components and hooks with severity-categorized findings
- Reusable utility hooks ready for adoption in Plan 02
- Documentation ready as reference for Plan 02 and future development
</success_criteria>

<output>
After completion, create `.planning/phases/35-mobile-crash-prevention/35-01-SUMMARY.md`
</output>
