---
phase: 22-customer-page-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(customer)/checkout/page.tsx
  - src/components/checkout/CheckoutStepperV8.tsx
  - src/components/checkout/AddressStepV8.tsx
  - src/components/checkout/TimeStepV8.tsx
  - src/components/checkout/PaymentStepV8.tsx
  - src/components/ui/error-shake.tsx
autonomous: true

must_haves:
  truths:
    - "Checkout steps slide with glow effect"
    - "Step progress indicator has animated bar fill"
    - "Form fields stagger in sequence within steps"
    - "Validation errors trigger shake + red pulse"
    - "Checkout completion triggers celebration"
  artifacts:
    - path: "src/components/ui/error-shake.tsx"
      provides: "ErrorShake wrapper component"
      exports: ["ErrorShake"]
    - path: "src/components/checkout/CheckoutStepperV8.tsx"
      provides: "Enhanced stepper with glow and draw-in checkmarks"
      contains: "boxShadow"
    - path: "src/app/(customer)/checkout/page.tsx"
      provides: "Enhanced step transitions with scale morph"
      contains: "scale: 0.95"
  key_links:
    - from: "src/app/(customer)/checkout/page.tsx"
      to: "src/lib/motion-tokens.ts"
      via: "step variant import"
      pattern: "spring\\.default"
    - from: "src/components/checkout/AddressStepV8.tsx"
      to: "src/components/ui/error-shake.tsx"
      via: "validation error wrapper"
      pattern: "ErrorShake"
---

<objective>
Transform checkout into a celebratory journey with enhanced step transitions, animated progress, form field stagger, and validation feedback.

Purpose: Each checkout step should feel like an achievement. The flow builds anticipation toward successful order completion.

Output: Checkout with slide+fade+scale+glow transitions, animated stepper, staggered form fields, ErrorShake component, and celebration on completion.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-customer-page-polish/22-CONTEXT.md
@.planning/phases/22-customer-page-polish/22-RESEARCH.md
@src/app/(customer)/checkout/page.tsx
@src/components/checkout/CheckoutStepperV8.tsx
@src/components/checkout/AddressStepV8.tsx
@src/lib/motion-tokens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ErrorShake component for validation feedback</name>
  <files>src/components/ui/error-shake.tsx</files>
  <action>
Create new ErrorShake component:
```tsx
"use client";

import { motion } from "framer-motion";
import { cn } from "@/lib/utils/cn";
import { useAnimationPreference } from "@/lib/hooks/useAnimationPreference";

interface ErrorShakeProps {
  /** Trigger shake animation when true */
  shake: boolean;
  /** Include red pulse overlay */
  pulse?: boolean;
  /** Content to wrap */
  children: React.ReactNode;
  /** Additional classes */
  className?: string;
}

const shakeVariants = {
  idle: { x: 0 },
  shake: {
    x: [0, -8, 8, -6, 6, -4, 4, 0],
    transition: { duration: 0.5, ease: "easeInOut" },
  },
};

const pulseVariants = {
  idle: { opacity: 0 },
  pulse: {
    opacity: [0, 0.15, 0],
    transition: { duration: 0.5 },
  },
};

export function ErrorShake({
  shake,
  pulse = true,
  children,
  className,
}: ErrorShakeProps) {
  const { shouldAnimate } = useAnimationPreference();

  if (!shouldAnimate) {
    return <div className={className}>{children}</div>;
  }

  return (
    <motion.div
      className={cn("relative", className)}
      variants={shakeVariants}
      animate={shake ? "shake" : "idle"}
    >
      {pulse && (
        <motion.div
          className="absolute inset-0 rounded-inherit bg-red-500 pointer-events-none"
          variants={pulseVariants}
          animate={shake ? "pulse" : "idle"}
        />
      )}
      {children}
    </motion.div>
  );
}
```
Export from component index if one exists.
  </action>
  <verify>
`pnpm typecheck` passes
File exists at src/components/ui/error-shake.tsx
  </verify>
  <done>ErrorShake component created with shake + red pulse overlay animation</done>
</task>

<task type="auto">
  <name>Task 2: Enhance checkout step transitions with glow and scale morph</name>
  <files>src/app/(customer)/checkout/page.tsx</files>
  <action>
Update stepVariants to include scale morph and glow per CONTEXT:
```tsx
const stepVariants = {
  initial: (direction: number) => ({
    opacity: 0,
    x: direction > 0 ? 100 : -100,
    scale: 0.95,  // Add scale morph
  }),
  animate: {
    opacity: 1,
    x: 0,
    scale: 1,
    boxShadow: "0 0 30px rgba(164, 16, 52, 0.08)",  // Subtle glow
  },
  exit: (direction: number) => ({
    opacity: 0,
    x: direction > 0 ? -100 : 100,
    scale: 0.95,  // Scale down on exit
    boxShadow: "0 0 0px rgba(164, 16, 52, 0)",
  }),
};
```

Add transition config with spring for scale:
```tsx
transition={{
  x: getSpring(spring.default),
  scale: getSpring(spring.gentle),
  opacity: { duration: 0.2 },
  boxShadow: { duration: 0.3 },
}}
```

Update the checkout card container:
- Add `shadow-colorful` class for premium feel
- Add glassmorphism class if not present
  </action>
  <verify>
Navigate through checkout steps (if logged in with cart items)
- Forward: Step slides from right with scale-up and glow
- Backward: Step slides from left
`pnpm typecheck` passes
  </verify>
  <done>Checkout step transitions have slide + fade + scale morph + glow effect</done>
</task>

<task type="auto">
  <name>Task 3: Enhance CheckoutStepperV8 with animated progress bar and draw-in checkmarks</name>
  <files>src/components/checkout/CheckoutStepperV8.tsx</files>
  <action>
Enhance the stepper:

1. Progress bar glow on active segment:
- Add subtle glow to the green progress line: `boxShadow: "0 0 8px rgba(34, 197, 94, 0.5)"`
- Animate glow intensity with pulse

2. Number morph on step completion:
- When step completes, number morphs to checkmark with scale spring
- Add satisfying bounce (spring.ultraBouncy already used, verify it's working)

3. Draw-in checkmark SVG path:
- Replace static Check icon with animated SVG path
- Use `pathLength` animation: `initial={{ pathLength: 0 }}` -> `animate={{ pathLength: 1 }}`
- Duration ~0.3s with spring easing

4. Glow ring on current step:
- Current step circle has expanding glow ring (already has pulsing ring, enhance it)
- Add subtle gradient to the glow: primary color

5. Label animations:
- Labels fade and slide up when step becomes active
- Use stagger for label appearance
  </action>
  <verify>
View checkout stepper:
- Progress bar has glow
- Checkmarks draw in (not instant appear)
- Current step has prominent glow ring
- Step transitions feel celebratory
`pnpm typecheck` passes
  </verify>
  <done>CheckoutStepperV8 has animated progress bar fill, draw-in checkmarks, and enhanced glow</done>
</task>

<task type="auto">
  <name>Task 4: Add form field stagger to checkout step components</name>
  <files>
    src/components/checkout/AddressStepV8.tsx
    src/components/checkout/TimeStepV8.tsx
    src/components/checkout/PaymentStepV8.tsx
  </files>
  <action>
For each step component (AddressStepV8, TimeStepV8, PaymentStepV8):

1. Wrap form fields in motion.div with stagger container:
```tsx
<motion.div
  variants={staggerContainer(0.08, 0.1)}
  initial="hidden"
  animate="visible"
>
```

2. Each form field/input group gets stagger item variant:
```tsx
<motion.div variants={staggerItem}>
  <Label>...</Label>
  <Input>...</Input>
</motion.div>
```

3. Wrap validation error messages in ErrorShake:
```tsx
<ErrorShake shake={!!errors.field}>
  <Input ... />
  {errors.field && <p className="text-red-500">...</p>}
</ErrorShake>
```

4. Add bold BrandedSpinner for loading states:
- Replace any Loader2 with BrandedSpinner size="lg"
- Import from @/components/ui/branded-spinner

5. Button at bottom should scale in (buttonEntry variant):
```tsx
const buttonEntry = {
  hidden: { opacity: 0, scale: 0.8 },
  visible: { opacity: 1, scale: 1, transition: spring.snappy }
};
```
  </action>
  <verify>
Navigate to each checkout step:
- Form fields stagger in sequence (not all at once)
- Submit with empty required field - field shakes
- Loading states show BrandedSpinner
`pnpm typecheck` passes
  </verify>
  <done>Checkout form fields stagger in sequence, validation errors trigger ErrorShake</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` passes
3. Checkout flow at /checkout shows:
   - Steps slide with scale morph and glow
   - Progress bar animates with glow
   - Checkmarks draw in (not instant)
   - Form fields stagger within each step
   - Validation errors shake the field
   - Loading states use BrandedSpinner
4. Reverse navigation (back button) slides from opposite direction
</verification>

<success_criteria>
- Step transitions have slide + fade + scale + glow effect
- Stepper progress bar glows and fills with spring
- Checkmarks animate drawing in
- Form fields within steps stagger in sequence
- Validation errors trigger shake + red pulse
- BrandedSpinner used for loading states
</success_criteria>

<output>
After completion, create `.planning/phases/22-customer-page-polish/22-02-SUMMARY.md`
</output>
